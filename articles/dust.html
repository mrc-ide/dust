<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to dust • dust</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to dust">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dust</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.15.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dust.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/design.html">Principles and design of dust</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Random numbers</li>
    <li>
      <a href="../articles/rng.html">Random number generation</a>
    </li>
    <li>
      <a href="../articles/rng_algorithms.html">Algorithms used to compute random numbers</a>
    </li>
    <li>
      <a href="../articles/rng_package.html">Using RNGs from packages</a>
    </li>
    <li>
      <a href="../articles/rng_distributed.html">Distributed parallel random numbers</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Dive deeper</li>
    <li>
      <a href="../articles/data.html">Comparing models and data</a>
    </li>
    <li>
      <a href="../articles/gpu.html">Running models on GPUs with CUDA</a>
    </li>
    <li>
      <a href="../articles/multi.html">Multiple parameter sets</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/dust/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to dust</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/dust/blob/master/vignettes/dust.Rmd" class="external-link"><code>vignettes/dust.Rmd</code></a></small>
      <div class="hidden name"><code>dust.Rmd</code></div>

    </div>

    
    
<p>Stochastic models can be used in statistical inference via methods
such as <a href="https://en.wikipedia.org/wiki/Particle_filter" class="external-link">particle
filtering</a> but in practice doing so requires that the models can be
run over and over again very quickly. While R has excellent support for
sampling from distributions, it is not necessarily well suited for this
sort of problem because R is single threaded, so we are forced to
evaluate realisations of the stochastic process in series (one after
another) rather than in parallel.</p>
<p>The <code>dust</code> package provides tools to help write stochastic
models that can be evaluated in parallel. It does not directly provide
statistical methods; see the <a href="https://mrc-ide.github.io/mcstate/" class="external-link">mcstate</a> package for that.
Instead, it focuses on providing:</p>
<ul>
<li>a fast random number generator that can be evaluated in parallel
(see <code><a href="../articles/rng.html">vignette("rng")</a></code> for details)</li>
<li>a way of wrapping a user-provided model, itself written as a C++
class</li>
<li>a lightweight interface that drives this model from R</li>
<li>a set of useful primitives for developing sequential Monte Carlo
methods.</li>
</ul>
<div class="section level2">
<h2 id="a-simple-example---random-walk">A simple example - random walk<a class="anchor" aria-label="anchor" href="#a-simple-example---random-walk"></a>
</h2>
<p>Consider a unbiased random walk; at each time step we move our
position with a draw from a normal distribution with mean 0 and some
standard deviation. We consider a single individual moving but will
eventually simulate a family of these individuals, each independent. All
simulations have a sense of time - a unitless measure of time “step”
will be used but it’s up to you how it is interpreted (time is a
non-negative integer, implemented using <code>size_t</code>).</p>
<div class="section level3">
<h3 id="model-code">Model code<a class="anchor" aria-label="anchor" href="#model-code"></a>
</h3>
<p>To implement this model in dust we write out a C++ file that looks
like:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="kw">class</span> walk <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">data_type</span> <span class="op">=</span> dust<span class="op">::</span>no_data<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">internal_type</span> <span class="op">=</span> dust<span class="op">::</span>no_internal<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">shared_type</span> <span class="op">{</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>    <span class="dt">real_type</span> sd<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>    <span class="dt">bool</span> random_initial<span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>  walk<span class="op">(</span><span class="at">const</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>walk<span class="op">&gt;&amp;</span> pars<span class="op">)</span> <span class="op">:</span> shared<span class="op">(</span>pars<span class="op">.</span>shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  <span class="dt">size_t</span> size<span class="op">()</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> initial<span class="op">(</span><span class="dt">size_t</span> time<span class="op">,</span> <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> ret <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>shared<span class="op">-&gt;</span>random_initial<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>      ret<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>normal<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> shared<span class="op">-&gt;</span>sd<span class="op">);</span></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>    <span class="cf">return</span> ret<span class="op">;</span></span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a>  <span class="dt">void</span> update<span class="op">(</span><span class="dt">size_t</span> time<span class="op">,</span> <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span> <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a>              <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span></span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a>      dust<span class="op">::</span>random<span class="op">::</span>normal<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> shared<span class="op">-&gt;</span>sd<span class="op">);</span></span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a>  dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>walk<span class="op">&gt;</span> shared<span class="op">;</span></span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a><span class="kw">namespace</span> dust <span class="op">{</span></span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a>dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>walk<span class="op">&gt;</span> dust_pars<span class="op">&lt;</span>walk<span class="op">&gt;(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a>  walk<span class="op">::</span><span class="dt">real_type</span> sd <span class="op">=</span> cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span>walk<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;(</span>pars<span class="op">[</span><span class="st">"sd"</span><span class="op">]);</span></span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">bool</span> random_initial <span class="op">=</span> pars<span class="op">[</span><span class="st">"random_initial"</span><span class="op">]</span> <span class="op">==</span> R_NilValue <span class="op">?</span> <span class="kw">false</span> <span class="op">:</span></span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a>    cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;(</span>pars<span class="op">[</span><span class="st">"random_initial"</span><span class="op">]);</span></span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>walk<span class="op">&gt;(</span>walk<span class="op">::</span><span class="dt">shared_type</span><span class="op">{</span>sd<span class="op">,</span> random_initial<span class="op">});</span></span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>There are two main parts here; the class (<code>walk</code>) and an
interface function (<code>dust::dust_pars</code>).</p>
<p>The class is what does most of the work. It is important that this
does not use anything in the R API as it may be called in parallel.
Therefore use only C++ standard library types. It has to provide every
public type or method as the example above. First, the five types:</p>
<ul>
<li>the type <code>real_type</code> has to exist and indicate what sort
of numeric type you use for “real numbers”. Typically this will be
<code>double</code>, but if you need a different type (typically
<code>float</code>) you can use it here.</li>
<li>the type <code>data_type</code> describes data that the model may be
compared with as it runs. Here we use <code>dust::no_data</code> as the
model has no such data but see <code><a href="../articles/data.html">vignette("data")</a></code> for the
interface here.</li>
<li>the type <code>shared_type</code> is whatever read-only data your
model needs that is shared across particles. Typically these reflect
<em>parameters</em> of the model (see <code>dust::dust_pars</code>
below), and while these will typically be shared across all particles
that is is not always the case (see <code><a href="../articles/multi.html">vignette("multi")</a></code>)</li>
<li>the type <code>internal_type</code> is whatever internal data or
space your model needs to run. This is read-write and per-particle (in
contrast with <code>shared_type</code> above)</li>
<li>the type <code>rng_state_type</code> is one of the valid RNG types.
Typically
<code>using rng_state_type = dust::random::generator&lt;real_type&gt;;</code>
will select a reasonable choice, but you could also force a specific
generator such as <code>dust::random::xoshiro256starstar</code> here
(see <code><a href="../articles/rng.html">vignette("rng")</a></code>)</li>
</ul>
<p><strong>The constructor</strong> must take only one argument, being
<code>const dust::pars_type&lt;model&gt;&amp;</code>. You can do what
you want in the constructor - here we just copy <code>shared</code>
(containing parameters) into the object with the <code>pars</code>
argument (we use the private member <code>shared</code> here but this
can be anything you want, though the type is important). The
<code>dust::pars_type&lt;&gt;</code> template is a wrapper that contains
two fields <code>shared</code> (as
<code>dust::shared_ptr&lt;walk&gt;</code>) and <code>internal</code> (as
<code>internal_type</code>).</p>
<p><strong>The method <code>size()</code></strong> must return the
“size” of the system - how many state variables it has. Here we’re
considering a single individual moving randomly so the size is always 1.
Many models will have a size that depends on their parameters, though
the size cannot be changed after construction.</p>
<p>There are other forms of the <code>dust::pars_type</code> constructor
which would allow specifying the internal data; typically this is used
to create scratch space (allocating vectors as needed) rather than
compute values because the scratch space and model state can become
separated from each other (by direct setting of state, or by shuffling
model state between particles).</p>
</div>
<div class="section level3">
<h3 id="constructing-a-model">Constructing a model<a class="anchor" aria-label="anchor" href="#constructing-a-model"></a>
</h3>
<p>The function <code><a href="../reference/dust.html">dust::dust</a></code> will “compile” a model for us to
use:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path_walk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/walk.cpp"</span>, package <span class="op">=</span> <span class="st">"dust"</span><span class="op">)</span></span>
<span><span class="va">walk</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="../reference/dust.html">dust</a></span><span class="op">(</span><span class="va">path_walk</span><span class="op">)</span></span></code></pre></div>
<p>However, this is also bundled into the package and can be loaded
with:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">walk</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="../reference/dust_example.html">dust_example</a></span><span class="op">(</span><span class="st">"walk"</span><span class="op">)</span></span></code></pre></div>
<p>The object itself is an “R6ClassGenerator” object:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">walk</span></span>
<span><span class="co">#&gt; &lt;dust&gt; object generator</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     initialize: function (pars, time, n_particles, n_threads = 1L, seed = NULL, </span></span>
<span><span class="co">#&gt;     name: function () </span></span>
<span><span class="co">#&gt;     param: function () </span></span>
<span><span class="co">#&gt;     run: function (time_end) </span></span>
<span><span class="co">#&gt;     simulate: function (time_end) </span></span>
<span><span class="co">#&gt;     run_adjoint: function () </span></span>
<span><span class="co">#&gt;     set_index: function (index) </span></span>
<span><span class="co">#&gt;     index: function () </span></span>
<span><span class="co">#&gt;     ode_control: function () </span></span>
<span><span class="co">#&gt;     ode_statistics: function () </span></span>
<span><span class="co">#&gt;     n_threads: function () </span></span>
<span><span class="co">#&gt;     n_state: function () </span></span>
<span><span class="co">#&gt;     n_particles: function () </span></span>
<span><span class="co">#&gt;     n_particles_each: function () </span></span>
<span><span class="co">#&gt;     shape: function () </span></span>
<span><span class="co">#&gt;     update_state: function (pars = NULL, state = NULL, time = NULL, set_initial_state = NULL, </span></span>
<span><span class="co">#&gt;     state: function (index = NULL) </span></span>
<span><span class="co">#&gt;     time: function () </span></span>
<span><span class="co">#&gt;     set_stochastic_schedule: function (time) </span></span>
<span><span class="co">#&gt;     reorder: function (index) </span></span>
<span><span class="co">#&gt;     resample: function (weights) </span></span>
<span><span class="co">#&gt;     info: function () </span></span>
<span><span class="co">#&gt;     pars: function () </span></span>
<span><span class="co">#&gt;     rng_state: function (first_only = FALSE, last_only = FALSE) </span></span>
<span><span class="co">#&gt;     set_rng_state: function (rng_state) </span></span>
<span><span class="co">#&gt;     has_openmp: function () </span></span>
<span><span class="co">#&gt;     has_gpu_support: function (fake_gpu = FALSE) </span></span>
<span><span class="co">#&gt;     has_compare: function () </span></span>
<span><span class="co">#&gt;     real_size: function () </span></span>
<span><span class="co">#&gt;     time_type: function () </span></span>
<span><span class="co">#&gt;     rng_algorithm: function () </span></span>
<span><span class="co">#&gt;     uses_gpu: function (fake_gpu = FALSE) </span></span>
<span><span class="co">#&gt;     n_pars: function () </span></span>
<span><span class="co">#&gt;     set_n_threads: function (n_threads) </span></span>
<span><span class="co">#&gt;     set_data: function (data, shared = FALSE) </span></span>
<span><span class="co">#&gt;     compare_data: function () </span></span>
<span><span class="co">#&gt;     filter: function (time_end = NULL, save_trajectories = FALSE, time_snapshot = NULL, </span></span>
<span><span class="co">#&gt;     gpu_info: function () </span></span>
<span><span class="co">#&gt;   Private:</span></span>
<span><span class="co">#&gt;     pars_: NULL</span></span>
<span><span class="co">#&gt;     pars_multi_: NULL</span></span>
<span><span class="co">#&gt;     index_: NULL</span></span>
<span><span class="co">#&gt;     info_: NULL</span></span>
<span><span class="co">#&gt;     n_threads_: NULL</span></span>
<span><span class="co">#&gt;     n_particles_: NULL</span></span>
<span><span class="co">#&gt;     n_particles_each_: NULL</span></span>
<span><span class="co">#&gt;     shape_: NULL</span></span>
<span><span class="co">#&gt;     ptr_: NULL</span></span>
<span><span class="co">#&gt;     gpu_config_: NULL</span></span>
<span><span class="co">#&gt;     ode_control_: NULL</span></span>
<span><span class="co">#&gt;     methods_: NULL</span></span>
<span><span class="co">#&gt;     param_: NULL</span></span>
<span><span class="co">#&gt;     reload_: NULL</span></span>
<span><span class="co">#&gt;   Parent env: &lt;environment: namespace:dust&gt;</span></span>
<span><span class="co">#&gt;   Locked objects: TRUE</span></span>
<span><span class="co">#&gt;   Locked class: FALSE</span></span>
<span><span class="co">#&gt;   Portable: TRUE</span></span></code></pre></div>
<p>Create an instance of the model using <code>walk$new</code>. There
are three required arguments:</p>
<ul>
<li>
<code>pars</code>: passed to <code>dust_pars</code> to initialise
the model</li>
<li>
<code>time</code>: the initial time (0 seems like a sensible choice
here given our model has no internal sense of time)</li>
<li>
<code>n_particles</code>: the number of particles to create</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">walk</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">model</span></span>
<span><span class="co">#&gt; &lt;dust&gt;</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     compare_data: function () </span></span>
<span><span class="co">#&gt;     filter: function (time_end = NULL, save_trajectories = FALSE, time_snapshot = NULL, </span></span>
<span><span class="co">#&gt;     gpu_info: function () </span></span>
<span><span class="co">#&gt;     has_compare: function () </span></span>
<span><span class="co">#&gt;     has_gpu_support: function (fake_gpu = FALSE) </span></span>
<span><span class="co">#&gt;     has_openmp: function () </span></span>
<span><span class="co">#&gt;     index: function () </span></span>
<span><span class="co">#&gt;     info: function () </span></span>
<span><span class="co">#&gt;     initialize: function (pars, time, n_particles, n_threads = 1L, seed = NULL, </span></span>
<span><span class="co">#&gt;     n_pars: function () </span></span>
<span><span class="co">#&gt;     n_particles: function () </span></span>
<span><span class="co">#&gt;     n_particles_each: function () </span></span>
<span><span class="co">#&gt;     n_state: function () </span></span>
<span><span class="co">#&gt;     n_threads: function () </span></span>
<span><span class="co">#&gt;     name: function () </span></span>
<span><span class="co">#&gt;     ode_control: function () </span></span>
<span><span class="co">#&gt;     ode_statistics: function () </span></span>
<span><span class="co">#&gt;     param: function () </span></span>
<span><span class="co">#&gt;     pars: function () </span></span>
<span><span class="co">#&gt;     real_size: function () </span></span>
<span><span class="co">#&gt;     reorder: function (index) </span></span>
<span><span class="co">#&gt;     resample: function (weights) </span></span>
<span><span class="co">#&gt;     rng_algorithm: function () </span></span>
<span><span class="co">#&gt;     rng_state: function (first_only = FALSE, last_only = FALSE) </span></span>
<span><span class="co">#&gt;     run: function (time_end) </span></span>
<span><span class="co">#&gt;     run_adjoint: function () </span></span>
<span><span class="co">#&gt;     set_data: function (data, shared = FALSE) </span></span>
<span><span class="co">#&gt;     set_index: function (index) </span></span>
<span><span class="co">#&gt;     set_n_threads: function (n_threads) </span></span>
<span><span class="co">#&gt;     set_rng_state: function (rng_state) </span></span>
<span><span class="co">#&gt;     set_stochastic_schedule: function (time) </span></span>
<span><span class="co">#&gt;     shape: function () </span></span>
<span><span class="co">#&gt;     simulate: function (time_end) </span></span>
<span><span class="co">#&gt;     state: function (index = NULL) </span></span>
<span><span class="co">#&gt;     time: function () </span></span>
<span><span class="co">#&gt;     time_type: function () </span></span>
<span><span class="co">#&gt;     update_state: function (pars = NULL, state = NULL, time = NULL, set_initial_state = NULL, </span></span>
<span><span class="co">#&gt;     uses_gpu: function (fake_gpu = FALSE) </span></span>
<span><span class="co">#&gt;   Private:</span></span>
<span><span class="co">#&gt;     gpu_config_: NULL</span></span>
<span><span class="co">#&gt;     index_: NULL</span></span>
<span><span class="co">#&gt;     info_: NULL</span></span>
<span><span class="co">#&gt;     methods_: list</span></span>
<span><span class="co">#&gt;     n_particles_: 20</span></span>
<span><span class="co">#&gt;     n_particles_each_: 20</span></span>
<span><span class="co">#&gt;     n_threads_: 1</span></span>
<span><span class="co">#&gt;     ode_control_: NULL</span></span>
<span><span class="co">#&gt;     param_: NULL</span></span>
<span><span class="co">#&gt;     pars_: list</span></span>
<span><span class="co">#&gt;     pars_multi_: FALSE</span></span>
<span><span class="co">#&gt;     ptr_: externalptr</span></span>
<span><span class="co">#&gt;     reload_: NULL</span></span>
<span><span class="co">#&gt;     shape_: 20</span></span></code></pre></div>
<p>This returns an R6 object that can be used to simulate from or
interact with the model. For example, our initial model state is</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt;      [,15] [,16] [,17] [,18] [,19] [,20]</span></span>
<span><span class="co">#&gt; [1,]     0     0     0     0     0     0</span></span></code></pre></div>
<p>Here there is one row per model state variable (there is only one
here) and one column per particle (there are 20)</p>
<p>and we can run the model for 100 time steps, which returns the state
at the end of the walk (and not at any intermediate times):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt;          [,1]     [,2]    [,3]       [,4]     [,5]     [,6]      [,7]      [,8]</span></span>
<span><span class="co">#&gt; [1,] 1.562305 7.288367 5.84155 0.08509074 -7.07042 10.60426 -2.057119 -9.614804</span></span>
<span><span class="co">#&gt;           [,9]   [,10]    [,11]    [,12]     [,13]     [,14]    [,15]    [,16]</span></span>
<span><span class="co">#&gt; [1,] -8.294164 9.07455 19.80548 1.293768 -13.24191 -1.231157 8.591563 5.342956</span></span>
<span><span class="co">#&gt;          [,17]     [,18]    [,19]   [,20]</span></span>
<span><span class="co">#&gt; [1,] -9.857717 -8.946853 18.32985 7.39139</span></span></code></pre></div>
<p>We can also directly retrieve the state from our object</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;          [,1]     [,2]    [,3]       [,4]     [,5]     [,6]      [,7]      [,8]</span></span>
<span><span class="co">#&gt; [1,] 1.562305 7.288367 5.84155 0.08509074 -7.07042 10.60426 -2.057119 -9.614804</span></span>
<span><span class="co">#&gt;           [,9]   [,10]    [,11]    [,12]     [,13]     [,14]    [,15]    [,16]</span></span>
<span><span class="co">#&gt; [1,] -8.294164 9.07455 19.80548 1.293768 -13.24191 -1.231157 8.591563 5.342956</span></span>
<span><span class="co">#&gt;          [,17]     [,18]    [,19]   [,20]</span></span>
<span><span class="co">#&gt; [1,] -9.857717 -8.946853 18.32985 7.39139</span></span></code></pre></div>
<p>At this point our particles have been run for 100 time steps with
standard deviation 1 at each step so they <a href="https://en.wikipedia.org/wiki/Random_walk#Gaussian_random_walk" class="external-link">will
be distributed following Normal(0, 10)</a>. This is easier to see if we
simulate a lot of particles, here 20,000:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">walk</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">20000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, las <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"steelblue2"</span>, main <span class="op">=</span> <span class="st">""</span>,</span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.</span>, <span class="fl">0.04</span><span class="op">)</span>, xlab <span class="op">=</span> <span class="st">"State"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"orange"</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="dust_files/figure-html/walk_simulate_many-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="running-a-model-in-parallel">Running a model in parallel<a class="anchor" aria-label="anchor" href="#running-a-model-in-parallel"></a>
</h3>
<p>The approach above still runs everything in serial, one particle
after another. We can configure this system to run in parallel by
providing the extra argument <code>n_threads</code> to the
constructor.</p>
<p>Provided that your system can compile with openmp the following code
will execute in parallel using 2 threads</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">walk</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">20</span>, n_threads <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]     [,2]     [,3]       [,4]     [,5]     [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] -2.746012 9.349137 2.845653 -0.4137361 10.94929 1.134218 -1.739739</span></span>
<span><span class="co">#&gt;          [,8]      [,9]     [,10]     [,11]    [,12]     [,13]     [,14]</span></span>
<span><span class="co">#&gt; [1,] 20.00793 -1.270901 -33.45582 -0.242807 19.33025 -2.876218 -10.63793</span></span>
<span><span class="co">#&gt;         [,15]    [,16]     [,17]    [,18]    [,19]     [,20]</span></span>
<span><span class="co">#&gt; [1,] 1.340985 -1.82075 -9.159877 1.239593 2.730351 -10.55075</span></span></code></pre></div>
<p>Running this same code in series will give the same results:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">walk</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">20</span>, n_threads <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]     [,2]      [,3]      [,4]     [,5]     [,6]    [,7]     [,8]</span></span>
<span><span class="co">#&gt; [1,] -16.47891 6.388069 -2.852034 -6.039058 7.573581 1.939201 -15.871 -5.08495</span></span>
<span><span class="co">#&gt;           [,9]     [,10]     [,11]    [,12]    [,13]      [,14]   [,15]   [,16]</span></span>
<span><span class="co">#&gt; [1,] -12.97332 -17.91718 -5.339374 15.57415 14.11479 -0.8274314 5.83841 10.0005</span></span>
<span><span class="co">#&gt;         [,17]    [,18]    [,19]    [,20]</span></span>
<span><span class="co">#&gt; [1,] 1.172349 19.51808 3.247002 6.840864</span></span></code></pre></div>
<p>We use as many random number generators as there are particles, so if
you run fewer particles or more, increase the threads or decrease, the
results will be the same (see <code><a href="../articles/design.html">vignette("design")</a></code> for more
on this).</p>
<p>You should be careful when selecting the number of threads.
<code>dust</code> will never use more than one thread at a time without
it being requested, but avoid using <code><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">parallel::detectCores()</a></code>
to work out how many threads you have available as it will often return
an overestimate. This is particularly the case in a shared-use system
such as a cluster or CRAN’s servers. We provide a helper function
<code><a href="../reference/dust_openmp_threads.html">dust::dust_openmp_threads</a></code> which can be used to try and find
a safe number of threads available to you while respecting various
environment variables which seek to control this (<code>MC_CORES</code>,
<code>OMP_THREAD_LIMIT</code>, etc).</p>
<p>For example,</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="../reference/dust_openmp_threads.html">dust_openmp_threads</a></span><span class="op">(</span><span class="fl">100</span>, <span class="st">"fix"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Requested number of threads '100' exceeds a limit of '1'</span></span>
<span><span class="co">#&gt;  See dust::dust_openmp_threads() for details</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="a-more-interesting-example">A more interesting example<a class="anchor" aria-label="anchor" href="#a-more-interesting-example"></a>
</h2>
<p>Consider now an SIR model (Susceptible - Infected - Recovered). This
sort of model is common in epidemiology, and is often extended to add
additional compartments (e.g., SEIR which adds an Exposed compartment)
or by structuring each compartment based on properties such as age.
Here, we show a simple example with just 3 compartments:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">class</span> sir <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">internal_type</span> <span class="op">=</span> dust<span class="op">::</span>no_internal<span class="op">;</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>  </span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">data_type</span> <span class="op">{</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="dt">real_type</span> incidence<span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">shared_type</span> <span class="op">{</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>    <span class="dt">real_type</span> S0<span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>    <span class="dt">real_type</span> I0<span class="op">;</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>    <span class="dt">real_type</span> R0<span class="op">;</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>    <span class="dt">real_type</span> beta<span class="op">;</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>    <span class="dt">real_type</span> gamma<span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>    <span class="dt">real_type</span> dt<span class="op">;</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>    <span class="dt">size_t</span> freq<span class="op">;</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>    <span class="co">// Observation parameters</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>    <span class="dt">real_type</span> exp_noise<span class="op">;</span></span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>  sir<span class="op">(</span><span class="at">const</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>sir<span class="op">&gt;&amp;</span> pars<span class="op">)</span> <span class="op">:</span> shared<span class="op">(</span>pars<span class="op">.</span>shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>  <span class="dt">size_t</span> size<span class="op">()</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> initial<span class="op">(</span><span class="dt">size_t</span> time<span class="op">,</span> <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-31"><a href="#cb13-31" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> ret <span class="op">=</span> <span class="op">{</span>shared<span class="op">-&gt;</span>S0<span class="op">,</span> shared<span class="op">-&gt;</span>I0<span class="op">,</span> shared<span class="op">-&gt;</span>R0<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span></span>
<span id="cb13-32"><a href="#cb13-32" tabindex="-1"></a>    <span class="cf">return</span> ret<span class="op">;</span></span>
<span id="cb13-33"><a href="#cb13-33" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-34"><a href="#cb13-34" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" tabindex="-1"></a>  <span class="dt">void</span> update<span class="op">(</span><span class="dt">size_t</span> time<span class="op">,</span> <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span> <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb13-36"><a href="#cb13-36" tabindex="-1"></a>              <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-37"><a href="#cb13-37" tabindex="-1"></a>    <span class="dt">real_type</span> S <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb13-38"><a href="#cb13-38" tabindex="-1"></a>    <span class="dt">real_type</span> I <span class="op">=</span> state<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb13-39"><a href="#cb13-39" tabindex="-1"></a>    <span class="dt">real_type</span> R <span class="op">=</span> state<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb13-40"><a href="#cb13-40" tabindex="-1"></a>    <span class="dt">real_type</span> cumulative_incidence <span class="op">=</span> state<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb13-41"><a href="#cb13-41" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" tabindex="-1"></a>    <span class="dt">real_type</span> N <span class="op">=</span> S <span class="op">+</span> I <span class="op">+</span> R<span class="op">;</span></span>
<span id="cb13-43"><a href="#cb13-43" tabindex="-1"></a></span>
<span id="cb13-44"><a href="#cb13-44" tabindex="-1"></a>    <span class="dt">real_type</span> p_SI <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-(</span>shared<span class="op">-&gt;</span>beta<span class="op">)</span> <span class="op">*</span> I <span class="op">/</span> N<span class="op">);</span></span>
<span id="cb13-45"><a href="#cb13-45" tabindex="-1"></a>    <span class="dt">real_type</span> p_IR <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> <span class="bu">std::</span>exp<span class="op">(-(</span>shared<span class="op">-&gt;</span>gamma<span class="op">));</span></span>
<span id="cb13-46"><a href="#cb13-46" tabindex="-1"></a>    <span class="dt">real_type</span> n_IR <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> I<span class="op">,</span></span>
<span id="cb13-47"><a href="#cb13-47" tabindex="-1"></a>                                                       p_IR <span class="op">*</span> shared<span class="op">-&gt;</span>dt<span class="op">);</span></span>
<span id="cb13-48"><a href="#cb13-48" tabindex="-1"></a>    <span class="dt">real_type</span> n_SI <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> S<span class="op">,</span></span>
<span id="cb13-49"><a href="#cb13-49" tabindex="-1"></a>                                                       p_SI <span class="op">*</span> shared<span class="op">-&gt;</span>dt<span class="op">);</span></span>
<span id="cb13-50"><a href="#cb13-50" tabindex="-1"></a></span>
<span id="cb13-51"><a href="#cb13-51" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> S <span class="op">-</span> n_SI<span class="op">;</span></span>
<span id="cb13-52"><a href="#cb13-52" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> I <span class="op">+</span> n_SI <span class="op">-</span> n_IR<span class="op">;</span></span>
<span id="cb13-53"><a href="#cb13-53" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> R <span class="op">+</span> n_IR<span class="op">;</span></span>
<span id="cb13-54"><a href="#cb13-54" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> cumulative_incidence <span class="op">+</span> n_SI<span class="op">;</span></span>
<span id="cb13-55"><a href="#cb13-55" tabindex="-1"></a>    <span class="co">// Little trick here to compute daily incidence by accumulating</span></span>
<span id="cb13-56"><a href="#cb13-56" tabindex="-1"></a>    <span class="co">// incidence from the first day.</span></span>
<span id="cb13-57"><a href="#cb13-57" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span>time <span class="op">%</span> shared<span class="op">-&gt;</span>freq <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> n_SI <span class="op">:</span> state<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">+</span> n_SI<span class="op">;</span></span>
<span id="cb13-58"><a href="#cb13-58" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-59"><a href="#cb13-59" tabindex="-1"></a></span>
<span id="cb13-60"><a href="#cb13-60" tabindex="-1"></a>  <span class="dt">real_type</span> compare_data<span class="op">(</span><span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span> <span class="at">const</span> <span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb13-61"><a href="#cb13-61" tabindex="-1"></a>                         <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-62"><a href="#cb13-62" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> incidence_observed <span class="op">=</span> data<span class="op">.</span>incidence<span class="op">;</span></span>
<span id="cb13-63"><a href="#cb13-63" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="bu">std::</span>isnan<span class="op">(</span>data<span class="op">.</span>incidence<span class="op">))</span> <span class="op">{</span></span>
<span id="cb13-64"><a href="#cb13-64" tabindex="-1"></a>      <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-65"><a href="#cb13-65" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-66"><a href="#cb13-66" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> incidence_modelled <span class="op">=</span> state<span class="op">[</span><span class="dv">4</span><span class="op">];</span></span>
<span id="cb13-67"><a href="#cb13-67" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> lambda <span class="op">=</span> incidence_modelled <span class="op">+</span></span>
<span id="cb13-68"><a href="#cb13-68" tabindex="-1"></a>      dust<span class="op">::</span>random<span class="op">::</span>exponential<span class="op">(</span>rng_state<span class="op">,</span> shared<span class="op">-&gt;</span>exp_noise<span class="op">);</span></span>
<span id="cb13-69"><a href="#cb13-69" tabindex="-1"></a>    <span class="cf">return</span> dust<span class="op">::</span>density<span class="op">::</span>poisson<span class="op">(</span>incidence_observed<span class="op">,</span> lambda<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb13-70"><a href="#cb13-70" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-71"><a href="#cb13-71" tabindex="-1"></a></span>
<span id="cb13-72"><a href="#cb13-72" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb13-73"><a href="#cb13-73" tabindex="-1"></a>  dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>sir<span class="op">&gt;</span> shared<span class="op">;</span></span>
<span id="cb13-74"><a href="#cb13-74" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb13-75"><a href="#cb13-75" tabindex="-1"></a></span>
<span id="cb13-76"><a href="#cb13-76" tabindex="-1"></a><span class="co">// Helper function for accepting values with defaults</span></span>
<span id="cb13-77"><a href="#cb13-77" tabindex="-1"></a><span class="kw">inline</span> <span class="dt">double</span> with_default<span class="op">(</span><span class="dt">double</span> default_value<span class="op">,</span> cpp11<span class="op">::</span>sexp value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-78"><a href="#cb13-78" tabindex="-1"></a>  <span class="cf">return</span> value <span class="op">==</span> R_NilValue <span class="op">?</span> default_value <span class="op">:</span> cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>value<span class="op">);</span></span>
<span id="cb13-79"><a href="#cb13-79" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-80"><a href="#cb13-80" tabindex="-1"></a></span>
<span id="cb13-81"><a href="#cb13-81" tabindex="-1"></a><span class="kw">namespace</span> dust <span class="op">{</span></span>
<span id="cb13-82"><a href="#cb13-82" tabindex="-1"></a></span>
<span id="cb13-83"><a href="#cb13-83" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb13-84"><a href="#cb13-84" tabindex="-1"></a>dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>sir<span class="op">&gt;</span> dust_pars<span class="op">&lt;</span>sir<span class="op">&gt;(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-85"><a href="#cb13-85" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> sir<span class="op">::</span><span class="dt">real_type</span><span class="op">;</span></span>
<span id="cb13-86"><a href="#cb13-86" tabindex="-1"></a>  <span class="co">// Initial state values</span></span>
<span id="cb13-87"><a href="#cb13-87" tabindex="-1"></a>  <span class="co">// [[dust::param(I0, required = FALSE)]]</span></span>
<span id="cb13-88"><a href="#cb13-88" tabindex="-1"></a>  <span class="dt">real_type</span> I0 <span class="op">=</span> with_default<span class="op">(</span><span class="dv">10</span><span class="op">,</span> pars<span class="op">[</span><span class="st">"I0"</span><span class="op">]);</span></span>
<span id="cb13-89"><a href="#cb13-89" tabindex="-1"></a>  <span class="dt">real_type</span> S0 <span class="op">=</span> <span class="fl">1000.0</span><span class="op">;</span></span>
<span id="cb13-90"><a href="#cb13-90" tabindex="-1"></a>  <span class="dt">real_type</span> R0 <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb13-91"><a href="#cb13-91" tabindex="-1"></a></span>
<span id="cb13-92"><a href="#cb13-92" tabindex="-1"></a>  <span class="co">// Rates, which can be set based on the provided pars</span></span>
<span id="cb13-93"><a href="#cb13-93" tabindex="-1"></a>  <span class="co">// [[dust::param(beta, required = FALSE)]]</span></span>
<span id="cb13-94"><a href="#cb13-94" tabindex="-1"></a>  <span class="dt">real_type</span> beta <span class="op">=</span> with_default<span class="op">(</span><span class="fl">0.2</span><span class="op">,</span> pars<span class="op">[</span><span class="st">"beta"</span><span class="op">]);</span></span>
<span id="cb13-95"><a href="#cb13-95" tabindex="-1"></a>  <span class="co">// [[dust::param(gamma, required = FALSE)]]</span></span>
<span id="cb13-96"><a href="#cb13-96" tabindex="-1"></a>  <span class="dt">real_type</span> gamma <span class="op">=</span> with_default<span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> pars<span class="op">[</span><span class="st">"gamma"</span><span class="op">]);</span></span>
<span id="cb13-97"><a href="#cb13-97" tabindex="-1"></a></span>
<span id="cb13-98"><a href="#cb13-98" tabindex="-1"></a>  <span class="co">// Time scaling</span></span>
<span id="cb13-99"><a href="#cb13-99" tabindex="-1"></a>  <span class="dt">size_t</span> freq <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb13-100"><a href="#cb13-100" tabindex="-1"></a>  <span class="dt">real_type</span> dt <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>freq<span class="op">);</span></span>
<span id="cb13-101"><a href="#cb13-101" tabindex="-1"></a></span>
<span id="cb13-102"><a href="#cb13-102" tabindex="-1"></a>  <span class="co">// Compare function</span></span>
<span id="cb13-103"><a href="#cb13-103" tabindex="-1"></a>  <span class="co">// [[dust::param(exp_noise, required = FALSE)]]</span></span>
<span id="cb13-104"><a href="#cb13-104" tabindex="-1"></a>  <span class="dt">real_type</span> exp_noise <span class="op">=</span> with_default<span class="op">(</span><span class="fl">1e6</span><span class="op">,</span> pars<span class="op">[</span><span class="st">"exp_noise"</span><span class="op">]);</span></span>
<span id="cb13-105"><a href="#cb13-105" tabindex="-1"></a></span>
<span id="cb13-106"><a href="#cb13-106" tabindex="-1"></a>  sir<span class="op">::</span><span class="dt">shared_type</span> shared<span class="op">{</span>S0<span class="op">,</span> I0<span class="op">,</span> R0<span class="op">,</span> beta<span class="op">,</span> gamma<span class="op">,</span> dt<span class="op">,</span> freq<span class="op">,</span> exp_noise<span class="op">};</span></span>
<span id="cb13-107"><a href="#cb13-107" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>sir<span class="op">&gt;(</span>shared<span class="op">);</span></span>
<span id="cb13-108"><a href="#cb13-108" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-109"><a href="#cb13-109" tabindex="-1"></a></span>
<span id="cb13-110"><a href="#cb13-110" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb13-111"><a href="#cb13-111" tabindex="-1"></a>cpp11<span class="op">::</span>sexp dust_info<span class="op">&lt;</span>sir<span class="op">&gt;(</span><span class="at">const</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>sir<span class="op">&gt;&amp;</span> pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-112"><a href="#cb13-112" tabindex="-1"></a>  <span class="kw">using</span> <span class="kw">namespace</span> cpp11<span class="op">::</span>literals<span class="op">;</span></span>
<span id="cb13-113"><a href="#cb13-113" tabindex="-1"></a>  <span class="co">// Information about state order</span></span>
<span id="cb13-114"><a href="#cb13-114" tabindex="-1"></a>  cpp11<span class="op">::</span>writable<span class="op">::</span>strings vars<span class="op">({</span><span class="st">"S"</span><span class="op">,</span> <span class="st">"I"</span><span class="op">,</span> <span class="st">"R"</span><span class="op">,</span> <span class="st">"cases_cumul"</span><span class="op">,</span> <span class="st">"cases_inc"</span><span class="op">});</span></span>
<span id="cb13-115"><a href="#cb13-115" tabindex="-1"></a>  <span class="co">// Information about parameter values</span></span>
<span id="cb13-116"><a href="#cb13-116" tabindex="-1"></a>  cpp11<span class="op">::</span>list p <span class="op">=</span> cpp11<span class="op">::</span>writable<span class="op">::</span>list<span class="op">({</span><span class="st">"beta"</span><span class="op">_nm</span> <span class="op">=</span> pars<span class="op">.</span>shared<span class="op">-&gt;</span>beta<span class="op">,</span></span>
<span id="cb13-117"><a href="#cb13-117" tabindex="-1"></a>                                         <span class="st">"gamma"</span><span class="op">_nm</span> <span class="op">=</span> pars<span class="op">.</span>shared<span class="op">-&gt;</span>gamma<span class="op">});</span></span>
<span id="cb13-118"><a href="#cb13-118" tabindex="-1"></a>  <span class="cf">return</span> cpp11<span class="op">::</span>writable<span class="op">::</span>list<span class="op">({</span><span class="st">"vars"</span><span class="op">_nm</span> <span class="op">=</span> vars<span class="op">,</span> <span class="st">"pars"</span><span class="op">_nm</span> <span class="op">=</span> p<span class="op">});</span></span>
<span id="cb13-119"><a href="#cb13-119" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-120"><a href="#cb13-120" tabindex="-1"></a></span>
<span id="cb13-121"><a href="#cb13-121" tabindex="-1"></a><span class="co">// The way that this is going to work is we will process a list</span></span>
<span id="cb13-122"><a href="#cb13-122" tabindex="-1"></a><span class="co">// *outside* of the C that will take (say) a df and convert it</span></span>
<span id="cb13-123"><a href="#cb13-123" tabindex="-1"></a><span class="co">// row-wise into a list with elements `time` and `data`, we will pass</span></span>
<span id="cb13-124"><a href="#cb13-124" tabindex="-1"></a><span class="co">// that in here. Then this function will be called once per data</span></span>
<span id="cb13-125"><a href="#cb13-125" tabindex="-1"></a><span class="co">// element to create the struct that will be used for future work.</span></span>
<span id="cb13-126"><a href="#cb13-126" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb13-127"><a href="#cb13-127" tabindex="-1"></a>sir<span class="op">::</span><span class="dt">data_type</span> dust_data<span class="op">&lt;</span>sir<span class="op">&gt;(</span>cpp11<span class="op">::</span>list data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-128"><a href="#cb13-128" tabindex="-1"></a>  <span class="cf">return</span> sir<span class="op">::</span><span class="dt">data_type</span><span class="op">{</span>cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span>sir<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;(</span>data<span class="op">[</span><span class="st">"incidence"</span><span class="op">])};</span></span>
<span id="cb13-129"><a href="#cb13-129" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-130"><a href="#cb13-130" tabindex="-1"></a></span>
<span id="cb13-131"><a href="#cb13-131" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>There a few changes here compared to the version that was shown
before for the walk model, but the core parts are only slightly
different:</p>
<ul>
<li>the <code>initial</code> method is slightly more complicated as we
initialise a 3-element vector</li>
<li>our <code>shared_type</code> object has significantly more
elements</li>
<li>the <code>dust_pars</code> function is much more complicated</li>
<li>there is a <code>compare_data</code> method and a nontrivial
<code>data_type</code> definition, but ignore these for now (see
<code><a href="../articles/data.html">vignette("data")</a></code>)</li>
</ul>
<p>The other difference is a new template specialisation of
<code>dust_info</code> - this is optional but can be used to report back
to R information about the model based on the input parameters. Here it
returns information about variable order and core parameters.</p>
<p>We also have added C++ pseudo-attributes with
<code>[[dust::param]]</code> to describe the parameters that this
function takes. This is optional, but allows use of a <code>coef</code>
method with the class (see below).</p>
<p>As before, we’ll use the version bundled with the package</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="../reference/dust_example.html">dust_example</a></span><span class="op">(</span><span class="st">"sir"</span><span class="op">)</span></span></code></pre></div>
<p>To get information about the parameters, use <code><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef()</a></code> on
the generator</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">sir</span><span class="op">)</span></span>
<span><span class="co">#&gt; $I0</span></span>
<span><span class="co">#&gt; $I0$required</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $beta</span></span>
<span><span class="co">#&gt; $beta$required</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $gamma</span></span>
<span><span class="co">#&gt; $gamma$required</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $exp_noise</span></span>
<span><span class="co">#&gt; $exp_noise$required</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>The model is initialised the same way as before:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">sir</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<p>We can use the <code>$info()</code> method to retrieve information
about our model:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">info</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $vars</span></span>
<span><span class="co">#&gt; [1] "S"           "I"           "R"           "cases_cumul" "cases_inc"  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $pars</span></span>
<span><span class="co">#&gt; $pars$beta</span></span>
<span><span class="co">#&gt; [1] 0.2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $pars$gamma</span></span>
<span><span class="co">#&gt; [1] 0.1</span></span></code></pre></div>
<p>and get its state as before:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,] 1000 1000 1000 1000 1000 1000 1000 1000 1000  1000  1000  1000  1000  1000</span></span>
<span><span class="co">#&gt; [2,]   10   10   10   10   10   10   10   10   10    10    10    10    10    10</span></span>
<span><span class="co">#&gt; [3,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [4,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt;      [,15] [,16] [,17] [,18] [,19] [,20]</span></span>
<span><span class="co">#&gt; [1,]  1000  1000  1000  1000  1000  1000</span></span>
<span><span class="co">#&gt; [2,]    10    10    10    10    10    10</span></span>
<span><span class="co">#&gt; [3,]     0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [4,]     0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]     0     0     0     0     0     0</span></span></code></pre></div>
<p>Because we have 5 states per particle, this is a 5 x 20 matrix.</p>
<p>Suppose that as we run the model we mostly want information on the
“I” compartment. So we’ll run the model for a bit and retrieve the
number of infected individuals, then continue, etc. To do this we use
the <code>$set_index()</code> method to indicate which state elements
should be returned after using <code>$run()</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">set_index</span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span></span></code></pre></div>
<p>(you can pass any integer vector here, of any length, provided all
the indices lie between 1 and the length of your state vector)</p>
<p>Now, when using <code>run</code>, the number of infected individuals
is returned</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,]   13   12   12    7   10   16    7   10   16     9    10    14    14    11</span></span>
<span><span class="co">#&gt;      [,15] [,16] [,17] [,18] [,19] [,20]</span></span>
<span><span class="co">#&gt; [1,]    14    17    13    15    13    11</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,]   24   17   15   10   14   20    9   13   16     9    15    18    15    10</span></span>
<span><span class="co">#&gt;      [,15] [,16] [,17] [,18] [,19] [,20]</span></span>
<span><span class="co">#&gt; [1,]    17    26    18    26    20    16</span></span></code></pre></div>
<p>This is useful when you have many compartments or variables that you
are not that interested in during running the model. For a particle
filter you might be fitting to the sum of all infected individuals over
a number of compartments, so rather than returning hundreds of values
back (times hundreds of particles) you can return back much less data
and keep things nice and fast.</p>
<p>If the index vector is named, then those names will be used as row
names on the returned object:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">set_index</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>I <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; I   27   29   16   12   18   24   11   16   26     7    18    24    20     9</span></span>
<span><span class="co">#&gt;   [,15] [,16] [,17] [,18] [,19] [,20]</span></span>
<span><span class="co">#&gt; I    29    34    26    35    21    19</span></span></code></pre></div>
<p>We can always use <code>$state()</code> to get the whole state
vector:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,]  968  972  987  984  981  970  990  984  971   994   985   976   980   990</span></span>
<span><span class="co">#&gt; [2,]   27   29   16   12   18   24   11   16   26     7    18    24    20     9</span></span>
<span><span class="co">#&gt; [3,]   15    9    7   14   11   16    9   10   13     9     7    10    10    11</span></span>
<span><span class="co">#&gt; [4,]   32   28   13   16   19   30   10   16   29     6    15    24    20    10</span></span>
<span><span class="co">#&gt; [5,]    6    1    2    0    1    3    1    3    3     0     0     0     0     1</span></span>
<span><span class="co">#&gt;      [,15] [,16] [,17] [,18] [,19] [,20]</span></span>
<span><span class="co">#&gt; [1,]   969   961   973   965   978   979</span></span>
<span><span class="co">#&gt; [2,]    29    34    26    35    21    19</span></span>
<span><span class="co">#&gt; [3,]    12    15    11    10    11    12</span></span>
<span><span class="co">#&gt; [4,]    31    39    27    35    22    21</span></span>
<span><span class="co">#&gt; [5,]     5     3     2     3     2     2</span></span></code></pre></div>
<p>or select only variables of interest:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">1L</span>, R <span class="op">=</span> <span class="fl">3L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; S  968  972  987  984  981  970  990  984  971   994   985   976   980   990</span></span>
<span><span class="co">#&gt; R   15    9    7   14   11   16    9   10   13     9     7    10    10    11</span></span>
<span><span class="co">#&gt;   [,15] [,16] [,17] [,18] [,19] [,20]</span></span>
<span><span class="co">#&gt; S   969   961   973   965   978   979</span></span>
<span><span class="co">#&gt; R    12    15    11    10    11    12</span></span></code></pre></div>
<p>Again, this copies names from the index if they are present.</p>
<p>In order to run the simulation beginning-to-end, we use the
<code>$simulate</code> method on a dust object, which runs over a set of
time steps and records the state at each.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">sir</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">set_index</span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span></span>
<span><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">600</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">state</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span><span class="va">times</span><span class="op">)</span></span></code></pre></div>
<p>The output here is a 1 x 200 x 121 matrix (n state x n particles x n
times)</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]   1 200 121</span></span></code></pre></div>
<p>we need to drop the first dimension and transpose the others for ease
of plotting:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">traces</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Plotting this over time (with 4 time steps per day - see the sir code
above)</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">day</span> <span class="op">&lt;-</span> <span class="va">times</span> <span class="op">/</span> <span class="fl">4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">day</span>, <span class="va">traces</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#00000022"</span>,</span>
<span>        xlab <span class="op">=</span> <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"Number infected (I)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">day</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">traces</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="dust_files/figure-html/sir_average-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="other-methods">Other methods<a class="anchor" aria-label="anchor" href="#other-methods"></a>
</h2>
<p>There are a few other methods on the dust objects that may be
useful.</p>
<div class="section level3">
<h3 id="reordering-particles">Reordering particles<a class="anchor" aria-label="anchor" href="#reordering-particles"></a>
</h3>
<p>This method exists to support particle filtering, and allows
resampling or reordering of particles.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">walk</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;            [,1]      [,2]      [,3]      [,4]      [,5]       [,6]      [,7]</span></span>
<span><span class="co">#&gt; [1,] -0.9913771 0.5263764 -1.212776 -1.196482 -2.086759 -0.2547538 -1.558273</span></span>
<span><span class="co">#&gt;           [,8]       [,9]    [,10]     [,11]      [,12]    [,13]      [,14]</span></span>
<span><span class="co">#&gt; [1,] 0.7737245 -0.1605361 1.577878 0.4376267 0.04117756 2.729115 -0.4464083</span></span>
<span><span class="co">#&gt;           [,15]      [,16]      [,17]       [,18]     [,19]     [,20]</span></span>
<span><span class="co">#&gt; [1,] -0.7641456 -0.3974461 -0.9250056 -0.02218473 -1.401276 -0.192085</span></span></code></pre></div>
<p>Suppose that we wanted to reorder these particles so that they were
in decreasing order:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">index</span></span>
<span><span class="co">#&gt;  [1]  5  7 19  3  4  1 17 15 14 16  6 20  9 18 12 11  2  8 10 13</span></span></code></pre></div>
<p>We then pass this <code>index</code> to the reorder method:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">reorder</span><span class="op">(</span><span class="va">index</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]      [,2]      [,3]      [,4]      [,5]       [,6]       [,7]</span></span>
<span><span class="co">#&gt; [1,] -2.086759 -1.558273 -1.401276 -1.212776 -1.196482 -0.9913771 -0.9250056</span></span>
<span><span class="co">#&gt;            [,8]       [,9]      [,10]      [,11]     [,12]      [,13]</span></span>
<span><span class="co">#&gt; [1,] -0.7641456 -0.4464083 -0.3974461 -0.2547538 -0.192085 -0.1605361</span></span>
<span><span class="co">#&gt;            [,14]      [,15]     [,16]     [,17]     [,18]    [,19]    [,20]</span></span>
<span><span class="co">#&gt; [1,] -0.02218473 0.04117756 0.4376267 0.5263764 0.7737245 1.577878 2.729115</span></span></code></pre></div>
<p>We can then continue our random walk. There is no need to sample
every particle and particles can appear multiple times in the sample,
but the total number must be conserved. Suppose that we want to to
sample particles based on how close they are to 0:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span> , prob <span class="op">=</span> <span class="va">p</span><span class="op">)</span></span>
<span><span class="va">index</span></span>
<span><span class="co">#&gt;  [1] 12 18  7  5 13 14 11 10 13 10 14 10 19 12  8 18 13 19 18 14</span></span></code></pre></div>
<p>We can then apply this sampling:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">reorder</span><span class="op">(</span><span class="va">index</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;           [,1]      [,2]       [,3]      [,4]       [,5]        [,6]       [,7]</span></span>
<span><span class="co">#&gt; [1,] -0.192085 0.7737245 -0.9250056 -1.196482 -0.1605361 -0.02218473 -0.2547538</span></span>
<span><span class="co">#&gt;            [,8]       [,9]      [,10]       [,11]      [,12]    [,13]     [,14]</span></span>
<span><span class="co">#&gt; [1,] -0.3974461 -0.1605361 -0.3974461 -0.02218473 -0.3974461 1.577878 -0.192085</span></span>
<span><span class="co">#&gt;           [,15]     [,16]      [,17]    [,18]     [,19]       [,20]</span></span>
<span><span class="co">#&gt; [1,] -0.7641456 0.7737245 -0.1605361 1.577878 0.7737245 -0.02218473</span></span></code></pre></div>
<p>This is not terribly useful on its own but is a key part of a
particle filter.</p>
<p>When this reordering happens, only the model state is copied around;
the <code>internal</code> data and random number state are left
behind.</p>
</div>
<div class="section level3">
<h3 id="set-particle-state">Set particle state<a class="anchor" aria-label="anchor" href="#set-particle-state"></a>
</h3>
<p>A particle state is determined by three mutable things;
<code>pars</code>, <code>state</code> and <code>time</code>; these can
all be updated for a model after it has been created. We have found
setting one or more of these at a time important;</p>
<ul>
<li>Resetting the model with a new set of parameters
(<code>pars</code>), initial conditions (<code>state</code>) and times
(<code>time</code>)</li>
<li>Changing <code>pars</code> at some point in the simulation to
introduce some new aspect of the model</li>
<li>Changing <code>state</code> to manually move around some individuals
within a model</li>
<li>Setting <code>time</code> along with <code>state</code> when
initialising the model from a previously saved state</li>
</ul>
<p>The <code>update_state</code> method allows setting any or all of
these components.</p>
<p>By default every particle starts from the initial condition specified
by your model classes <code>initial()</code> method. However, you can
specify a state directly using the <code>$update_state()</code> method.
Here, we initialise our SIR model with only 1 infected individual rather
than 10:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">sir</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">update_state</span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,] 1000 1000 1000 1000 1000 1000 1000 1000 1000  1000  1000  1000  1000  1000</span></span>
<span><span class="co">#&gt; [2,]    1    1    1    1    1    1    1    1    1     1     1     1     1     1</span></span>
<span><span class="co">#&gt; [3,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [4,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt;      [,15] [,16] [,17] [,18] [,19] [,20]</span></span>
<span><span class="co">#&gt; [1,]  1000  1000  1000  1000  1000  1000</span></span>
<span><span class="co">#&gt; [2,]     1     1     1     1     1     1</span></span>
<span><span class="co">#&gt; [3,]     0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [4,]     0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]     0     0     0     0     0     0</span></span></code></pre></div>
<p>Now, when we run the model, far more of the epidemics fail to take
off as the infected individual goes disappears before infecting
anyone.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">600</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">state</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span><span class="va">times</span><span class="op">)</span></span>
<span><span class="va">day</span> <span class="op">&lt;-</span> <span class="va">times</span> <span class="op">/</span> <span class="fl">4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">day</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">state</span><span class="op">[</span><span class="fl">2</span>, , <span class="op">]</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#00000022"</span>,</span>
<span>        xlab <span class="op">=</span> <span class="st">"Day"</span>, ylab <span class="op">=</span> <span class="st">"Number infected (I)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="dust_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<p>You can optionally set the initial time along with the state. This is
useful if your model depends on time (e.g., you use the time step in a
calculation by transforming it into some more meaningful measure of
time).</p>
<p>You can also set the initial state to a range of different values.
Suppose we set the initial number of infections to be Poisson
distributed with a mean of 10, we might write:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">I0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">state0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fl">1010</span> <span class="op">-</span> <span class="va">I0</span>, <span class="va">I0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, deparse.level <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">update_state</span><span class="op">(</span>state <span class="op">=</span> <span class="va">state0</span>, time <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">time</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span></span>
<span><span class="co">#&gt; [1,]  999  996 1001  995 1003  999 1005  993 1001  1002  1000   998   999  1002</span></span>
<span><span class="co">#&gt; [2,]   11   14    9   15    7   11    5   17    9     8    10    12    11     8</span></span>
<span><span class="co">#&gt; [3,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [4,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span></span>
<span><span class="co">#&gt;      [,15] [,16] [,17] [,18] [,19] [,20]</span></span>
<span><span class="co">#&gt; [1,]  1002  1002  1003  1000  1001   991</span></span>
<span><span class="co">#&gt; [2,]     8     8     7    10     9    19</span></span>
<span><span class="co">#&gt; [3,]     0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [4,]     0     0     0     0     0     0</span></span>
<span><span class="co">#&gt; [5,]     0     0     0     0     0     0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="reset-the-model">Reset the model<a class="anchor" aria-label="anchor" href="#reset-the-model"></a>
</h3>
<p>One particularly common case is to “reset” the model in order to run
it again. you should not simply recreate the model from its constructor
as that will re-seed a new set of random state – it would be preferable
continue with the generator state in your old model.</p>
<p>Suppose we run our model with sd of 1 for 100 time steps</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">walk</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">10</span>, seed <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">y1</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p>we then use <code>reset</code> to set new parameters into the model
and set the time back to zero and can run again</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span><span class="op">$</span><span class="fu">update_state</span><span class="op">(</span>pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, time <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">y2</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p>The state created in <code>y2</code> will have started from our new
starting point and time zero, but have used the same random number state
through both simulations, which is generally what we want.</p>
</div>
</div>
<div class="section level2">
<h2 id="use-within-a-package">Use within a package<a class="anchor" aria-label="anchor" href="#use-within-a-package"></a>
</h2>
<p>You should not use <code><a href="../reference/dust.html">dust::dust()</a></code> within a package,
because that would cause the model to compile each time you use it,
rather than when the package builds. It may also cause issues when
trying to use the model in parallel (e.g., with the
<code>parallel</code> package). Instead you should use
<code><a href="../reference/dust_package.html">dust::dust_package()</a></code> which will generate appropriate code
for you.</p>
<p>To use dust in a package, put your dust models in
<code>inst/dust</code> and run <code><a href="../reference/dust_package.html">dust::dust_package()</a></code> on the
package’s root directory.</p>
<p>A skeleton package might contain:</p>
<pre><code><span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">.</span></span></span>
<span><span class="co">#&gt; ├── DESCRIPTION</span></span>
<span><span class="co">#&gt; ├── NAMESPACE</span></span>
<span><span class="co">#&gt; └── <span style="color: #0000BB; font-weight: bold;">inst</span></span></span>
<span><span class="co">#&gt;     └── <span style="color: #0000BB; font-weight: bold;">dust</span></span></span>
<span><span class="co">#&gt;         └── walk.cpp</span></span></code></pre>
<p>This is the normal R package skeleton, though missing R and src
directories (for now). The DESCRIPTION file contains</p>
<pre class="plain"><code>Package: example
Title: Example Dust in a Package
Version: 0.0.1
LinkingTo: cpp11, dust
Authors@R: c(person('A', 'Person', role = c('aut', 'cre')
                     email = 'person@example.com'))
License: CC0</code></pre>
<p>The important things here are:</p>
<ul>
<li>the package name (<code>Package</code>). We’re using
<code>example</code>, and names with a dot may not work as expected</li>
<li>including <a href="https://github.com/r-lib/cpp11" class="external-link"><code>cpp11</code></a> and
<code>dust</code> in <code>LinkingTo</code>, which allows package
compilation to find their respective header files</li>
<li>a <code>useDynLib</code> call to your package in the
<code>NAMESPACE</code> file</li>
</ul>
<p>Our <code>NAMESPACE</code> file contains:</p>
<pre class="plain"><code><span><span class="fu">useDynLib</span><span class="op">(</span><span class="st">'example'</span>, .registration <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
<p>The files in <code>inst/dust</code> are the same files as seen above,
with <code>walk.cpp</code> containing</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="kw">class</span> walk <span class="op">{</span></span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">data_type</span> <span class="op">=</span> dust<span class="op">::</span>no_data<span class="op">;</span></span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">internal_type</span> <span class="op">=</span> dust<span class="op">::</span>no_internal<span class="op">;</span></span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">shared_type</span> <span class="op">{</span></span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a>    <span class="dt">real_type</span> sd<span class="op">;</span></span>
<span id="cb41-10"><a href="#cb41-10" tabindex="-1"></a>    <span class="dt">bool</span> random_initial<span class="op">;</span></span>
<span id="cb41-11"><a href="#cb41-11" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb41-12"><a href="#cb41-12" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" tabindex="-1"></a>  walk<span class="op">(</span><span class="at">const</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>walk<span class="op">&gt;&amp;</span> pars<span class="op">)</span> <span class="op">:</span> shared<span class="op">(</span>pars<span class="op">.</span>shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-14"><a href="#cb41-14" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-15"><a href="#cb41-15" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" tabindex="-1"></a>  <span class="dt">size_t</span> size<span class="op">()</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb41-17"><a href="#cb41-17" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb41-18"><a href="#cb41-18" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-19"><a href="#cb41-19" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> initial<span class="op">(</span><span class="dt">size_t</span> time<span class="op">,</span> <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-21"><a href="#cb41-21" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> ret <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb41-22"><a href="#cb41-22" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>shared<span class="op">-&gt;</span>random_initial<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-23"><a href="#cb41-23" tabindex="-1"></a>      ret<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>normal<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> shared<span class="op">-&gt;</span>sd<span class="op">);</span></span>
<span id="cb41-24"><a href="#cb41-24" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-25"><a href="#cb41-25" tabindex="-1"></a>    <span class="cf">return</span> ret<span class="op">;</span></span>
<span id="cb41-26"><a href="#cb41-26" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-27"><a href="#cb41-27" tabindex="-1"></a></span>
<span id="cb41-28"><a href="#cb41-28" tabindex="-1"></a>  <span class="dt">void</span> update<span class="op">(</span><span class="dt">size_t</span> time<span class="op">,</span> <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span> <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb41-29"><a href="#cb41-29" tabindex="-1"></a>              <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-30"><a href="#cb41-30" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span></span>
<span id="cb41-31"><a href="#cb41-31" tabindex="-1"></a>      dust<span class="op">::</span>random<span class="op">::</span>normal<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> shared<span class="op">-&gt;</span>sd<span class="op">);</span></span>
<span id="cb41-32"><a href="#cb41-32" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-33"><a href="#cb41-33" tabindex="-1"></a></span>
<span id="cb41-34"><a href="#cb41-34" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb41-35"><a href="#cb41-35" tabindex="-1"></a>  dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>walk<span class="op">&gt;</span> shared<span class="op">;</span></span>
<span id="cb41-36"><a href="#cb41-36" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb41-37"><a href="#cb41-37" tabindex="-1"></a></span>
<span id="cb41-38"><a href="#cb41-38" tabindex="-1"></a><span class="kw">namespace</span> dust <span class="op">{</span></span>
<span id="cb41-39"><a href="#cb41-39" tabindex="-1"></a></span>
<span id="cb41-40"><a href="#cb41-40" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb41-41"><a href="#cb41-41" tabindex="-1"></a>dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>walk<span class="op">&gt;</span> dust_pars<span class="op">&lt;</span>walk<span class="op">&gt;(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-42"><a href="#cb41-42" tabindex="-1"></a>  walk<span class="op">::</span><span class="dt">real_type</span> sd <span class="op">=</span> cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span>walk<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;(</span>pars<span class="op">[</span><span class="st">"sd"</span><span class="op">]);</span></span>
<span id="cb41-43"><a href="#cb41-43" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">bool</span> random_initial <span class="op">=</span> pars<span class="op">[</span><span class="st">"random_initial"</span><span class="op">]</span> <span class="op">==</span> R_NilValue <span class="op">?</span> <span class="kw">false</span> <span class="op">:</span></span>
<span id="cb41-44"><a href="#cb41-44" tabindex="-1"></a>    cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;(</span>pars<span class="op">[</span><span class="st">"random_initial"</span><span class="op">]);</span></span>
<span id="cb41-45"><a href="#cb41-45" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>walk<span class="op">&gt;(</span>walk<span class="op">::</span><span class="dt">shared_type</span><span class="op">{</span>sd<span class="op">,</span> random_initial<span class="op">});</span></span>
<span id="cb41-46"><a href="#cb41-46" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-47"><a href="#cb41-47" tabindex="-1"></a></span>
<span id="cb41-48"><a href="#cb41-48" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>There can be as many of these files as you want within the directory
<code>inst/dust</code>.</p>
<p>To prepare the package, run <code><a href="../reference/dust_package.html">dust::dust_package()</a></code>:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="../reference/dust_package.html">dust_package</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> 21 functions decorated with [[cpp11::register]]</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> generated file <span style="color: #0000BB;">cpp11.R</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> generated file <span style="color: #0000BB;">cpp11.cpp</span></span></span></code></pre></div>
<p>The directory structure now has more files:</p>
<pre><code><span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">.</span></span></span>
<span><span class="co">#&gt; ├── DESCRIPTION</span></span>
<span><span class="co">#&gt; ├── NAMESPACE</span></span>
<span><span class="co">#&gt; ├── <span style="color: #0000BB; font-weight: bold;">R</span></span></span>
<span><span class="co">#&gt; │   ├── <span style="color: #00BB00;">cpp11.R</span></span></span>
<span><span class="co">#&gt; │   └── <span style="color: #00BB00;">dust.R</span></span></span>
<span><span class="co">#&gt; ├── <span style="color: #0000BB; font-weight: bold;">inst</span></span></span>
<span><span class="co">#&gt; │   └── <span style="color: #0000BB; font-weight: bold;">dust</span></span></span>
<span><span class="co">#&gt; │       └── walk.cpp</span></span>
<span><span class="co">#&gt; └── <span style="color: #0000BB; font-weight: bold;">src</span></span></span>
<span><span class="co">#&gt;     ├── Makevars</span></span>
<span><span class="co">#&gt;     ├── cpp11.cpp</span></span>
<span><span class="co">#&gt;     └── walk.cpp</span></span></code></pre>
<p>The file <code>src/walk.cpp</code> are generated by dust and should
not be edited. They include your model, but also a bit of helper
code:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="co">// Generated by dust (version 0.15.3) - do not edit</span></span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a>cpp11<span class="op">::</span>sexp dust_walk_gpu_info<span class="op">();</span></span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-7"><a href="#cb44-7" tabindex="-1"></a>SEXP dust_cpu_walk_alloc<span class="op">(</span>cpp11<span class="op">::</span>list r_pars<span class="op">,</span> <span class="dt">bool</span> pars_multi<span class="op">,</span> cpp11<span class="op">::</span>sexp r_time<span class="op">,</span></span>
<span id="cb44-8"><a href="#cb44-8" tabindex="-1"></a>                         cpp11<span class="op">::</span>sexp r_n_particles<span class="op">,</span> <span class="dt">int</span> n_threads<span class="op">,</span></span>
<span id="cb44-9"><a href="#cb44-9" tabindex="-1"></a>                         cpp11<span class="op">::</span>sexp r_seed<span class="op">,</span> <span class="dt">bool</span> deterministic<span class="op">,</span></span>
<span id="cb44-10"><a href="#cb44-10" tabindex="-1"></a>                         cpp11<span class="op">::</span>sexp gpu_config<span class="op">,</span> cpp11<span class="op">::</span>sexp ode_control<span class="op">);</span></span>
<span id="cb44-11"><a href="#cb44-11" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-13"><a href="#cb44-13" tabindex="-1"></a>cpp11<span class="op">::</span>sexp dust_cpu_walk_capabilities<span class="op">();</span></span>
<span id="cb44-14"><a href="#cb44-14" tabindex="-1"></a></span>
<span id="cb44-15"><a href="#cb44-15" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-16"><a href="#cb44-16" tabindex="-1"></a>SEXP dust_cpu_walk_run<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp r_time_end<span class="op">);</span></span>
<span id="cb44-17"><a href="#cb44-17" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-19"><a href="#cb44-19" tabindex="-1"></a>SEXP dust_cpu_walk_simulate<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp time_end<span class="op">);</span></span>
<span id="cb44-20"><a href="#cb44-20" tabindex="-1"></a></span>
<span id="cb44-21"><a href="#cb44-21" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-22"><a href="#cb44-22" tabindex="-1"></a>SEXP dust_cpu_walk_run_adjoint<span class="op">(</span>SEXP ptr<span class="op">);</span></span>
<span id="cb44-23"><a href="#cb44-23" tabindex="-1"></a></span>
<span id="cb44-24"><a href="#cb44-24" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-25"><a href="#cb44-25" tabindex="-1"></a>SEXP dust_cpu_walk_set_index<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp r_index<span class="op">);</span></span>
<span id="cb44-26"><a href="#cb44-26" tabindex="-1"></a></span>
<span id="cb44-27"><a href="#cb44-27" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-28"><a href="#cb44-28" tabindex="-1"></a>SEXP dust_cpu_walk_update_state<span class="op">(</span>SEXP ptr<span class="op">,</span> SEXP r_pars<span class="op">,</span> SEXP r_state<span class="op">,</span></span>
<span id="cb44-29"><a href="#cb44-29" tabindex="-1"></a>                                           SEXP r_time<span class="op">,</span> SEXP r_set_initial_state<span class="op">,</span></span>
<span id="cb44-30"><a href="#cb44-30" tabindex="-1"></a>                                           SEXP index<span class="op">,</span> SEXP reset_step_size<span class="op">);</span></span>
<span id="cb44-31"><a href="#cb44-31" tabindex="-1"></a></span>
<span id="cb44-32"><a href="#cb44-32" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-33"><a href="#cb44-33" tabindex="-1"></a>SEXP dust_cpu_walk_state<span class="op">(</span>SEXP ptr<span class="op">,</span> SEXP r_index<span class="op">);</span></span>
<span id="cb44-34"><a href="#cb44-34" tabindex="-1"></a></span>
<span id="cb44-35"><a href="#cb44-35" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-36"><a href="#cb44-36" tabindex="-1"></a>SEXP dust_cpu_walk_time<span class="op">(</span>SEXP ptr<span class="op">);</span></span>
<span id="cb44-37"><a href="#cb44-37" tabindex="-1"></a></span>
<span id="cb44-38"><a href="#cb44-38" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-39"><a href="#cb44-39" tabindex="-1"></a><span class="dt">void</span> dust_cpu_walk_reorder<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp r_index<span class="op">);</span></span>
<span id="cb44-40"><a href="#cb44-40" tabindex="-1"></a></span>
<span id="cb44-41"><a href="#cb44-41" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-42"><a href="#cb44-42" tabindex="-1"></a>SEXP dust_cpu_walk_resample<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>doubles r_weights<span class="op">);</span></span>
<span id="cb44-43"><a href="#cb44-43" tabindex="-1"></a></span>
<span id="cb44-44"><a href="#cb44-44" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-45"><a href="#cb44-45" tabindex="-1"></a>SEXP dust_cpu_walk_rng_state<span class="op">(</span>SEXP ptr<span class="op">,</span> <span class="dt">bool</span> first_only<span class="op">,</span> <span class="dt">bool</span> last_only<span class="op">);</span></span>
<span id="cb44-46"><a href="#cb44-46" tabindex="-1"></a></span>
<span id="cb44-47"><a href="#cb44-47" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-48"><a href="#cb44-48" tabindex="-1"></a>SEXP dust_cpu_walk_set_rng_state<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>raws rng_state<span class="op">);</span></span>
<span id="cb44-49"><a href="#cb44-49" tabindex="-1"></a></span>
<span id="cb44-50"><a href="#cb44-50" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-51"><a href="#cb44-51" tabindex="-1"></a>SEXP dust_cpu_walk_set_data<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>list data<span class="op">,</span> <span class="dt">bool</span> shared<span class="op">);</span></span>
<span id="cb44-52"><a href="#cb44-52" tabindex="-1"></a></span>
<span id="cb44-53"><a href="#cb44-53" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-54"><a href="#cb44-54" tabindex="-1"></a>SEXP dust_cpu_walk_compare_data<span class="op">(</span>SEXP ptr<span class="op">);</span></span>
<span id="cb44-55"><a href="#cb44-55" tabindex="-1"></a></span>
<span id="cb44-56"><a href="#cb44-56" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-57"><a href="#cb44-57" tabindex="-1"></a>SEXP dust_cpu_walk_filter<span class="op">(</span>SEXP ptr<span class="op">,</span> SEXP time_end<span class="op">,</span></span>
<span id="cb44-58"><a href="#cb44-58" tabindex="-1"></a>                                     <span class="dt">bool</span> save_trajectories<span class="op">,</span></span>
<span id="cb44-59"><a href="#cb44-59" tabindex="-1"></a>                                     cpp11<span class="op">::</span>sexp time_snapshot<span class="op">,</span></span>
<span id="cb44-60"><a href="#cb44-60" tabindex="-1"></a>                                     cpp11<span class="op">::</span>sexp min_log_likelihood<span class="op">);</span></span>
<span id="cb44-61"><a href="#cb44-61" tabindex="-1"></a></span>
<span id="cb44-62"><a href="#cb44-62" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-63"><a href="#cb44-63" tabindex="-1"></a><span class="dt">void</span> dust_cpu_walk_set_n_threads<span class="op">(</span>SEXP ptr<span class="op">,</span> <span class="dt">int</span> n_threads<span class="op">);</span></span>
<span id="cb44-64"><a href="#cb44-64" tabindex="-1"></a></span>
<span id="cb44-65"><a href="#cb44-65" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-66"><a href="#cb44-66" tabindex="-1"></a><span class="dt">int</span> dust_cpu_walk_n_state<span class="op">(</span>SEXP ptr<span class="op">);</span></span>
<span id="cb44-67"><a href="#cb44-67" tabindex="-1"></a></span>
<span id="cb44-68"><a href="#cb44-68" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-69"><a href="#cb44-69" tabindex="-1"></a><span class="dt">void</span> dust_cpu_walk_set_stochastic_schedule<span class="op">(</span>SEXP ptr<span class="op">,</span> SEXP time<span class="op">);</span></span>
<span id="cb44-70"><a href="#cb44-70" tabindex="-1"></a></span>
<span id="cb44-71"><a href="#cb44-71" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb44-72"><a href="#cb44-72" tabindex="-1"></a>SEXP dust_cpu_walk_ode_statistics<span class="op">(</span>SEXP ptr<span class="op">);</span></span>
<span id="cb44-73"><a href="#cb44-73" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust/r/dust.hpp&gt;</span></span>
<span id="cb44-74"><a href="#cb44-74" tabindex="-1"></a></span>
<span id="cb44-75"><a href="#cb44-75" tabindex="-1"></a><span class="kw">class</span> walk <span class="op">{</span></span>
<span id="cb44-76"><a href="#cb44-76" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb44-77"><a href="#cb44-77" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span>
<span id="cb44-78"><a href="#cb44-78" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">data_type</span> <span class="op">=</span> dust<span class="op">::</span>no_data<span class="op">;</span></span>
<span id="cb44-79"><a href="#cb44-79" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">internal_type</span> <span class="op">=</span> dust<span class="op">::</span>no_internal<span class="op">;</span></span>
<span id="cb44-80"><a href="#cb44-80" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb44-81"><a href="#cb44-81" tabindex="-1"></a></span>
<span id="cb44-82"><a href="#cb44-82" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">shared_type</span> <span class="op">{</span></span>
<span id="cb44-83"><a href="#cb44-83" tabindex="-1"></a>    <span class="dt">real_type</span> sd<span class="op">;</span></span>
<span id="cb44-84"><a href="#cb44-84" tabindex="-1"></a>    <span class="dt">bool</span> random_initial<span class="op">;</span></span>
<span id="cb44-85"><a href="#cb44-85" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb44-86"><a href="#cb44-86" tabindex="-1"></a></span>
<span id="cb44-87"><a href="#cb44-87" tabindex="-1"></a>  walk<span class="op">(</span><span class="at">const</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>walk<span class="op">&gt;&amp;</span> pars<span class="op">)</span> <span class="op">:</span> shared<span class="op">(</span>pars<span class="op">.</span>shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-88"><a href="#cb44-88" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb44-89"><a href="#cb44-89" tabindex="-1"></a></span>
<span id="cb44-90"><a href="#cb44-90" tabindex="-1"></a>  <span class="dt">size_t</span> size<span class="op">()</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb44-91"><a href="#cb44-91" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb44-92"><a href="#cb44-92" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb44-93"><a href="#cb44-93" tabindex="-1"></a></span>
<span id="cb44-94"><a href="#cb44-94" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> initial<span class="op">(</span><span class="dt">size_t</span> time<span class="op">,</span> <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-95"><a href="#cb44-95" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> ret <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb44-96"><a href="#cb44-96" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>shared<span class="op">-&gt;</span>random_initial<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-97"><a href="#cb44-97" tabindex="-1"></a>      ret<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>normal<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> shared<span class="op">-&gt;</span>sd<span class="op">);</span></span>
<span id="cb44-98"><a href="#cb44-98" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-99"><a href="#cb44-99" tabindex="-1"></a>    <span class="cf">return</span> ret<span class="op">;</span></span>
<span id="cb44-100"><a href="#cb44-100" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb44-101"><a href="#cb44-101" tabindex="-1"></a></span>
<span id="cb44-102"><a href="#cb44-102" tabindex="-1"></a>  <span class="dt">void</span> update<span class="op">(</span><span class="dt">size_t</span> time<span class="op">,</span> <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span> <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb44-103"><a href="#cb44-103" tabindex="-1"></a>              <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-104"><a href="#cb44-104" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span></span>
<span id="cb44-105"><a href="#cb44-105" tabindex="-1"></a>      dust<span class="op">::</span>random<span class="op">::</span>normal<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> shared<span class="op">-&gt;</span>sd<span class="op">);</span></span>
<span id="cb44-106"><a href="#cb44-106" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb44-107"><a href="#cb44-107" tabindex="-1"></a></span>
<span id="cb44-108"><a href="#cb44-108" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb44-109"><a href="#cb44-109" tabindex="-1"></a>  dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>walk<span class="op">&gt;</span> shared<span class="op">;</span></span>
<span id="cb44-110"><a href="#cb44-110" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb44-111"><a href="#cb44-111" tabindex="-1"></a></span>
<span id="cb44-112"><a href="#cb44-112" tabindex="-1"></a><span class="kw">namespace</span> dust <span class="op">{</span></span>
<span id="cb44-113"><a href="#cb44-113" tabindex="-1"></a></span>
<span id="cb44-114"><a href="#cb44-114" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb44-115"><a href="#cb44-115" tabindex="-1"></a>dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>walk<span class="op">&gt;</span> dust_pars<span class="op">&lt;</span>walk<span class="op">&gt;(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-116"><a href="#cb44-116" tabindex="-1"></a>  walk<span class="op">::</span><span class="dt">real_type</span> sd <span class="op">=</span> cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span>walk<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;(</span>pars<span class="op">[</span><span class="st">"sd"</span><span class="op">]);</span></span>
<span id="cb44-117"><a href="#cb44-117" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">bool</span> random_initial <span class="op">=</span> pars<span class="op">[</span><span class="st">"random_initial"</span><span class="op">]</span> <span class="op">==</span> R_NilValue <span class="op">?</span> <span class="kw">false</span> <span class="op">:</span></span>
<span id="cb44-118"><a href="#cb44-118" tabindex="-1"></a>    cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;(</span>pars<span class="op">[</span><span class="st">"random_initial"</span><span class="op">]);</span></span>
<span id="cb44-119"><a href="#cb44-119" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>walk<span class="op">&gt;(</span>walk<span class="op">::</span><span class="dt">shared_type</span><span class="op">{</span>sd<span class="op">,</span> random_initial<span class="op">});</span></span>
<span id="cb44-120"><a href="#cb44-120" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-121"><a href="#cb44-121" tabindex="-1"></a></span>
<span id="cb44-122"><a href="#cb44-122" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-123"><a href="#cb44-123" tabindex="-1"></a></span>
<span id="cb44-124"><a href="#cb44-124" tabindex="-1"></a>cpp11<span class="op">::</span>sexp dust_walk_gpu_info<span class="op">()</span> <span class="op">{</span></span>
<span id="cb44-125"><a href="#cb44-125" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>gpu<span class="op">::</span>r<span class="op">::</span>gpu_info<span class="op">();</span></span>
<span id="cb44-126"><a href="#cb44-126" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-127"><a href="#cb44-127" tabindex="-1"></a><span class="kw">using</span> model_cpu <span class="op">=</span> dust<span class="op">::</span>dust_cpu<span class="op">&lt;</span>walk<span class="op">&gt;;</span></span>
<span id="cb44-128"><a href="#cb44-128" tabindex="-1"></a></span>
<span id="cb44-129"><a href="#cb44-129" tabindex="-1"></a>cpp11<span class="op">::</span>sexp dust_cpu_walk_capabilities<span class="op">()</span> <span class="op">{</span></span>
<span id="cb44-130"><a href="#cb44-130" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_capabilities<span class="op">&lt;</span>model_cpu<span class="op">&gt;();</span></span>
<span id="cb44-131"><a href="#cb44-131" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-132"><a href="#cb44-132" tabindex="-1"></a></span>
<span id="cb44-133"><a href="#cb44-133" tabindex="-1"></a>SEXP dust_cpu_walk_alloc<span class="op">(</span>cpp11<span class="op">::</span>list r_pars<span class="op">,</span> <span class="dt">bool</span> pars_multi<span class="op">,</span> cpp11<span class="op">::</span>sexp r_time<span class="op">,</span></span>
<span id="cb44-134"><a href="#cb44-134" tabindex="-1"></a>                             cpp11<span class="op">::</span>sexp r_n_particles<span class="op">,</span> <span class="dt">int</span> n_threads<span class="op">,</span></span>
<span id="cb44-135"><a href="#cb44-135" tabindex="-1"></a>                             cpp11<span class="op">::</span>sexp r_seed<span class="op">,</span> <span class="dt">bool</span> deterministic<span class="op">,</span></span>
<span id="cb44-136"><a href="#cb44-136" tabindex="-1"></a>                             cpp11<span class="op">::</span>sexp gpu_config<span class="op">,</span> cpp11<span class="op">::</span>sexp ode_control<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-137"><a href="#cb44-137" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_cpu_alloc<span class="op">&lt;</span>walk<span class="op">&gt;(</span>r_pars<span class="op">,</span> pars_multi<span class="op">,</span> r_time<span class="op">,</span> r_n_particles<span class="op">,</span></span>
<span id="cb44-138"><a href="#cb44-138" tabindex="-1"></a>                                        n_threads<span class="op">,</span> r_seed<span class="op">,</span> deterministic<span class="op">,</span></span>
<span id="cb44-139"><a href="#cb44-139" tabindex="-1"></a>                                        gpu_config<span class="op">,</span> ode_control<span class="op">);</span></span>
<span id="cb44-140"><a href="#cb44-140" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-141"><a href="#cb44-141" tabindex="-1"></a></span>
<span id="cb44-142"><a href="#cb44-142" tabindex="-1"></a>SEXP dust_cpu_walk_run<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp r_time_end<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-143"><a href="#cb44-143" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_run<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> r_time_end<span class="op">);</span></span>
<span id="cb44-144"><a href="#cb44-144" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-145"><a href="#cb44-145" tabindex="-1"></a></span>
<span id="cb44-146"><a href="#cb44-146" tabindex="-1"></a>SEXP dust_cpu_walk_simulate<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp r_time_end<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-147"><a href="#cb44-147" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_simulate<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> r_time_end<span class="op">);</span></span>
<span id="cb44-148"><a href="#cb44-148" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-149"><a href="#cb44-149" tabindex="-1"></a></span>
<span id="cb44-150"><a href="#cb44-150" tabindex="-1"></a>SEXP dust_cpu_walk_run_adjoint<span class="op">(</span>SEXP ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-151"><a href="#cb44-151" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_run_adjoint<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">);</span></span>
<span id="cb44-152"><a href="#cb44-152" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-153"><a href="#cb44-153" tabindex="-1"></a></span>
<span id="cb44-154"><a href="#cb44-154" tabindex="-1"></a>SEXP dust_cpu_walk_set_index<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp r_index<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-155"><a href="#cb44-155" tabindex="-1"></a>  dust<span class="op">::</span>r<span class="op">::</span>dust_set_index<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> r_index<span class="op">);</span></span>
<span id="cb44-156"><a href="#cb44-156" tabindex="-1"></a>  <span class="cf">return</span> R_NilValue<span class="op">;</span></span>
<span id="cb44-157"><a href="#cb44-157" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-158"><a href="#cb44-158" tabindex="-1"></a></span>
<span id="cb44-159"><a href="#cb44-159" tabindex="-1"></a>SEXP dust_cpu_walk_update_state<span class="op">(</span>SEXP ptr<span class="op">,</span> SEXP r_pars<span class="op">,</span> SEXP r_state<span class="op">,</span></span>
<span id="cb44-160"><a href="#cb44-160" tabindex="-1"></a>                                           SEXP r_time<span class="op">,</span> SEXP r_set_initial_state<span class="op">,</span> SEXP index<span class="op">,</span> SEXP reset_step_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-161"><a href="#cb44-161" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_update_state<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> r_pars<span class="op">,</span> r_state<span class="op">,</span> r_time<span class="op">,</span></span>
<span id="cb44-162"><a href="#cb44-162" tabindex="-1"></a>                                                      r_set_initial_state<span class="op">,</span> index<span class="op">,</span> reset_step_size<span class="op">);</span></span>
<span id="cb44-163"><a href="#cb44-163" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-164"><a href="#cb44-164" tabindex="-1"></a></span>
<span id="cb44-165"><a href="#cb44-165" tabindex="-1"></a>SEXP dust_cpu_walk_state<span class="op">(</span>SEXP ptr<span class="op">,</span> SEXP r_index<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-166"><a href="#cb44-166" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_state<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> r_index<span class="op">);</span></span>
<span id="cb44-167"><a href="#cb44-167" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-168"><a href="#cb44-168" tabindex="-1"></a></span>
<span id="cb44-169"><a href="#cb44-169" tabindex="-1"></a>SEXP dust_cpu_walk_time<span class="op">(</span>SEXP ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-170"><a href="#cb44-170" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_time<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">);</span></span>
<span id="cb44-171"><a href="#cb44-171" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-172"><a href="#cb44-172" tabindex="-1"></a></span>
<span id="cb44-173"><a href="#cb44-173" tabindex="-1"></a><span class="dt">void</span> dust_cpu_walk_reorder<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>sexp r_index<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-174"><a href="#cb44-174" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_reorder<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> r_index<span class="op">);</span></span>
<span id="cb44-175"><a href="#cb44-175" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-176"><a href="#cb44-176" tabindex="-1"></a></span>
<span id="cb44-177"><a href="#cb44-177" tabindex="-1"></a>SEXP dust_cpu_walk_resample<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>doubles r_weights<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-178"><a href="#cb44-178" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_resample<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> r_weights<span class="op">);</span></span>
<span id="cb44-179"><a href="#cb44-179" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-180"><a href="#cb44-180" tabindex="-1"></a></span>
<span id="cb44-181"><a href="#cb44-181" tabindex="-1"></a>SEXP dust_cpu_walk_rng_state<span class="op">(</span>SEXP ptr<span class="op">,</span> <span class="dt">bool</span> first_only<span class="op">,</span> <span class="dt">bool</span> last_only<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-182"><a href="#cb44-182" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_rng_state<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> first_only<span class="op">,</span> last_only<span class="op">);</span></span>
<span id="cb44-183"><a href="#cb44-183" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-184"><a href="#cb44-184" tabindex="-1"></a></span>
<span id="cb44-185"><a href="#cb44-185" tabindex="-1"></a>SEXP dust_cpu_walk_set_rng_state<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>raws rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-186"><a href="#cb44-186" tabindex="-1"></a>  dust<span class="op">::</span>r<span class="op">::</span>dust_set_rng_state<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> rng_state<span class="op">);</span></span>
<span id="cb44-187"><a href="#cb44-187" tabindex="-1"></a>  <span class="cf">return</span> R_NilValue<span class="op">;</span></span>
<span id="cb44-188"><a href="#cb44-188" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-189"><a href="#cb44-189" tabindex="-1"></a></span>
<span id="cb44-190"><a href="#cb44-190" tabindex="-1"></a>SEXP dust_cpu_walk_set_data<span class="op">(</span>SEXP ptr<span class="op">,</span> cpp11<span class="op">::</span>list data<span class="op">,</span></span>
<span id="cb44-191"><a href="#cb44-191" tabindex="-1"></a>                                       <span class="dt">bool</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-192"><a href="#cb44-192" tabindex="-1"></a>  dust<span class="op">::</span>r<span class="op">::</span>dust_set_data<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> data<span class="op">,</span> shared<span class="op">);</span></span>
<span id="cb44-193"><a href="#cb44-193" tabindex="-1"></a>  <span class="cf">return</span> R_NilValue<span class="op">;</span></span>
<span id="cb44-194"><a href="#cb44-194" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-195"><a href="#cb44-195" tabindex="-1"></a></span>
<span id="cb44-196"><a href="#cb44-196" tabindex="-1"></a>SEXP dust_cpu_walk_compare_data<span class="op">(</span>SEXP ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-197"><a href="#cb44-197" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_compare_data<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">);</span></span>
<span id="cb44-198"><a href="#cb44-198" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-199"><a href="#cb44-199" tabindex="-1"></a></span>
<span id="cb44-200"><a href="#cb44-200" tabindex="-1"></a>SEXP dust_cpu_walk_filter<span class="op">(</span>SEXP ptr<span class="op">,</span> SEXP time_end<span class="op">,</span></span>
<span id="cb44-201"><a href="#cb44-201" tabindex="-1"></a>                                     <span class="dt">bool</span> save_trajectories<span class="op">,</span></span>
<span id="cb44-202"><a href="#cb44-202" tabindex="-1"></a>                                     cpp11<span class="op">::</span>sexp time_snapshot<span class="op">,</span></span>
<span id="cb44-203"><a href="#cb44-203" tabindex="-1"></a>                                     cpp11<span class="op">::</span>sexp min_log_likelihood<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-204"><a href="#cb44-204" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_filter<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> time_end<span class="op">,</span></span>
<span id="cb44-205"><a href="#cb44-205" tabindex="-1"></a>                                                save_trajectories<span class="op">,</span></span>
<span id="cb44-206"><a href="#cb44-206" tabindex="-1"></a>                                                time_snapshot<span class="op">,</span></span>
<span id="cb44-207"><a href="#cb44-207" tabindex="-1"></a>                                                min_log_likelihood<span class="op">);</span></span>
<span id="cb44-208"><a href="#cb44-208" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-209"><a href="#cb44-209" tabindex="-1"></a></span>
<span id="cb44-210"><a href="#cb44-210" tabindex="-1"></a><span class="dt">void</span> dust_cpu_walk_set_n_threads<span class="op">(</span>SEXP ptr<span class="op">,</span> <span class="dt">int</span> n_threads<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-211"><a href="#cb44-211" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_set_n_threads<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> n_threads<span class="op">);</span></span>
<span id="cb44-212"><a href="#cb44-212" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-213"><a href="#cb44-213" tabindex="-1"></a></span>
<span id="cb44-214"><a href="#cb44-214" tabindex="-1"></a><span class="dt">int</span> dust_cpu_walk_n_state<span class="op">(</span>SEXP ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-215"><a href="#cb44-215" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_n_state<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">);</span></span>
<span id="cb44-216"><a href="#cb44-216" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-217"><a href="#cb44-217" tabindex="-1"></a></span>
<span id="cb44-218"><a href="#cb44-218" tabindex="-1"></a><span class="dt">void</span> dust_cpu_walk_set_stochastic_schedule<span class="op">(</span>SEXP ptr<span class="op">,</span> SEXP time<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-219"><a href="#cb44-219" tabindex="-1"></a>  dust<span class="op">::</span>r<span class="op">::</span>dust_set_stochastic_schedule<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">,</span> time<span class="op">);</span></span>
<span id="cb44-220"><a href="#cb44-220" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-221"><a href="#cb44-221" tabindex="-1"></a></span>
<span id="cb44-222"><a href="#cb44-222" tabindex="-1"></a>SEXP dust_cpu_walk_ode_statistics<span class="op">(</span>SEXP ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-223"><a href="#cb44-223" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>r<span class="op">::</span>dust_ode_statistics<span class="op">&lt;</span>model_cpu<span class="op">&gt;(</span>ptr<span class="op">);</span></span>
<span id="cb44-224"><a href="#cb44-224" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The file <code>R/dust.R</code> contains the R interface generated by
dust with the constructor objects (all models’ constructors will be
collected into this file, which also should not be edited).</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Generated by dust (version 0.15.3) - do not edit</span></span>
<span><span class="va">walk</span> <span class="op">&lt;-</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span></span>
<span>  <span class="st">"dust"</span>,</span>
<span>  cloneable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span></span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    pars_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    pars_multi_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    index_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    info_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    n_threads_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    n_particles_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    n_particles_each_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    shape_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    ptr_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    gpu_config_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    ode_control_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    methods_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    param_ <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    reload_ <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span>,</span>
<span></span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span>, <span class="va">time</span>, <span class="va">n_particles</span>, <span class="va">n_threads</span> <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>                          <span class="va">seed</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">pars_multi</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                          <span class="va">deterministic</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                          <span class="va">gpu_config</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">ode_control</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">gpu_config</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">private</span><span class="op">$</span><span class="va">methods_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>           alloc <span class="op">=</span> <span class="va">dust_cpu_walk_alloc</span>,</span>
<span>           run <span class="op">=</span> <span class="va">dust_cpu_walk_run</span>,</span>
<span>           simulate <span class="op">=</span> <span class="va">dust_cpu_walk_simulate</span>,</span>
<span>           run_adjoint <span class="op">=</span> <span class="va">dust_cpu_walk_run_adjoint</span>,</span>
<span>           set_index <span class="op">=</span> <span class="va">dust_cpu_walk_set_index</span>,</span>
<span>           n_state <span class="op">=</span> <span class="va">dust_cpu_walk_n_state</span>,</span>
<span>           update_state <span class="op">=</span> <span class="va">dust_cpu_walk_update_state</span>,</span>
<span>           state <span class="op">=</span> <span class="va">dust_cpu_walk_state</span>,</span>
<span>           time <span class="op">=</span> <span class="va">dust_cpu_walk_time</span>,</span>
<span>           reorder <span class="op">=</span> <span class="va">dust_cpu_walk_reorder</span>,</span>
<span>           resample <span class="op">=</span> <span class="va">dust_cpu_walk_resample</span>,</span>
<span>           rng_state <span class="op">=</span> <span class="va">dust_cpu_walk_rng_state</span>,</span>
<span>           set_rng_state <span class="op">=</span> <span class="va">dust_cpu_walk_set_rng_state</span>,</span>
<span>           set_n_threads <span class="op">=</span> <span class="va">dust_cpu_walk_set_n_threads</span>,</span>
<span>           set_data <span class="op">=</span> <span class="va">dust_cpu_walk_set_data</span>,</span>
<span>           compare_data <span class="op">=</span> <span class="va">dust_cpu_walk_compare_data</span>,</span>
<span>           filter <span class="op">=</span> <span class="va">dust_cpu_walk_filter</span>,</span>
<span>           set_stochastic_schedule <span class="op">=</span> <span class="va">dust_cpu_walk_set_stochastic_schedule</span>,</span>
<span>           ode_statistics <span class="op">=</span> <span class="va">dust_cpu_walk_ode_statistics</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">private</span><span class="op">$</span><span class="va">methods_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alloc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"GPU support not enabled for this object"</span><span class="op">)</span></span>
<span>        <span class="op">}</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">alloc</span><span class="op">(</span><span class="va">pars</span>, <span class="va">pars_multi</span>, <span class="va">time</span>, <span class="va">n_particles</span>,</span>
<span>                        <span class="va">n_threads</span>, <span class="va">seed</span>, <span class="va">deterministic</span>, <span class="va">gpu_config</span>, <span class="va">ode_control</span><span class="op">)</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">pars_</span> <span class="op">&lt;-</span> <span class="va">pars</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">pars_multi_</span> <span class="op">&lt;-</span> <span class="va">pars_multi</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">n_threads_</span> <span class="op">&lt;-</span> <span class="va">n_threads</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">ptr_</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">[[</span><span class="fl">1L</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">info_</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">[[</span><span class="fl">2L</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">shape_</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">[[</span><span class="fl">3L</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">gpu_config_</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">[[</span><span class="fl">4L</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">ode_control_</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">[[</span><span class="fl">5L</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">n_particles_</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">shape_</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">pars_multi</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">private</span><span class="op">$</span><span class="va">n_particles_each_</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">n_particles_</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">private</span><span class="op">$</span><span class="va">n_particles_each_</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">n_particles_</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    name <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="st">"walk"</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    param <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">param_</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    run <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">time_end</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">m</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">time_end</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">index_</span><span class="op">)</span></span>
<span>      <span class="va">m</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    simulate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">time_end</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">m</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">time_end</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">index_</span><span class="op">)</span></span>
<span>      <span class="va">m</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    run_adjoint <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">run_adjoint</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span><span class="op">)</span></span>
<span>      <span class="co">## This approach may want to change, because it won't cope well</span></span>
<span>      <span class="co">## with cases where are gradient is structured with respect to</span></span>
<span>      <span class="co">## some parameters, but perhaps it's still a reasonable thing to</span></span>
<span>      <span class="co">## do? While we have array-free models it's fine though.</span></span>
<span>      <span class="va">nms</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">info_</span><span class="op">$</span><span class="va">adjoint</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">nms</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nms</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">gradient</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">gradient</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">nms</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">res</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    set_index <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">set_index</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">index</span><span class="op">)</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">index_</span> <span class="op">&lt;-</span> <span class="va">index</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    index <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">index_</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    ode_control <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">ode_control_</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    ode_statistics <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">ode_statistics</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    n_threads <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">n_threads_</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    n_state <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">n_state</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    n_particles <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">n_particles_</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    n_particles_each <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">n_particles_each_</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    shape <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">shape_</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    update_state <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pars</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">state</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">time</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                            <span class="va">set_initial_state</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">index</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                            <span class="va">reset_step_size</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">info</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">update_state</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">pars</span>, <span class="va">state</span>, <span class="va">time</span>,</span>
<span>                                          <span class="va">set_initial_state</span>, <span class="va">index</span>,</span>
<span>                                          <span class="va">reset_step_size</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">private</span><span class="op">$</span><span class="va">info_</span> <span class="op">&lt;-</span> <span class="va">info</span></span>
<span>        <span class="va">private</span><span class="op">$</span><span class="va">pars_</span> <span class="op">&lt;-</span> <span class="va">pars</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    state <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">m</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">index</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span></span>
<span>      <span class="va">m</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    time <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">time</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    set_stochastic_schedule <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">set_stochastic_schedule</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">time</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    reorder <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/mode.html" class="external-link">storage.mode</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"integer"</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">reorder</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">index</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    resample <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">weights</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">resample</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">weights</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    info <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">info_</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    pars <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">pars_</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    rng_state <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">first_only</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">last_only</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">rng_state</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">first_only</span>, <span class="va">last_only</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    set_rng_state <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">rng_state</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">set_rng_state</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">rng_state</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    has_openmp <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">dust_cpu_walk_capabilities</span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"openmp"</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    has_gpu_support <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">fake_gpu</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">fake_gpu</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="cn">FALSE</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="fu">dust_cpu_walk_capabilities</span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"gpu"</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    has_compare <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">dust_cpu_walk_capabilities</span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"compare"</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    real_size <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">dust_cpu_walk_capabilities</span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"real_size"</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    time_type <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">dust_cpu_walk_capabilities</span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"time_type"</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    rng_algorithm <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">dust_cpu_walk_capabilities</span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"rng_algorithm"</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    uses_gpu <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">fake_gpu</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">real_gpu</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">gpu_config_</span><span class="op">$</span><span class="va">real_gpu</span></span>
<span>      <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">real_gpu</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(</span><span class="va">fake_gpu</span> <span class="op">||</span> <span class="va">real_gpu</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    n_pars <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">pars_multi_</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">pars_</span><span class="op">)</span> <span class="kw">else</span> <span class="fl">0L</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    set_n_threads <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_threads</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">prev</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">n_threads_</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">set_n_threads</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">n_threads</span><span class="op">)</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">n_threads_</span> <span class="op">&lt;-</span> <span class="va">n_threads</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="va">prev</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    set_data <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">shared</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">data</span>, <span class="va">shared</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    compare_data <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">compare_data</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    filter <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">time_end</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">save_trajectories</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                      <span class="va">time_snapshot</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">min_log_likelihood</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">private</span><span class="op">$</span><span class="va">methods_</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">ptr_</span>, <span class="va">time_end</span>, <span class="va">save_trajectories</span>,</span>
<span>                              <span class="va">time_snapshot</span>, <span class="va">min_log_likelihood</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    gpu_info <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">ret</span> <span class="op">&lt;-</span> <span class="fu">dust_walk_gpu_info</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">ret</span><span class="op">$</span><span class="va">devices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">ret</span><span class="op">$</span><span class="va">devices</span>, stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>      <span class="va">parent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">parent.env</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">ret</span><span class="op">$</span><span class="va">has_cuda</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"private"</span>, <span class="va">parent</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">ret</span><span class="op">$</span><span class="va">config</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">gpu_config_</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="va">ret</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">walk</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dust_generator"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">walk</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Finally, <code>R/cpp11.R</code> and <code>src/cpp11.cpp</code> are
files created by cpp11 that should not be edited.</p>
<p>Your package can include as much R code as you want, and can be
developed like any other R package. But any time you change the code in
<code>inst/dust</code> you should rerun
<code><a href="../reference/dust_package.html">dust::dust_package()</a></code>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rich FitzJohn, Alex Hill, John Lees.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
