<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comparing models and data • dust</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Comparing models and data">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dust</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.15.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dust.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/design.html">Principles and design of dust</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Random numbers</li>
    <li>
      <a href="../articles/rng.html">Random number generation</a>
    </li>
    <li>
      <a href="../articles/rng_algorithms.html">Algorithms used to compute random numbers</a>
    </li>
    <li>
      <a href="../articles/rng_package.html">Using RNGs from packages</a>
    </li>
    <li>
      <a href="../articles/rng_distributed.html">Distributed parallel random numbers</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Dive deeper</li>
    <li>
      <a href="../articles/data.html">Comparing models and data</a>
    </li>
    <li>
      <a href="../articles/gpu.html">Running models on GPUs with CUDA</a>
    </li>
    <li>
      <a href="../articles/multi.html">Multiple parameter sets</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/dust/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Comparing models and data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/dust/blob/master/vignettes/data.Rmd" class="external-link"><code>vignettes/data.Rmd</code></a></small>
      <div class="hidden name"><code>data.Rmd</code></div>

    </div>

    
    
<p>One of our aims with <code>dust</code> was to enable the creation of
fast particle filters. Most of the high level interface for this is
within the package <a href="https://mrc-ide.github.io/mcstate/" class="external-link"><code>mcstate</code></a>.
Typically, when using a <code>dust</code> model with
<code>mcstate</code>, you would define a function in R which compares
the model state at some point in time to some data, returning a
likelihood.</p>
<p>It is possible to implement this comparison directly in the dust
model, which may slightly speed up the particle filter (because the
compare function will be evaluated in parallel, and because of slightly
reduced data copying), but also allows running the particle filter on a
GPU (see <code><a href="../articles/gpu.html">vignette("gpu")</a></code>).</p>
<p>This vignette outlines the steps in implementing the comparison
directly as part of the model. This is not required for basic use of
dust models, and we would typically recommend this only after your model
has stabilised and you are looking to extract potential additional
speed-ups or accelerate the model on a GPU.</p>
<p>We start with a simple example, a model of volatility</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">volatility</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="../reference/dust_example.html">dust_example</a></span><span class="op">(</span><span class="st">"volatility"</span><span class="op">)</span></span></code></pre></div>
<p>To demonstrate the approach, we simulate some data from the model
itself:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">local</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">volatility</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.91</span>, sigma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">1L</span>, seed <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>  <span class="va">mod</span><span class="op">$</span><span class="fu">update_state</span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">0</span>, <span class="fl">1L</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">simulate</span><span class="op">(</span><span class="va">times</span><span class="op">)</span></span>
<span>  <span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">times</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, observed <span class="op">=</span> <span class="va">observed</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   time   observed</span></span>
<span><span class="co">#&gt; 1    1  0.1103782</span></span>
<span><span class="co">#&gt; 2    2 -2.0313512</span></span>
<span><span class="co">#&gt; 3    3 -0.9031784</span></span>
<span><span class="co">#&gt; 4    4  0.7630234</span></span>
<span><span class="co">#&gt; 5    5  4.4891023</span></span>
<span><span class="co">#&gt; 6    6  1.3174224</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">~</span> <span class="va">time</span>, <span class="va">data</span>, type <span class="op">=</span> <span class="st">"o"</span>, pch <span class="op">=</span> <span class="fl">19</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="data_files/figure-html/volatility_data_create-1.png" width="700"></p>
<p>As in the <a href="https://mrc-ide.github.io/mcstate/articles/kalman.html" class="external-link"><code>mcstate</code>
vignette</a> we need some way of comparing model output to data. The
likelihood function used there is:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">volatility_compare</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">observed</span>, <span class="va">pars</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">observed</span>, <span class="va">pars</span><span class="op">$</span><span class="va">gamma</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span>, <span class="va">pars</span><span class="op">$</span><span class="va">tau</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>i.e., the probability is normally distributed with mean of the equal
to <code>gamma</code> multiplied by the modelled value, standard
deviation of <code>tau</code> and evaluated at the observed value. Our
aim here is to adapt this so that it is implemented as part of the C++
model. This requires:</p>
<ul>
<li>describing the types of the observed data at each time point in a
C++ struct (here it will be a single floating-point value, but the data
could be arbitrarily complicated)</li>
<li>implementing a method to do the comparison</li>
<li>describe how to marshal the data from R into this C++ structure</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">class</span> volatility <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">internal_type</span> <span class="op">=</span> dust<span class="op">::</span>no_internal<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">data_type</span> <span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>    <span class="dt">real_type</span> observed<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">shared_type</span> <span class="op">{</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    <span class="dt">real_type</span> alpha<span class="op">;</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    <span class="dt">real_type</span> sigma<span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>    <span class="dt">real_type</span> gamma<span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>    <span class="dt">real_type</span> tau<span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>    <span class="dt">real_type</span> x0<span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>  volatility<span class="op">(</span><span class="at">const</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>volatility<span class="op">&gt;&amp;</span> pars<span class="op">)</span> <span class="op">:</span> shared<span class="op">(</span>pars<span class="op">.</span>shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>  <span class="dt">size_t</span> size<span class="op">()</span> <span class="at">const</span> <span class="op">{</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> initial<span class="op">(</span><span class="dt">size_t</span> time<span class="op">,</span> <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> state<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>    state<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">-&gt;</span>x0<span class="op">;</span></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>    <span class="cf">return</span> state<span class="op">;</span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>  <span class="dt">void</span> update<span class="op">(</span><span class="dt">size_t</span> time<span class="op">,</span> <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a>              <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span> <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> x <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">-&gt;</span>alpha <span class="op">*</span> x <span class="op">+</span></span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a>      shared<span class="op">-&gt;</span>sigma <span class="op">*</span> dust<span class="op">::</span>random<span class="op">::</span>normal<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a>  <span class="dt">real_type</span> compare_data<span class="op">(</span><span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span> <span class="at">const</span> <span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>                         <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a>    <span class="cf">return</span> dust<span class="op">::</span>density<span class="op">::</span>normal<span class="op">(</span>data<span class="op">.</span>observed<span class="op">,</span> shared<span class="op">-&gt;</span>gamma <span class="op">*</span> state<span class="op">[</span><span class="dv">0</span><span class="op">],</span></span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a>                                 shared<span class="op">-&gt;</span>tau<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a>  dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>volatility<span class="op">&gt;</span> shared<span class="op">;</span></span>
<span id="cb4-47"><a href="#cb4-47" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb4-48"><a href="#cb4-48" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" tabindex="-1"></a><span class="co">// Helper function for accepting values with defaults</span></span>
<span id="cb4-50"><a href="#cb4-50" tabindex="-1"></a><span class="kw">inline</span> <span class="dt">double</span> with_default<span class="op">(</span><span class="dt">double</span> default_value<span class="op">,</span> cpp11<span class="op">::</span>sexp value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-51"><a href="#cb4-51" tabindex="-1"></a>  <span class="cf">return</span> value <span class="op">==</span> R_NilValue <span class="op">?</span> default_value <span class="op">:</span> cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>value<span class="op">);</span></span>
<span id="cb4-52"><a href="#cb4-52" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-53"><a href="#cb4-53" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" tabindex="-1"></a><span class="kw">namespace</span> dust <span class="op">{</span></span>
<span id="cb4-55"><a href="#cb4-55" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb4-57"><a href="#cb4-57" tabindex="-1"></a>dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>volatility<span class="op">&gt;</span> dust_pars<span class="op">&lt;</span>volatility<span class="op">&gt;(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-58"><a href="#cb4-58" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> volatility<span class="op">::</span><span class="dt">real_type</span><span class="op">;</span></span>
<span id="cb4-59"><a href="#cb4-59" tabindex="-1"></a>  <span class="dt">real_type</span> x0 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-60"><a href="#cb4-60" tabindex="-1"></a>  <span class="dt">real_type</span> alpha <span class="op">=</span> with_default<span class="op">(</span><span class="fl">0.91</span><span class="op">,</span> pars<span class="op">[</span><span class="st">"alpha"</span><span class="op">]);</span></span>
<span id="cb4-61"><a href="#cb4-61" tabindex="-1"></a>  <span class="dt">real_type</span> sigma <span class="op">=</span> with_default<span class="op">(</span><span class="dv">1</span><span class="op">,</span> pars<span class="op">[</span><span class="st">"sigma"</span><span class="op">]);</span></span>
<span id="cb4-62"><a href="#cb4-62" tabindex="-1"></a>  <span class="dt">real_type</span> gamma <span class="op">=</span> with_default<span class="op">(</span><span class="dv">1</span><span class="op">,</span> pars<span class="op">[</span><span class="st">"gamma"</span><span class="op">]);</span></span>
<span id="cb4-63"><a href="#cb4-63" tabindex="-1"></a>  <span class="dt">real_type</span> tau <span class="op">=</span> with_default<span class="op">(</span><span class="dv">1</span><span class="op">,</span> pars<span class="op">[</span><span class="st">"tau"</span><span class="op">]);</span></span>
<span id="cb4-64"><a href="#cb4-64" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" tabindex="-1"></a>  volatility<span class="op">::</span><span class="dt">shared_type</span> shared<span class="op">{</span>alpha<span class="op">,</span> sigma<span class="op">,</span> gamma<span class="op">,</span> tau<span class="op">,</span> x0<span class="op">};</span></span>
<span id="cb4-66"><a href="#cb4-66" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>volatility<span class="op">&gt;(</span>shared<span class="op">);</span></span>
<span id="cb4-67"><a href="#cb4-67" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-68"><a href="#cb4-68" tabindex="-1"></a></span>
<span id="cb4-69"><a href="#cb4-69" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb4-70"><a href="#cb4-70" tabindex="-1"></a>volatility<span class="op">::</span><span class="dt">data_type</span> dust_data<span class="op">&lt;</span>volatility<span class="op">&gt;(</span>cpp11<span class="op">::</span>list data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-71"><a href="#cb4-71" tabindex="-1"></a>  <span class="cf">return</span> volatility<span class="op">::</span><span class="dt">data_type</span><span class="op">{</span>cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>data<span class="op">[</span><span class="st">"observed"</span><span class="op">])};</span></span>
<span id="cb4-72"><a href="#cb4-72" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-73"><a href="#cb4-73" tabindex="-1"></a></span>
<span id="cb4-74"><a href="#cb4-74" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The first part, the data definition, is the definition</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">data_type</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    <span class="dt">real_type</span> observed<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="op">};</span></span></code></pre></div>
<p>which replaces the usual</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">data_type</span> <span class="op">=</span> dust<span class="op">::</span>no_data<span class="op">;</span></span></code></pre></div>
<p>This structure can contain whatever you want, including things like a
<code>std::vector</code> of values. In our use we’ve typically only had
<code>real_type</code> and <code>int</code> though, even for complex
models.</p>
<p>The comparison is implemented by the method
<code>compare_data</code>, which has a standard signature for the
function which takes the current state, the data at the current time
point, and the RNG state:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>  <span class="dt">real_type</span> compare_data<span class="op">(</span><span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span> <span class="at">const</span> <span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>                         <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="cf">return</span> dust<span class="op">::</span>density<span class="op">::</span>normal<span class="op">(</span>data<span class="op">.</span>observed<span class="op">,</span> shared<span class="op">-&gt;</span>gamma <span class="op">*</span> state<span class="op">[</span><span class="dv">0</span><span class="op">],</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>                                 shared<span class="op">-&gt;</span>tau<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>This looks very much like the R version above:</p>
<ul>
<li>
<code>dnorm</code> is replaced with the dust function
<code>dust::density::normal</code> (do not use R API functions here, as
this will be evaluated in a multi-threaded context)</li>
<li>the random number generator is available here, if your comparison is
itself stochastic</li>
<li>unlike the R version where the comparison returns a vector across
all particles, the C++ comparison is done for each particle</li>
</ul>
<p>Finally, the data marshalling is done by the <code>dust_data</code>
template, within the <code>dust</code> namespace</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">namespace</span> dust <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>volatility<span class="op">::</span><span class="dt">data_type</span> dust_data<span class="op">&lt;</span>volatility<span class="op">&gt;(</span>cpp11<span class="op">::</span>list data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>  <span class="cf">return</span> volatility<span class="op">::</span><span class="dt">data_type</span><span class="op">{</span>cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>data<span class="op">[</span><span class="st">"observed"</span><span class="op">])};</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Here, you can use any function you could use from <code>cpp11</code>,
much like within the <code>dust_pars</code> template specialisation. The
input will be a list, corresponding to the data <em>at a single time
point</em>. The data.frame above will first be processed with
<code><a href="../reference/dust_data.html">dust::dust_data</a></code>, so the first few entries look like:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="../reference/dust_data.html">dust_data</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [[1]][[1]]</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[1]][[2]]</span></span>
<span><span class="co">#&gt; [[1]][[2]]$time</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[1]][[2]]$observed</span></span>
<span><span class="co">#&gt; [1] 0.1103782</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [[2]][[1]]</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]][[2]]</span></span>
<span><span class="co">#&gt; [[2]][[2]]$time</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]][[2]]$observed</span></span>
<span><span class="co">#&gt; [1] -2.031351</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [[3]][[1]]</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]][[2]]</span></span>
<span><span class="co">#&gt; [[3]][[2]]$time</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]][[2]]$observed</span></span>
<span><span class="co">#&gt; [1] -0.9031784</span></span></code></pre></div>
<p>This is definitely a bit fiddly! If using <code>odin.dust</code>,
then this would be somewhat simplified as you could provide a single C++
file containing something like</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co">// [[odin.dust::compare_data(observed = real_type)]]</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co">// [[odin.dust::compare_function]]</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="kw">typename</span> T<span class="op">::</span><span class="dt">real_type</span> compare<span class="op">(</span><span class="at">const</span> <span class="kw">typename</span> T<span class="op">::</span><span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>                              <span class="at">const</span> <span class="kw">typename</span> T<span class="op">::</span><span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>                              <span class="at">const</span> <span class="kw">typename</span> T<span class="op">::</span><span class="dt">internal_type</span> internal<span class="op">,</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>                              <span class="bu">std::</span>shared_ptr<span class="op">&lt;</span><span class="at">const</span> <span class="kw">typename</span> T<span class="op">::</span><span class="dt">shared_type</span><span class="op">&gt;</span> shared<span class="op">,</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>                              <span class="kw">typename</span> T<span class="op">::</span><span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>density<span class="op">::</span>normal<span class="op">(</span>data<span class="op">.</span>observed<span class="op">,</span> odin<span class="op">(</span>gamma<span class="op">)</span> <span class="op">*</span> odin<span class="op">(</span>value<span class="op">),</span> </span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>                               odin<span class="op">(</span>tau<span class="op">),</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>and the correct code would be generated (the annotations above the
function are special to <code>odin.dust</code> and help it build the
interface, along with the <code>odin()</code> calls to locate quantities
within the data structure).</p>
<p>For other examples, see the contents of the files
<code>system.file("examples/sir.cpp", package = "dust")</code> and
<code>system.file("examples/sirs.cpp", package = "dust")</code>, which
are the basis of the <code>sir</code> and <code>sirs</code> models in
<code><a href="../reference/dust_example.html">dust::dust_example</a></code>.</p>
<p>Once set up, the compare function can be used. First, create the
model</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">volatility</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.91</span>, sigma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">30L</span><span class="op">)</span></span></code></pre></div>
<p>We can confirm that we can use this model to compare with data:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span><span class="op">$</span><span class="fu">has_compare</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Next, set data into the object:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span><span class="op">$</span><span class="fu">set_data</span><span class="op">(</span><span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="../reference/dust_data.html">dust_data</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>Then, run to any point in the data set:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>We can now compute the likelihood at this point:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span><span class="op">$</span><span class="fu">compare_data</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] -1.7749541 -1.0345513 -1.8936705 -1.1474220 -0.9295386 -0.9783803</span></span>
<span><span class="co">#&gt;  [7] -1.3348719 -0.9223977 -1.1359769 -0.9355476 -0.9313514 -0.9336573</span></span>
<span><span class="co">#&gt; [13] -0.9377093 -1.3693498 -1.8998954 -1.4925025 -1.0278387 -1.2607003</span></span>
<span><span class="co">#&gt; [19] -0.9346780 -1.0735853 -1.9865724 -1.0765077 -1.4273688 -0.9538040</span></span>
<span><span class="co">#&gt; [25] -0.9281353 -2.8361503 -1.1681388 -1.4124899 -1.1200041 -1.0057302</span></span></code></pre></div>
<p>This will line up with the R version:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">volatility_compare</span><span class="op">(</span><span class="va">y</span>, <span class="va">data</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>tau <span class="op">=</span> <span class="fl">1</span>, gamma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] -1.7749541 -1.0345513 -1.8936705 -1.1474220 -0.9295386 -0.9783803</span></span>
<span><span class="co">#&gt;  [7] -1.3348719 -0.9223977 -1.1359769 -0.9355476 -0.9313514 -0.9336573</span></span>
<span><span class="co">#&gt; [13] -0.9377093 -1.3693498 -1.8998954 -1.4925025 -1.0278387 -1.2607003</span></span>
<span><span class="co">#&gt; [19] -0.9346780 -1.0735853 -1.9865724 -1.0765077 -1.4273688 -0.9538040</span></span>
<span><span class="co">#&gt; [25] -0.9281353 -2.8361503 -1.1681388 -1.4124899 -1.1200041 -1.0057302</span></span></code></pre></div>
<p>You can also run a basic bootstrap particle filter using this
approach:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span><span class="op">$</span><span class="fu">update_state</span><span class="op">(</span>pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.91</span>, sigma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, time <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span>save_trajectories <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>This gives an overall likelihood:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span><span class="op">$</span><span class="va">log_likelihood</span></span>
<span><span class="co">#&gt; [1] -183.4612</span></span></code></pre></div>
<p>and, as we provided <code>save_trajectories = TRUE</code>, filtered
trajectories during the simulation:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">trajectories</span><span class="op">)</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"#00000022"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">observed</span> <span class="op">~</span> <span class="va">time</span>, <span class="va">data</span>, type <span class="op">=</span> <span class="st">"p"</span>, pch <span class="op">=</span> <span class="fl">19</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="data_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>Typically, you would use the much higher level interface in
<code>mcstate</code> for this, though.</p>
<p>Some additional work is required if you want to run the comparison on
a GPU, see <code><a href="../articles/gpu.html">vignette("gpu")</a></code> for more details.</p>
<div class="section level2">
<h2 id="coping-with-missing-data">Coping with missing data<a class="anchor" aria-label="anchor" href="#coping-with-missing-data"></a>
</h2>
<p>In the real-world, you will have missing data. If this is possible
then the data type for your input data <em>must</em> be
<code>real_type</code> (and not <code>int</code>, even if it is a
count), because you will want to use <code>std::isnan()</code> against
the data and this is only possibly <code>true</code> for floating point
types.</p>
<p>We expect that the likelihood will be a sum over components per data
stream. As such, in the case of missing input data, your likelihood for
that component should be exactly zero. This way if no data streams are
present all particles will return a likelihood of exactly zero. In the
case where this happens, the particle filter will not reorder
particles.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rich FitzJohn, Alex Hill, John Lees.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
