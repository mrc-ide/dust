<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running models on GPUs with CUDA • dust</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running models on GPUs with CUDA">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dust</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.15.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dust.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/design.html">Principles and design of dust</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Random numbers</li>
    <li>
      <a href="../articles/rng.html">Random number generation</a>
    </li>
    <li>
      <a href="../articles/rng_algorithms.html">Algorithms used to compute random numbers</a>
    </li>
    <li>
      <a href="../articles/rng_package.html">Using RNGs from packages</a>
    </li>
    <li>
      <a href="../articles/rng_distributed.html">Distributed parallel random numbers</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Dive deeper</li>
    <li>
      <a href="../articles/data.html">Comparing models and data</a>
    </li>
    <li>
      <a href="../articles/gpu.html">Running models on GPUs with CUDA</a>
    </li>
    <li>
      <a href="../articles/multi.html">Multiple parameter sets</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/dust/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Running models on GPUs with CUDA</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/dust/blob/master/vignettes/gpu.Rmd" class="external-link"><code>vignettes/gpu.Rmd</code></a></small>
      <div class="hidden name"><code>gpu.Rmd</code></div>

    </div>

    
    
<!-- DO NOT EDIT THIS FILE - see vignettes_src and make changes there -->
<p>With the core approach in dust, you can run models in parallel
efficiently up to the number of cores your workstation has available.
Getting more than 32 or 64 cores is hard though, and <code>dust</code>
provides no multi-node parallelism (e.g., <a href="https://en.wikipedia.org/wiki/Message_Passing_Interface" class="external-link">MPI</a>).
Instead, we have developed a system for running <code>dust</code> models
on GPUs (graphical processing units), specifically NVIDIA GPUs via CUDA
(Compute Unified Device Architecture).</p>
<p>This vignette is written in reverse-order, starting with how to run a
model on a GPU, before covering how to write a <code>dust</code> model
that can be run on a GPU. The reason for this is that we do not expect
that people will write these directly; instead we expect that most
people will use the <a href="https://mrc-ide.github.io/odin.dust/" class="external-link"><code>odin.dust</code></a>
package to generate these interfaces automatically, without having to
write a single line of C++ or CUDA code.</p>
<div class="section level2">
<h2 id="principles">Principles<a class="anchor" aria-label="anchor" href="#principles"></a>
</h2>
<ul>
<li>A GPU model can be run on the CPU, and vice-versa.</li>
<li>The same random number generator sequence will be used in both
cases.</li>
<li>Differences in results, if they exist, come from different
precision/rounding between compute platforms. When using
<code>real_type = double</code> we want to get the same results.</li>
<li>Just the model update can be defined for the GPU, and comparisons
and shuffling could still happen on the CPU. Defining a comparison
function is also possible, allowing a full particle filter run on a
GPU.</li>
</ul>
</div>
<div class="section level2">
<h2 id="running-a-model-with-gpu-support">Running a model with GPU support<a class="anchor" aria-label="anchor" href="#running-a-model-with-gpu-support"></a>
</h2>
<p>The <code>sirs</code> model includes GPU support, and will be the
focus of this vignette. However, the installed version cannot be run
directly on the GPU for a couple of reasons:</p>
<ul>
<li>this would complicate distribution of binaries as we’d depend on all
systems having a copy of the CUDA runtime</li>
<li>we would have to compile support for many possible GPU architectures
at once</li>
<li>it is very likely that we’d want to run the model in single
precision (<code>float</code>) mode rather than double precision
(<code>double</code>), and changing that requires re-compilation</li>
</ul>
<p>In addition, you will also need:</p>
<ul>
<li>CUDA toolkit v10.2 or higher, v11.1 or higher preferred (compile
time and run time)</li>
<li>CUDA capable GPU (run time)</li>
<li>nvidia drivers (run time)</li>
</ul>
<p>You can check with the command-line tool <code>nvidia-smi</code> if
you have suitable hardware and drivers and with
<code>dust::dust_cuda_configuration(quiet = FALSE, forget = TRUE)</code>
if you have suitable build tools.</p>
<p>So here, rather than using <code><a href="../reference/dust_example.html">dust::dust_example</a></code>, we
compile the model and pass in arguments:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/sirs.cpp"</span>, package <span class="op">=</span> <span class="st">"dust"</span><span class="op">)</span></span>
<span><span class="va">sirs</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="../reference/dust.html">dust</a></span><span class="op">(</span><span class="va">path</span>, gpu <span class="op">=</span> <span class="cn">TRUE</span>, real_type <span class="op">=</span> <span class="st">"float"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ 34 functions decorated with [[cpp11::register]]</span></span>
<span><span class="co">#&gt; ✔ generated file 'cpp11.R'</span></span>
<span><span class="co">#&gt; ✔ generated file 'cpp11.cpp'</span></span>
<span><span class="co">#&gt; Re-compiling sirs817bc717gpu</span></span>
<span><span class="co">#&gt;   ─  installing *source* package ‘sirs817bc717gpu’ ...</span></span>
<span><span class="co">#&gt;      ** using staged installation</span></span>
<span><span class="co">#&gt;      ** libs</span></span>
<span><span class="co">#&gt;      make[1]: Entering directory '/tmp/RtmppiOue1/fileb32bb676504e5/src'</span></span>
<span><span class="co">#&gt;      make[1]: Leaving directory '/tmp/RtmppiOue1/fileb32bb676504e5/src'</span></span>
<span><span class="co">#&gt;      make[1]: Entering directory '/tmp/RtmppiOue1/fileb32bb676504e5/src'</span></span>
<span><span class="co">#&gt;    g++ -std=gnu++14 -I"/usr/share/R/include" -DNDEBUG  -I'/home/rfitzjoh/lib/R/library/cpp11/include' -g -Wall -Wextra -pedantic -Wmaybe-uninitialized -Wno-unused-parameter -Wno-cast-function-type -Wno-missing-field-initializers -O2  -I/home/rfitzjoh/lib/R/library/dust/include -DHAVE_INLINE -fopenmp -fpic  -g -O2 -fdebug-prefix-map=/build/r-base-QwogzP/r-base-4.1.1=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2 -g  -c cpp11.cpp -o cpp11.o</span></span>
<span><span class="co">#&gt;      nvcc -std=c++14 -O2 -I. -I/usr/share/R/include -I/home/rfitzjoh/lib/R/library/dust/include -I/home/rfitzjoh/.local/share/R/dust/cub -I'/home/rfitzjoh/lib/R/library/cpp11/include' -gencode=arch=compute_75,code=sm_75 -Xcompiler -fPIC -Xcompiler -fopenmp -x cu -c dust.cu -o dust.o</span></span>
<span><span class="co">#&gt;      g++ -std=gnu++14 -shared -L/usr/lib/R/lib -Wl,-Bsymbolic-functions -Wl,-z,relro -o sirs817bc717gpu.so cpp11.o dust.o -lcudart -fopenmp -L/usr/lib/R/lib -lR</span></span>
<span><span class="co">#&gt;      make[1]: Leaving directory '/tmp/RtmppiOue1/fileb32bb676504e5/src'</span></span>
<span><span class="co">#&gt;      installing to /tmp/RtmppiOue1/devtools_install_b32bb69aa2d4d/00LOCK-fileb32bb676504e5/00new/sirs817bc717gpu/libs</span></span>
<span><span class="co">#&gt;      ** checking absolute paths in shared objects and dynamic libraries</span></span>
<span><span class="co">#&gt;   ─  DONE (sirs817bc717gpu)</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; ℹ Loading sirs817bc717gpu</span></span></code></pre></div>
<p>Notice in compilation that <code>nvcc</code> is used to compile the
model, rather than <code>g++</code> or <code>clang++</code>. The
additional option <code>-gencode=arch=compute_XX,code=sm_XX</code> was
added by <code>dust</code> and will include the CUDA compute version
supported by the graphics cards found on the current system. You can use
<code><a href="../reference/dust_cuda_options.html">dust::dust_cuda_options</a></code> to set additional options, passing
in the return value for the <code>gpu</code> argument above.</p>
<p>Once compiled with GPU support, the static method
<code>has_gpu_support</code> will report <code>TRUE</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sirs</span><span class="op">$</span><span class="va">public_methods</span><span class="op">$</span><span class="fu">has_gpu_support</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>and the static method <code>gpu_info</code> will report on the GPU
devices available:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sirs</span><span class="op">$</span><span class="va">public_methods</span><span class="op">$</span><span class="fu">gpu_info</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $has_cuda</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; $cuda_version</span></span>
<span><span class="co">#&gt; [1] '10.1.243'</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; $devices</span></span>
<span><span class="co">#&gt;   id                name   memory version</span></span>
<span><span class="co">#&gt; 1  0 GeForce RTX 2080 Ti 11016.31      75</span></span></code></pre></div>
<p>If you have more than one GPU, the <code>id</code> in the
<code>devices</code> section will be useful for targeting the correct
device.</p>
<p>The object is initialised as usual but with slight differences:</p>
<ul>
<li>you will probably want a (much) larger number of particles to take
advantage of your GPU. As a rule of thumb we would suggest at least
10,000, but depending on model and card you may still see per-particle
increases in compute speed as you use up to 1,000,000 particles. See
below for more discussion of this.</li>
<li>the <code>gpu_config</code> argument needs to be provided to
indicate which GPU device we are running on. Minimally this is an
integer indicating the device that you want to use (on this machine the
only option is <code>0</code>), but you can also provide a list with
elements <code>device_id</code> and <code>run_block_size</code>.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">n_particles</span> <span class="op">&lt;-</span> <span class="fl">8192</span></span>
<span><span class="va">model_gpu</span> <span class="op">&lt;-</span> <span class="va">sirs</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">pars</span>, <span class="fl">0</span>, <span class="va">n_particles</span>, gpu_config <span class="op">=</span> <span class="fl">0L</span>, seed <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span></code></pre></div>
<p>Once initialised, a model can only be run on either the GPU or CPU,
so we’ll create a CPU version here for comparison:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_cpu</span> <span class="op">&lt;-</span> <span class="va">sirs</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">pars</span>, <span class="fl">0</span>, <span class="va">n_particles</span>, seed <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span></code></pre></div>
<p>By leaving <code>gpu_config</code> as <code>NULL</code> we indicate
that the model should run on the CPU.</p>
<p>Once created, the <code>uses_gpu</code> method indicates if the model
is set up to run on the GPU (rather than CPU):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_gpu</span><span class="op">$</span><span class="fu">uses_gpu</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="va">model_cpu</span><span class="op">$</span><span class="fu">uses_gpu</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>Running the model on the CPU is fairly slow as this is a lot of
particles and we’re not running in parallel:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">t_cpu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">model_cpu</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">400</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed</span></span>
<span><span class="co">#&gt;   0.451   0.000   0.451</span></span></code></pre></div>
<p>Running the model on the GPU however:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">t_gpu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">model_gpu</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">400</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed</span></span>
<span><span class="co">#&gt;   0.008   0.000   0.008</span></span></code></pre></div>
<p>This is much faster! However, ~8,000 particles is unlikely to
saturate a modern GPU and (overhead-aside) this will run about as
quickly for potentially a hundred thousand particles. For example
running 2^17 (131,072) particles only takes a little longer</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_large</span> <span class="op">&lt;-</span> <span class="va">sirs</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">^</span><span class="fl">17</span>, gpu_config <span class="op">=</span> <span class="fl">0L</span>, seed <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">t_large</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">model_large</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">400</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed</span></span>
<span><span class="co">#&gt;   0.033   0.000   0.033</span></span></code></pre></div>
<p>This is <strong>heaps</strong> faster, the GPU model ran in 7.3% of
the time as the CPU model but simulated 16 times as many particles
(i.e., 219 times as fast per particle). With the relatively low times
here, much of this time is just moving the data around, and with over a
hundred thousand particles this is nontrivial. Of course, <em>doing</em>
anything quickly with all these particles is its own problem.</p>
<p>All methods will automatically run on the GPU; this includes
<code>run</code>, <code>simulate</code>, <code>compare_data</code> and
<code>filter</code>. The last two are typically used from the <a href="https://mrc-ide.github.io/mcstate/reference/particle_filter.html" class="external-link"><code>mcstate</code>
interface</a>.</p>
</div>
<div class="section level2">
<h2 id="writing-a-gpu-capable-model">Writing a GPU-capable model<a class="anchor" aria-label="anchor" href="#writing-a-gpu-capable-model"></a>
</h2>
<p>The sirs model from above:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">class</span> sirs <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="kw">public</span><span class="op">:</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> <span class="dt">double</span><span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">internal_type</span> <span class="op">=</span> dust<span class="op">::</span>no_internal<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>  <span class="co">// __align__(16) is required before the data_type definition when using NVCC</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>  <span class="co">// This is so when loaded into shared memory it is aligned correctly</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>  <span class="kw">struct</span> __align__<span class="op">(</span><span class="dv">16</span><span class="op">)</span> <span class="dt">data_type</span> <span class="op">{</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>    <span class="dt">double</span> incidence<span class="op">;</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  <span class="kw">struct</span> <span class="dt">shared_type</span> <span class="op">{</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>    <span class="dt">real_type</span> S0<span class="op">;</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>    <span class="dt">real_type</span> I0<span class="op">;</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>    <span class="dt">real_type</span> R0<span class="op">;</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>    <span class="dt">real_type</span> alpha<span class="op">;</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>    <span class="dt">real_type</span> beta<span class="op">;</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>    <span class="dt">real_type</span> gamma<span class="op">;</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>    <span class="dt">real_type</span> dt<span class="op">;</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>    <span class="dt">size_t</span> freq<span class="op">;</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>    <span class="dt">real_type</span> exp_noise<span class="op">;</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>  sirs<span class="op">(</span><span class="at">const</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>sirs<span class="op">&gt;&amp;</span> pars<span class="op">):</span> shared<span class="op">(</span>pars<span class="op">.</span>shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>  <span class="dt">size_t</span> size<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> initial<span class="op">(</span><span class="dt">size_t</span> time<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> state<span class="op">(</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>    state<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">-&gt;</span>S0<span class="op">;</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a>    state<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">-&gt;</span>I0<span class="op">;</span></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a>    state<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">-&gt;</span>R0<span class="op">;</span></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a>    state<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a>    <span class="cf">return</span> state<span class="op">;</span></span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a>  <span class="dt">void</span> update<span class="op">(</span><span class="dt">size_t</span> time<span class="op">,</span> <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span> <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a>              <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a>    <span class="dt">real_type</span> S <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a>    <span class="dt">real_type</span> I <span class="op">=</span> state<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a>    <span class="dt">real_type</span> R <span class="op">=</span> state<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a>    <span class="dt">real_type</span> N <span class="op">=</span> S <span class="op">+</span> I <span class="op">+</span> R<span class="op">;</span></span>
<span id="cb10-47"><a href="#cb10-47" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" tabindex="-1"></a>    <span class="dt">real_type</span> p_SI <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> exp<span class="op">(-</span> shared<span class="op">-&gt;</span>beta <span class="op">*</span> I <span class="op">/</span> N<span class="op">);</span></span>
<span id="cb10-49"><a href="#cb10-49" tabindex="-1"></a>    <span class="dt">real_type</span> p_IR <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> exp<span class="op">(-(</span>shared<span class="op">-&gt;</span>gamma<span class="op">));</span></span>
<span id="cb10-50"><a href="#cb10-50" tabindex="-1"></a>    <span class="dt">real_type</span> p_RS <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> exp<span class="op">(-</span> shared<span class="op">-&gt;</span>alpha<span class="op">);</span></span>
<span id="cb10-51"><a href="#cb10-51" tabindex="-1"></a></span>
<span id="cb10-52"><a href="#cb10-52" tabindex="-1"></a>    <span class="dt">real_type</span> dt <span class="op">=</span> shared<span class="op">-&gt;</span>dt<span class="op">;</span></span>
<span id="cb10-53"><a href="#cb10-53" tabindex="-1"></a>    <span class="dt">real_type</span> n_SI <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> S<span class="op">,</span> p_SI <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb10-54"><a href="#cb10-54" tabindex="-1"></a>    <span class="dt">real_type</span> n_IR <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> I<span class="op">,</span> p_IR <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb10-55"><a href="#cb10-55" tabindex="-1"></a>    <span class="dt">real_type</span> n_RS <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> R<span class="op">,</span> p_RS <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb10-56"><a href="#cb10-56" tabindex="-1"></a></span>
<span id="cb10-57"><a href="#cb10-57" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> S <span class="op">-</span> n_SI <span class="op">+</span> n_RS<span class="op">;</span></span>
<span id="cb10-58"><a href="#cb10-58" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> I <span class="op">+</span> n_SI <span class="op">-</span> n_IR<span class="op">;</span></span>
<span id="cb10-59"><a href="#cb10-59" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> R <span class="op">+</span> n_IR <span class="op">-</span> n_RS<span class="op">;</span></span>
<span id="cb10-60"><a href="#cb10-60" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span>time <span class="op">%</span> shared<span class="op">-&gt;</span>freq <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> n_SI <span class="op">:</span> state<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">+</span> n_SI<span class="op">;</span></span>
<span id="cb10-61"><a href="#cb10-61" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-62"><a href="#cb10-62" tabindex="-1"></a></span>
<span id="cb10-63"><a href="#cb10-63" tabindex="-1"></a>  <span class="dt">real_type</span> compare_data<span class="op">(</span><span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span> <span class="at">const</span> <span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb10-64"><a href="#cb10-64" tabindex="-1"></a>                         <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-65"><a href="#cb10-65" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> incidence_modelled <span class="op">=</span> state<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb10-66"><a href="#cb10-66" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> incidence_observed <span class="op">=</span> data<span class="op">.</span>incidence<span class="op">;</span></span>
<span id="cb10-67"><a href="#cb10-67" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> lambda <span class="op">=</span> incidence_modelled <span class="op">+</span></span>
<span id="cb10-68"><a href="#cb10-68" tabindex="-1"></a>      dust<span class="op">::</span>random<span class="op">::</span>exponential<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> shared<span class="op">-&gt;</span>exp_noise<span class="op">);</span></span>
<span id="cb10-69"><a href="#cb10-69" tabindex="-1"></a>    <span class="cf">return</span> dust<span class="op">::</span>density<span class="op">::</span>poisson<span class="op">(</span>incidence_observed<span class="op">,</span> lambda<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb10-70"><a href="#cb10-70" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-71"><a href="#cb10-71" tabindex="-1"></a></span>
<span id="cb10-72"><a href="#cb10-72" tabindex="-1"></a><span class="kw">private</span><span class="op">:</span></span>
<span id="cb10-73"><a href="#cb10-73" tabindex="-1"></a>  dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>sirs<span class="op">&gt;</span> shared<span class="op">;</span></span>
<span id="cb10-74"><a href="#cb10-74" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb10-75"><a href="#cb10-75" tabindex="-1"></a></span>
<span id="cb10-76"><a href="#cb10-76" tabindex="-1"></a><span class="co">// Helper function for accepting values with defaults</span></span>
<span id="cb10-77"><a href="#cb10-77" tabindex="-1"></a><span class="kw">inline</span> <span class="dt">double</span> with_default<span class="op">(</span><span class="dt">double</span> default_value<span class="op">,</span> cpp11<span class="op">::</span>sexp value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-78"><a href="#cb10-78" tabindex="-1"></a>  <span class="cf">return</span> value <span class="op">==</span> R_NilValue <span class="op">?</span> default_value <span class="op">:</span> cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>value<span class="op">);</span></span>
<span id="cb10-79"><a href="#cb10-79" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-80"><a href="#cb10-80" tabindex="-1"></a></span>
<span id="cb10-81"><a href="#cb10-81" tabindex="-1"></a><span class="kw">namespace</span> dust <span class="op">{</span></span>
<span id="cb10-82"><a href="#cb10-82" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb10-83"><a href="#cb10-83" tabindex="-1"></a>dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>sirs<span class="op">&gt;</span> dust_pars<span class="op">&lt;</span>sirs<span class="op">&gt;(</span>cpp11<span class="op">::</span>list pars<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-84"><a href="#cb10-84" tabindex="-1"></a>  <span class="co">// Initial state values</span></span>
<span id="cb10-85"><a href="#cb10-85" tabindex="-1"></a>  sirs<span class="op">::</span><span class="dt">real_type</span> I0 <span class="op">=</span> <span class="fl">10.0</span><span class="op">;</span></span>
<span id="cb10-86"><a href="#cb10-86" tabindex="-1"></a>  sirs<span class="op">::</span><span class="dt">real_type</span> S0 <span class="op">=</span> <span class="fl">1000.0</span><span class="op">;</span></span>
<span id="cb10-87"><a href="#cb10-87" tabindex="-1"></a>  sirs<span class="op">::</span><span class="dt">real_type</span> R0 <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb10-88"><a href="#cb10-88" tabindex="-1"></a></span>
<span id="cb10-89"><a href="#cb10-89" tabindex="-1"></a>  <span class="co">// Time scaling</span></span>
<span id="cb10-90"><a href="#cb10-90" tabindex="-1"></a>  <span class="co">// [[dust::param(freq, required = FALSE, default = 1)]]</span></span>
<span id="cb10-91"><a href="#cb10-91" tabindex="-1"></a>  <span class="dt">size_t</span> freq <span class="op">=</span> <span class="bu">std::</span>max<span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> with_default<span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> pars<span class="op">[</span><span class="st">"freq"</span><span class="op">]));</span></span>
<span id="cb10-92"><a href="#cb10-92" tabindex="-1"></a>  sirs<span class="op">::</span><span class="dt">real_type</span> dt <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> <span class="kw">static_cast</span><span class="op">&lt;</span>sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;(</span>freq<span class="op">);</span></span>
<span id="cb10-93"><a href="#cb10-93" tabindex="-1"></a></span>
<span id="cb10-94"><a href="#cb10-94" tabindex="-1"></a>  sirs<span class="op">::</span><span class="dt">real_type</span> exp_noise <span class="op">=</span> <span class="fl">1e6</span><span class="op">;</span></span>
<span id="cb10-95"><a href="#cb10-95" tabindex="-1"></a></span>
<span id="cb10-96"><a href="#cb10-96" tabindex="-1"></a>  <span class="co">// [[dust::param(alpha, required = FALSE, default = 0.1)]]</span></span>
<span id="cb10-97"><a href="#cb10-97" tabindex="-1"></a>  sirs<span class="op">::</span><span class="dt">real_type</span> alpha <span class="op">=</span> with_default<span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> pars<span class="op">[</span><span class="st">"alpha"</span><span class="op">]);</span></span>
<span id="cb10-98"><a href="#cb10-98" tabindex="-1"></a></span>
<span id="cb10-99"><a href="#cb10-99" tabindex="-1"></a>  <span class="co">// [[dust::param(beta, required = FALSE, default = 0.2)]]</span></span>
<span id="cb10-100"><a href="#cb10-100" tabindex="-1"></a>  sirs<span class="op">::</span><span class="dt">real_type</span> beta <span class="op">=</span> with_default<span class="op">(</span><span class="fl">0.2</span><span class="op">,</span> pars<span class="op">[</span><span class="st">"beta"</span><span class="op">]);</span></span>
<span id="cb10-101"><a href="#cb10-101" tabindex="-1"></a></span>
<span id="cb10-102"><a href="#cb10-102" tabindex="-1"></a>  <span class="co">// [[dust::param(gamma, required = FALSE, default = 0.1)]]</span></span>
<span id="cb10-103"><a href="#cb10-103" tabindex="-1"></a>  sirs<span class="op">::</span><span class="dt">real_type</span> gamma <span class="op">=</span> with_default<span class="op">(</span><span class="fl">0.1</span><span class="op">,</span> pars<span class="op">[</span><span class="st">"gamma"</span><span class="op">]);</span></span>
<span id="cb10-104"><a href="#cb10-104" tabindex="-1"></a></span>
<span id="cb10-105"><a href="#cb10-105" tabindex="-1"></a>  sirs<span class="op">::</span><span class="dt">shared_type</span> shared<span class="op">{</span>S0<span class="op">,</span> I0<span class="op">,</span> R0<span class="op">,</span> alpha<span class="op">,</span> beta<span class="op">,</span> gamma<span class="op">,</span> dt<span class="op">,</span> freq<span class="op">,</span> exp_noise<span class="op">};</span></span>
<span id="cb10-106"><a href="#cb10-106" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span><span class="dt">pars_type</span><span class="op">&lt;</span>sirs<span class="op">&gt;(</span>shared<span class="op">);</span></span>
<span id="cb10-107"><a href="#cb10-107" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-108"><a href="#cb10-108" tabindex="-1"></a></span>
<span id="cb10-109"><a href="#cb10-109" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb10-110"><a href="#cb10-110" tabindex="-1"></a>sirs<span class="op">::</span><span class="dt">data_type</span> dust_data<span class="op">&lt;</span>sirs<span class="op">&gt;(</span>cpp11<span class="op">::</span>list data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-111"><a href="#cb10-111" tabindex="-1"></a>  <span class="cf">return</span> sirs<span class="op">::</span><span class="dt">data_type</span><span class="op">{</span>cpp11<span class="op">::</span>as_cpp<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>data<span class="op">[</span><span class="st">"incidence"</span><span class="op">])};</span></span>
<span id="cb10-112"><a href="#cb10-112" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-113"><a href="#cb10-113" tabindex="-1"></a></span>
<span id="cb10-114"><a href="#cb10-114" tabindex="-1"></a><span class="kw">namespace</span> gpu <span class="op">{</span></span>
<span id="cb10-115"><a href="#cb10-115" tabindex="-1"></a></span>
<span id="cb10-116"><a href="#cb10-116" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb10-117"><a href="#cb10-117" tabindex="-1"></a><span class="dt">size_t</span> shared_int_size<span class="op">&lt;</span>sirs<span class="op">&gt;(</span>dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>sirs<span class="op">&gt;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-118"><a href="#cb10-118" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb10-119"><a href="#cb10-119" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-120"><a href="#cb10-120" tabindex="-1"></a></span>
<span id="cb10-121"><a href="#cb10-121" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb10-122"><a href="#cb10-122" tabindex="-1"></a><span class="dt">size_t</span> shared_real_size<span class="op">&lt;</span>sirs<span class="op">&gt;(</span>dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>sirs<span class="op">&gt;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-123"><a href="#cb10-123" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb10-124"><a href="#cb10-124" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-125"><a href="#cb10-125" tabindex="-1"></a></span>
<span id="cb10-126"><a href="#cb10-126" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb10-127"><a href="#cb10-127" tabindex="-1"></a><span class="dt">void</span> shared_copy<span class="op">&lt;</span>sirs<span class="op">&gt;(</span>dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>sirs<span class="op">&gt;</span> shared<span class="op">,</span></span>
<span id="cb10-128"><a href="#cb10-128" tabindex="-1"></a>                       <span class="dt">int</span> <span class="op">*</span> shared_int<span class="op">,</span></span>
<span id="cb10-129"><a href="#cb10-129" tabindex="-1"></a>                       sirs<span class="op">::</span><span class="dt">real_type</span> <span class="op">*</span> shared_real<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-130"><a href="#cb10-130" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">;</span></span>
<span id="cb10-131"><a href="#cb10-131" tabindex="-1"></a>  <span class="kw">using</span> dust<span class="op">::</span>gpu<span class="op">::</span>shared_copy_data<span class="op">;</span></span>
<span id="cb10-132"><a href="#cb10-132" tabindex="-1"></a>  shared_real <span class="op">=</span> shared_copy_data<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>shared_real<span class="op">,</span> shared<span class="op">-&gt;</span>alpha<span class="op">);</span></span>
<span id="cb10-133"><a href="#cb10-133" tabindex="-1"></a>  shared_real <span class="op">=</span> shared_copy_data<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>shared_real<span class="op">,</span> shared<span class="op">-&gt;</span>beta<span class="op">);</span></span>
<span id="cb10-134"><a href="#cb10-134" tabindex="-1"></a>  shared_real <span class="op">=</span> shared_copy_data<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>shared_real<span class="op">,</span> shared<span class="op">-&gt;</span>gamma<span class="op">);</span></span>
<span id="cb10-135"><a href="#cb10-135" tabindex="-1"></a>  shared_real <span class="op">=</span> shared_copy_data<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>shared_real<span class="op">,</span> shared<span class="op">-&gt;</span>dt<span class="op">);</span></span>
<span id="cb10-136"><a href="#cb10-136" tabindex="-1"></a>  shared_real <span class="op">=</span> shared_copy_data<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>shared_real<span class="op">,</span> shared<span class="op">-&gt;</span>exp_noise<span class="op">);</span></span>
<span id="cb10-137"><a href="#cb10-137" tabindex="-1"></a>  shared_int <span class="op">=</span> shared_copy_data<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span>shared_int<span class="op">,</span> shared<span class="op">-&gt;</span>freq<span class="op">);</span></span>
<span id="cb10-138"><a href="#cb10-138" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-139"><a href="#cb10-139" tabindex="-1"></a></span>
<span id="cb10-140"><a href="#cb10-140" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb10-141"><a href="#cb10-141" tabindex="-1"></a>__device__</span>
<span id="cb10-142"><a href="#cb10-142" tabindex="-1"></a><span class="dt">void</span> update_gpu<span class="op">&lt;</span>sirs<span class="op">&gt;(</span><span class="dt">size_t</span> time<span class="op">,</span></span>
<span id="cb10-143"><a href="#cb10-143" tabindex="-1"></a>                      <span class="at">const</span> dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span>sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;</span> state<span class="op">,</span></span>
<span id="cb10-144"><a href="#cb10-144" tabindex="-1"></a>                      dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> internal_int<span class="op">,</span></span>
<span id="cb10-145"><a href="#cb10-145" tabindex="-1"></a>                      dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span>sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;</span> internal_real<span class="op">,</span></span>
<span id="cb10-146"><a href="#cb10-146" tabindex="-1"></a>                      <span class="at">const</span> <span class="dt">int</span> <span class="op">*</span> shared_int<span class="op">,</span></span>
<span id="cb10-147"><a href="#cb10-147" tabindex="-1"></a>                      <span class="at">const</span> sirs<span class="op">::</span><span class="dt">real_type</span> <span class="op">*</span> shared_real<span class="op">,</span></span>
<span id="cb10-148"><a href="#cb10-148" tabindex="-1"></a>                      sirs<span class="op">::</span><span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb10-149"><a href="#cb10-149" tabindex="-1"></a>                      dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span>sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-150"><a href="#cb10-150" tabindex="-1"></a>  <span class="kw">using</span> dust<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">;</span></span>
<span id="cb10-151"><a href="#cb10-151" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">;</span></span>
<span id="cb10-152"><a href="#cb10-152" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> alpha <span class="op">=</span> shared_real<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb10-153"><a href="#cb10-153" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> beta <span class="op">=</span> shared_real<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb10-154"><a href="#cb10-154" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> gamma <span class="op">=</span> shared_real<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb10-155"><a href="#cb10-155" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> dt <span class="op">=</span> shared_real<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb10-156"><a href="#cb10-156" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> freq <span class="op">=</span> shared_int<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb10-157"><a href="#cb10-157" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> S <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb10-158"><a href="#cb10-158" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> I <span class="op">=</span> state<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb10-159"><a href="#cb10-159" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> R <span class="op">=</span> state<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb10-160"><a href="#cb10-160" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> N <span class="op">=</span> S <span class="op">+</span> I <span class="op">+</span> R<span class="op">;</span></span>
<span id="cb10-161"><a href="#cb10-161" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> p_SI <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> exp<span class="op">(-</span> beta <span class="op">*</span> I <span class="op">/</span> N<span class="op">);</span></span>
<span id="cb10-162"><a href="#cb10-162" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> p_IR <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> exp<span class="op">(-</span> gamma<span class="op">);</span></span>
<span id="cb10-163"><a href="#cb10-163" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> p_RS <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> exp<span class="op">(-</span> alpha<span class="op">);</span></span>
<span id="cb10-164"><a href="#cb10-164" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> n_SI <span class="op">=</span> binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> S<span class="op">,</span> p_SI <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb10-165"><a href="#cb10-165" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> n_IR <span class="op">=</span> binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> I<span class="op">,</span> p_IR <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb10-166"><a href="#cb10-166" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> n_RS <span class="op">=</span> binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> R<span class="op">,</span> p_RS <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb10-167"><a href="#cb10-167" tabindex="-1"></a>  state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> S <span class="op">-</span> n_SI <span class="op">+</span> n_RS<span class="op">;</span></span>
<span id="cb10-168"><a href="#cb10-168" tabindex="-1"></a>  state_next<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> I <span class="op">+</span> n_SI <span class="op">-</span> n_IR<span class="op">;</span></span>
<span id="cb10-169"><a href="#cb10-169" tabindex="-1"></a>  state_next<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> R <span class="op">+</span> n_IR <span class="op">-</span> n_RS<span class="op">;</span></span>
<span id="cb10-170"><a href="#cb10-170" tabindex="-1"></a>  state_next<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span>time <span class="op">%</span> freq <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> n_SI <span class="op">:</span> state<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">+</span> n_SI<span class="op">;</span></span>
<span id="cb10-171"><a href="#cb10-171" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-172"><a href="#cb10-172" tabindex="-1"></a></span>
<span id="cb10-173"><a href="#cb10-173" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb10-174"><a href="#cb10-174" tabindex="-1"></a>__device__</span>
<span id="cb10-175"><a href="#cb10-175" tabindex="-1"></a>sirs<span class="op">::</span><span class="dt">real_type</span> compare_gpu<span class="op">&lt;</span>sirs<span class="op">&gt;(</span><span class="at">const</span> dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span>sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;</span> state<span class="op">,</span></span>
<span id="cb10-176"><a href="#cb10-176" tabindex="-1"></a>                                  <span class="at">const</span> sirs<span class="op">::</span><span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb10-177"><a href="#cb10-177" tabindex="-1"></a>                                  dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> internal_int<span class="op">,</span></span>
<span id="cb10-178"><a href="#cb10-178" tabindex="-1"></a>                                  dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span>sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;</span> internal_real<span class="op">,</span></span>
<span id="cb10-179"><a href="#cb10-179" tabindex="-1"></a>                                  <span class="at">const</span> <span class="dt">int</span> <span class="op">*</span> shared_int<span class="op">,</span></span>
<span id="cb10-180"><a href="#cb10-180" tabindex="-1"></a>                                  <span class="at">const</span> sirs<span class="op">::</span><span class="dt">real_type</span> <span class="op">*</span> shared_real<span class="op">,</span></span>
<span id="cb10-181"><a href="#cb10-181" tabindex="-1"></a>                                  sirs<span class="op">::</span><span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-182"><a href="#cb10-182" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">;</span></span>
<span id="cb10-183"><a href="#cb10-183" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> exp_noise <span class="op">=</span> shared_real<span class="op">[</span><span class="dv">4</span><span class="op">];</span></span>
<span id="cb10-184"><a href="#cb10-184" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> incidence_modelled <span class="op">=</span> state<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb10-185"><a href="#cb10-185" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> incidence_observed <span class="op">=</span> data<span class="op">.</span>incidence<span class="op">;</span></span>
<span id="cb10-186"><a href="#cb10-186" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> lambda <span class="op">=</span> incidence_modelled <span class="op">+</span></span>
<span id="cb10-187"><a href="#cb10-187" tabindex="-1"></a>    dust<span class="op">::</span>random<span class="op">::</span>exponential<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> exp_noise<span class="op">);</span></span>
<span id="cb10-188"><a href="#cb10-188" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>density<span class="op">::</span>poisson<span class="op">(</span>incidence_observed<span class="op">,</span> lambda<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb10-189"><a href="#cb10-189" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-190"><a href="#cb10-190" tabindex="-1"></a></span>
<span id="cb10-191"><a href="#cb10-191" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-192"><a href="#cb10-192" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This is somewhat more complicated than the models described in
<code>vignette("dust.Rmd")</code>. There are several important
components required to run on the GPU.</p>
<p>Within the <code>dust::gpu</code> namespace, we declare the size of
the <em>shared parameters</em> for the model. These are parameters that
will be the same across all instances of a parameter set, as opposed to
quantities that change between particles.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="kw">namespace</span> dust <span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="kw">namespace</span> gpu <span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="dt">size_t</span> shared_int_size<span class="op">&lt;</span>sirs<span class="op">&gt;(</span>dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>sirs<span class="op">&gt;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="dt">size_t</span> shared_real_size<span class="op">&lt;</span>sirs<span class="op">&gt;(</span>dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>sirs<span class="op">&gt;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>These can be omitted if your model has no such parameters.</p>
<p>The next definition makes the above a bit clearer, it defines the
method for copying these parameters</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="kw">namespace</span> dust <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="kw">namespace</span> gpu <span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="dt">void</span> shared_copy<span class="op">&lt;</span>sirs<span class="op">&gt;(</span>dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>sirs<span class="op">&gt;</span> shared<span class="op">,</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>                       <span class="dt">int</span> <span class="op">*</span> shared_int<span class="op">,</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>                       sirs<span class="op">::</span><span class="dt">real_type</span> <span class="op">*</span> shared_real<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">;</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>  <span class="kw">using</span> dust<span class="op">::</span>gpu<span class="op">::</span>shared_copy_data<span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>  shared_real <span class="op">=</span> shared_copy_data<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>shared_real<span class="op">,</span> shared<span class="op">-&gt;</span>alpha<span class="op">);</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  shared_real <span class="op">=</span> shared_copy_data<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>shared_real<span class="op">,</span> shared<span class="op">-&gt;</span>beta<span class="op">);</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  shared_real <span class="op">=</span> shared_copy_data<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>shared_real<span class="op">,</span> shared<span class="op">-&gt;</span>gamma<span class="op">);</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>  shared_real <span class="op">=</span> shared_copy_data<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>shared_real<span class="op">,</span> shared<span class="op">-&gt;</span>dt<span class="op">);</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>  shared_real <span class="op">=</span> shared_copy_data<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>shared_real<span class="op">,</span> shared<span class="op">-&gt;</span>exp_noise<span class="op">);</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>  shared_int <span class="op">=</span> shared_copy_data<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span>shared_int<span class="op">,</span> shared<span class="op">-&gt;</span>freq<span class="op">);</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In the CPU version of the model we have a nice smart pointer to a
struct (<code>dust::shared_ptr&lt;sirs&gt;</code>) from which we can
access parameters by name (e.g., <code>shared-&gt;alpha</code>). No such
niceties in CUDA where we need access to a single contiguous block of
memory. The <code>dust::shared_copy_data</code> is a small utility to
make the bookkeeping here a bit easier, but this could have been written
out as:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">namespace</span> dust <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="dt">void</span> shared_copy<span class="op">&lt;</span>sirs<span class="op">&gt;(</span>dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>sirs<span class="op">&gt;</span> shared<span class="op">,</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>                       <span class="dt">int</span> <span class="op">*</span> shared_int<span class="op">,</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>                       sirs<span class="op">::</span><span class="dt">real_type</span> <span class="op">*</span> shared_real<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">;</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>  shared_real<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">-&gt;</span>alpha<span class="op">;</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>  shared_real<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">-&gt;</span>beta<span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  shared_real<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">-&gt;</span>gamma<span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>  shared_real<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">-&gt;</span>dt<span class="op">;</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>  shared_real<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">-&gt;</span>exp_noise<span class="op">;</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>  shared_int<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> shared<span class="op">-&gt;</span>freq<span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <code>dust::shared_copy_data</code> template has specialisations
where the object being copied is a vector.</p>
<p>There are two methods that are not used here, but could be included,
to define the size of per-particle internal storage space. This is
required if your model needs to store intermediate calculations during
the <code>update</code> time if those will not fit on the stack.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">namespace</span> dust <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="kw">namespace</span> gpu <span class="op">{</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="dt">size_t</span> dust<span class="op">::</span>internal_real_size<span class="op">&lt;</span>sirs<span class="op">&gt;(</span>dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>sirs<span class="op">&gt;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="dt">size_t</span> dust<span class="op">::</span>internal_int_size<span class="op">&lt;</span>sirs<span class="op">&gt;(</span>dust<span class="op">::</span>shared_ptr<span class="op">&lt;</span>sirs<span class="op">&gt;</span> shared<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Most interestingly we have the <code>update_gpu</code> method that
actually does the update on the GPU</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>__device__</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="dt">void</span> update_gpu<span class="op">&lt;</span>sirs<span class="op">&gt;(</span><span class="dt">size_t</span> time<span class="op">,</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>                      <span class="at">const</span> dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span>sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;</span> state<span class="op">,</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>                      dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> internal_int<span class="op">,</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>                      dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span>sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;</span> internal_real<span class="op">,</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>                      <span class="at">const</span> <span class="dt">int</span> <span class="op">*</span> shared_int<span class="op">,</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>                      <span class="at">const</span> sirs<span class="op">::</span><span class="dt">real_type</span> <span class="op">*</span> shared_real<span class="op">,</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>                      sirs<span class="op">::</span><span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>                      dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span>sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">;</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> alpha <span class="op">=</span> shared_real<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> beta <span class="op">=</span> shared_real<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> gamma <span class="op">=</span> shared_real<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> dt <span class="op">=</span> shared_real<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> freq <span class="op">=</span> shared_int<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> S <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> I <span class="op">=</span> state<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> R <span class="op">=</span> state<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> N <span class="op">=</span> S <span class="op">+</span> I <span class="op">+</span> R<span class="op">;</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> p_SI <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> exp<span class="op">(-</span> beta <span class="op">*</span> I <span class="op">/</span> N<span class="op">);</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> p_IR <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> exp<span class="op">(-</span> gamma<span class="op">);</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> p_RS <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> exp<span class="op">(-</span> alpha<span class="op">);</span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> n_SI <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> S<span class="op">,</span> p_SI <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> n_IR <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> I<span class="op">,</span> p_IR <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> n_RS <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> R<span class="op">,</span> p_RS <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a>  state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> S <span class="op">-</span> n_SI <span class="op">+</span> n_RS<span class="op">;</span></span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>  state_next<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> I <span class="op">+</span> n_SI <span class="op">-</span> n_IR<span class="op">;</span></span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a>  state_next<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> R <span class="op">+</span> n_IR <span class="op">-</span> n_RS<span class="op">;</span></span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a>  state_next<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span>time <span class="op">%</span> freq <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> n_SI <span class="op">:</span> state<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">+</span> n_SI<span class="op">;</span></span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note that this totally duplicates the logic from the CPU version
(which was a method of the <code>sirs</code> object)</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>  <span class="dt">void</span> update<span class="op">(</span><span class="dt">size_t</span> time<span class="op">,</span> <span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span> <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">,</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>              <span class="dt">real_type</span> <span class="op">*</span> state_next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>    <span class="dt">real_type</span> S <span class="op">=</span> state<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>    <span class="dt">real_type</span> I <span class="op">=</span> state<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>    <span class="dt">real_type</span> R <span class="op">=</span> state<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>    <span class="dt">real_type</span> N <span class="op">=</span> S <span class="op">+</span> I <span class="op">+</span> R<span class="op">;</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>    <span class="dt">real_type</span> p_SI <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> exp<span class="op">(-</span> shared<span class="op">-&gt;</span>beta <span class="op">*</span> I <span class="op">/</span> N<span class="op">);</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>    <span class="dt">real_type</span> p_IR <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> exp<span class="op">(-(</span>shared<span class="op">-&gt;</span>gamma<span class="op">));</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>    <span class="dt">real_type</span> p_RS <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> exp<span class="op">(-</span> shared<span class="op">-&gt;</span>alpha<span class="op">);</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>    <span class="dt">real_type</span> dt <span class="op">=</span> shared<span class="op">-&gt;</span>dt<span class="op">;</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>    <span class="dt">real_type</span> n_SI <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> S<span class="op">,</span> p_SI <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>    <span class="dt">real_type</span> n_IR <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> I<span class="op">,</span> p_IR <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>    <span class="dt">real_type</span> n_RS <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>binomial<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> R<span class="op">,</span> p_RS <span class="op">*</span> dt<span class="op">);</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> S <span class="op">-</span> n_SI <span class="op">+</span> n_RS<span class="op">;</span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> I <span class="op">+</span> n_SI <span class="op">-</span> n_IR<span class="op">;</span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> R <span class="op">+</span> n_IR <span class="op">-</span> n_RS<span class="op">;</span></span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>    state_next<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span>time <span class="op">%</span> shared<span class="op">-&gt;</span>freq <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> n_SI <span class="op">:</span> state<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">+</span> n_SI<span class="op">;</span></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>Differences include:</p>
<ul>
<li>the presence of the four auxiliary data elements
(<code>internal_int</code>, <code>internal_real</code>,
<code>shared_int</code> and <code>shared_real</code>)</li>
<li>the data types that vary across particles are a special
<code>dust::gpu::interleaved&lt;&gt;</code> type, which prevents slow
uncoalesced reads from global memory on the GPU</li>
<li>All accesses into the <code>shared_int</code> and
<code>shared_real</code> elements are now by position in the array,
rather than the previous pointer/name based access</li>
<li>The <code>__device__</code> annotation, which compiles the function
for use on the GPU</li>
</ul>
</div>
<div class="section level2">
<h2 id="data-comparison-functions">Data comparison functions<a class="anchor" aria-label="anchor" href="#data-comparison-functions"></a>
</h2>
<p>Finally, if running a particle filter on the GPU, a version of the
<code>compare_data</code> function is required that can run on the
GPU:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>__device__</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>sirs<span class="op">::</span><span class="dt">real_type</span> compare_gpu<span class="op">&lt;</span>sirs<span class="op">&gt;(</span><span class="at">const</span> dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span>sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;</span> state<span class="op">,</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>                                  <span class="at">const</span> sirs<span class="op">::</span><span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>                                  dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> internal_int<span class="op">,</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>                                  dust<span class="op">::</span>gpu<span class="op">::</span>interleaved<span class="op">&lt;</span>sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">&gt;</span> internal_real<span class="op">,</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>                                  <span class="at">const</span> <span class="dt">int</span> <span class="op">*</span> shared_int<span class="op">,</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>                                  <span class="at">const</span> sirs<span class="op">::</span><span class="dt">real_type</span> <span class="op">*</span> shared_real<span class="op">,</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>                                  sirs<span class="op">::</span><span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">real_type</span> <span class="op">=</span> sirs<span class="op">::</span><span class="dt">real_type</span><span class="op">;</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> exp_noise <span class="op">=</span> shared_real<span class="op">[</span><span class="dv">4</span><span class="op">];</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> incidence_modelled <span class="op">=</span> state<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> incidence_observed <span class="op">=</span> data<span class="op">.</span>incidence<span class="op">;</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">real_type</span> lambda <span class="op">=</span> incidence_modelled <span class="op">+</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>    dust<span class="op">::</span>random<span class="op">::</span>exponential<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> exp_noise<span class="op">);</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>  <span class="cf">return</span> dust<span class="op">::</span>density<span class="op">::</span>poisson<span class="op">(</span>incidence_observed<span class="op">,</span> lambda<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This is very similar to the CPU version</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>  <span class="dt">real_type</span> compare_data<span class="op">(</span><span class="at">const</span> <span class="dt">real_type</span> <span class="op">*</span> state<span class="op">,</span> <span class="at">const</span> <span class="dt">data_type</span><span class="op">&amp;</span> data<span class="op">,</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>                         <span class="dt">rng_state_type</span><span class="op">&amp;</span> rng_state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> incidence_modelled <span class="op">=</span> state<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> incidence_observed <span class="op">=</span> data<span class="op">.</span>incidence<span class="op">;</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">real_type</span> lambda <span class="op">=</span> incidence_modelled <span class="op">+</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>      dust<span class="op">::</span>random<span class="op">::</span>exponential<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng_state<span class="op">,</span> shared<span class="op">-&gt;</span>exp_noise<span class="op">);</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>    <span class="cf">return</span> dust<span class="op">::</span>density<span class="op">::</span>poisson<span class="op">(</span>incidence_observed<span class="op">,</span> lambda<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>with similar differences to the update function:</p>
<ul>
<li>argument types are different (interleaved types, internals and
shared data passed explicitly)</li>
<li>Accessing of shared parameters is by position, not name</li>
<li>The <code>__device__</code> annotation</li>
</ul>
</div>
<div class="section level2">
<h2 id="developing-a-gpu-model">Developing a GPU model<a class="anchor" aria-label="anchor" href="#developing-a-gpu-model"></a>
</h2>
<p>Debugging on a GPU is a pain, especially because there are typically
many particles, and error recovery is not straightforward. In addition,
most continuous integration systems do not provide GPUs, so testing your
GPU code becomes difficult. To make this easier, <code>dust</code>
allows running GPU code on the CPU - this will be typically slower than
the CPU code, but allows easier debugging and verification that the
model is behaving. We use this extensively in <code>dust</code>’s tests
and also in models built using <code>dust</code> that will run on the
GPU.</p>
<p>To do this, compile the model with your preferred real type, but set
the <code>gpu</code> argument to <code>FALSE</code></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sirs_cpu</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="../reference/dust.html">dust</a></span><span class="op">(</span><span class="va">path</span>, gpu <span class="op">=</span> <span class="cn">FALSE</span>, real_type <span class="op">=</span> <span class="st">"float"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ 34 functions decorated with [[cpp11::register]]</span></span>
<span><span class="co">#&gt; ✔ generated file 'cpp11.R'</span></span>
<span><span class="co">#&gt; ✔ generated file 'cpp11.cpp'</span></span>
<span><span class="co">#&gt; Re-compiling sirs817bc717</span></span>
<span><span class="co">#&gt;   ─  installing *source* package ‘sirs817bc717’ ...</span></span>
<span><span class="co">#&gt;      ** using staged installation</span></span>
<span><span class="co">#&gt;      ** libs</span></span>
<span><span class="co">#&gt;      make[1]: Entering directory '/tmp/RtmppiOue1/fileb32bb452d008e/src'</span></span>
<span><span class="co">#&gt;      make[1]: Leaving directory '/tmp/RtmppiOue1/fileb32bb452d008e/src'</span></span>
<span><span class="co">#&gt;      make[1]: Entering directory '/tmp/RtmppiOue1/fileb32bb452d008e/src'</span></span>
<span><span class="co">#&gt;    g++ -std=gnu++11 -I"/usr/share/R/include" -DNDEBUG  -I'/home/rfitzjoh/lib/R/library/cpp11/include' -g -Wall -Wextra -pedantic -Wmaybe-uninitialized -Wno-unused-parameter -Wno-cast-function-type -Wno-missing-field-initializers -O2  -I/home/rfitzjoh/lib/R/library/dust/include -DHAVE_INLINE -fopenmp -fpic  -g -O2 -fdebug-prefix-map=/build/r-base-QwogzP/r-base-4.1.1=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2 -g  -c cpp11.cpp -o cpp11.o</span></span>
<span><span class="co">#&gt;      g++ -std=gnu++11 -I"/usr/share/R/include" -DNDEBUG  -I'/home/rfitzjoh/lib/R/library/cpp11/include' -g -Wall -Wextra -pedantic -Wmaybe-uninitialized -Wno-unused-parameter -Wno-cast-function-type -Wno-missing-field-initializers -O2  -I/home/rfitzjoh/lib/R/library/dust/include -DHAVE_INLINE -fopenmp -fpic  -g -O2 -fdebug-prefix-map=/build/r-base-QwogzP/r-base-4.1.1=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2 -g  -c dust.cpp -o dust.o</span></span>
<span><span class="co">#&gt;      g++ -std=gnu++11 -shared -L/usr/lib/R/lib -Wl,-Bsymbolic-functions -Wl,-z,relro -o sirs817bc717.so cpp11.o dust.o -fopenmp -L/usr/lib/R/lib -lR</span></span>
<span><span class="co">#&gt;      make[1]: Leaving directory '/tmp/RtmppiOue1/fileb32bb452d008e/src'</span></span>
<span><span class="co">#&gt;      installing to /tmp/RtmppiOue1/devtools_install_b32bb3d78d7ef/00LOCK-fileb32bb452d008e/00new/sirs817bc717/libs</span></span>
<span><span class="co">#&gt;      ** checking absolute paths in shared objects and dynamic libraries</span></span>
<span><span class="co">#&gt;   ─  DONE (sirs817bc717)</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; ℹ Loading sirs817bc717</span></span></code></pre></div>
<p>Note that above the model is compiled with <code>g++</code>, not
<code>nvcc</code>. However, the “GPU” code is still compiled into the
model. We can then initialise this with and without a
<code>gpu_config</code> argument</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1</span> <span class="op">&lt;-</span> <span class="va">sirs_cpu</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">pars</span>, <span class="fl">0</span>, <span class="fl">10</span>, seed <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">model2</span> <span class="op">&lt;-</span> <span class="va">sirs_cpu</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">pars</span>, <span class="fl">0</span>, <span class="fl">10</span>, gpu_config <span class="op">=</span> <span class="fl">0L</span>, seed <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span></code></pre></div>
<p>And run the models using the “GPU” code and the normal CPU code, but
this time both on the CPU</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">#&gt; [1,]  981  987  977  986  994  948  958  961  976   968</span></span>
<span><span class="co">#&gt; [2,]   23   16   26   10    7   48   37   31   21    28</span></span>
<span><span class="co">#&gt; [3,]    6    7    7   14    9   14   15   18   13    14</span></span>
<span><span class="co">#&gt; [4,]    5    5    5    2    0   11    6    5    3     6</span></span>
<span><span class="va">model2</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">#&gt; [1,]  981  987  977  986  994  948  958  961  976   968</span></span>
<span><span class="co">#&gt; [2,]   23   16   26   10    7   48   37   31   21    28</span></span>
<span><span class="co">#&gt; [3,]    6    7    7   14    9   14   15   18   13    14</span></span>
<span><span class="co">#&gt; [4,]    5    5    5    2    0   11    6    5    3     6</span></span></code></pre></div>
<p>These should be exactly the same, and this can form the basis of
tests. Note that using <code>float</code> rather than
<code>double</code> can throw up a few issues with algorithms, so it’s
worth checking with single-precision in your tests.</p>
<p>If you hit problems, then <code>R -d cuda-gdb</code> can work in
place of the usual <code>R -d gdb</code> to work with a debugger, though
because of the huge numbers of particles you will typically work with,
debugging remains a challenge. Our usual strategy has been to try and
recreate any issue purely in CPU code and debug as normal (see <a href="https://reside-ic.github.io/blog/debugging-memory-errors-with-valgrind-and-gdb/" class="external-link">this
blog post</a> for hints on doing this effectively).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rich FitzJohn, Alex Hill, John Lees.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
