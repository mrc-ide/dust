<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Random number generation • dust</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Random number generation">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dust</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.15.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dust.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/design.html">Principles and design of dust</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Random numbers</li>
    <li>
      <a href="../articles/rng.html">Random number generation</a>
    </li>
    <li>
      <a href="../articles/rng_algorithms.html">Algorithms used to compute random numbers</a>
    </li>
    <li>
      <a href="../articles/rng_package.html">Using RNGs from packages</a>
    </li>
    <li>
      <a href="../articles/rng_distributed.html">Distributed parallel random numbers</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Dive deeper</li>
    <li>
      <a href="../articles/data.html">Comparing models and data</a>
    </li>
    <li>
      <a href="../articles/gpu.html">Running models on GPUs with CUDA</a>
    </li>
    <li>
      <a href="../articles/multi.html">Multiple parameter sets</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/dust/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Random number generation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/dust/blob/master/vignettes/rng.Rmd" class="external-link"><code>vignettes/rng.Rmd</code></a></small>
      <div class="hidden name"><code>rng.Rmd</code></div>

    </div>

    
    
<p>The core of <code>dust</code> is a very fast parallel random number
generation system. This vignette describes the details of the system and
why it is needed.</p>
<p>We provide an interface to the <a href="https://prng.di.unimi.it/" class="external-link">“Xoshiro” / Blackman-Vigna</a> family
of generators (Xoshiro is derived from XOR/shift/rotate). These are
designed to allow use in parallel by “jumping ahead” in the sequence and
we use this below to interleave generators. The stream is unrelated to
and unaffected by R’s random number generation. <code>set.seed</code>
has no effect, for example. <strong>The random numbers are not
cryptographically secure</strong>; for that see the excellent <a href="https://cran.r-project.org/package=sodium" class="external-link">sodium</a> package.</p>
<p>Ordinarily this is used from C++; the model as discussed in
<code><a href="../articles/dust.html">vignette("dust")</a></code> uses <code>rng_state_type</code> and a
function from <code>dust::random</code> to interact with the generator.
However, an R interface is provided for debugging and testing
purposes.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="va"><a href="../reference/dust_rng.html">dust_rng</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">rng</span></span>
<span><span class="co">#&gt; &lt;dust_rng&gt;</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     binomial: function (n, size, prob, n_threads = 1L) </span></span>
<span><span class="co">#&gt;     cauchy: function (n, location, scale, n_threads = 1L) </span></span>
<span><span class="co">#&gt;     exponential: function (n, rate, n_threads = 1L) </span></span>
<span><span class="co">#&gt;     gamma: function (n, shape, scale, n_threads = 1L) </span></span>
<span><span class="co">#&gt;     hypergeometric: function (n, n1, n2, k, n_threads = 1L) </span></span>
<span><span class="co">#&gt;     info: list</span></span>
<span><span class="co">#&gt;     initialize: function (seed = NULL, n_streams = 1L, real_type = "double", </span></span>
<span><span class="co">#&gt;     jump: function () </span></span>
<span><span class="co">#&gt;     long_jump: function () </span></span>
<span><span class="co">#&gt;     multinomial: function (n, size, prob, n_threads = 1L) </span></span>
<span><span class="co">#&gt;     nbinomial: function (n, size, prob, n_threads = 1L) </span></span>
<span><span class="co">#&gt;     normal: function (n, mean, sd, n_threads = 1L, algorithm = "box_muller") </span></span>
<span><span class="co">#&gt;     poisson: function (n, lambda, n_threads = 1L) </span></span>
<span><span class="co">#&gt;     random_normal: function (n, n_threads = 1L, algorithm = "box_muller") </span></span>
<span><span class="co">#&gt;     random_real: function (n, n_threads = 1L) </span></span>
<span><span class="co">#&gt;     size: function () </span></span>
<span><span class="co">#&gt;     state: function () </span></span>
<span><span class="co">#&gt;     uniform: function (n, min, max, n_threads = 1L) </span></span>
<span><span class="co">#&gt;   Private:</span></span>
<span><span class="co">#&gt;     float: FALSE</span></span>
<span><span class="co">#&gt;     n_streams: 1</span></span>
<span><span class="co">#&gt;     ptr: externalptr</span></span></code></pre></div>
<p>Currently only a few distributions are supported, with an interface
that somewhat mimics R’s interface (we avoid abbreviations so that
<code>rnorm</code> becomes <code>normal</code> and there are no default
arguments). For example, with the generator above we can generate 100
standard normal samples:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fl">100</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;   [1]  1.12910079  0.53780677 -1.26698746  0.95829321  3.21195234  0.09921154</span></span>
<span><span class="co">#&gt;   [7] -0.18600342 -0.29222356  2.08163389 -0.05121175  0.27770699  0.53856861</span></span>
<span><span class="co">#&gt;  [13]  0.03225818 -0.32777772  0.18042116  0.46339742 -0.38466512 -1.13577238</span></span>
<span><span class="co">#&gt;  [19]  0.91316208  0.03922728 -1.49714784  0.73104348 -0.83564659 -1.11930919</span></span>
<span><span class="co">#&gt;  [25]  0.02762058 -0.99778204  0.85397997  0.93862789  0.27005717 -0.22477757</span></span>
<span><span class="co">#&gt;  [31] -0.44778373  0.14367032 -0.06827267  0.68396692 -1.16518273 -0.89172407</span></span>
<span><span class="co">#&gt;  [37] -0.29950034  0.72347846 -1.14585657  0.34617660 -0.03401702  0.04667183</span></span>
<span><span class="co">#&gt;  [43]  0.09952394 -1.94032159  1.35699294 -0.34150243 -0.62118413  0.06133529</span></span>
<span><span class="co">#&gt;  [49]  1.18840972  0.56786089 -1.70569039  0.37351828  0.78885706  0.52182712</span></span>
<span><span class="co">#&gt;  [55] -0.82799139 -0.04261288  0.61557195  0.83137281 -1.21370978 -0.94812792</span></span>
<span><span class="co">#&gt;  [61] -0.12333629  0.52869359 -0.88974620 -0.17544455  1.80250618  1.12137595</span></span>
<span><span class="co">#&gt;  [67]  0.30129136 -0.07441952  1.03229412 -0.47172538 -0.97177969  0.82461084</span></span>
<span><span class="co">#&gt;  [73] -0.64920225 -0.00744135 -0.90106996  0.03281943 -1.57134280  0.46664117</span></span>
<span><span class="co">#&gt;  [79]  0.16352787  0.21926382  0.20193191 -1.84076636 -0.74116728 -0.99895652</span></span>
<span><span class="co">#&gt;  [85] -0.06497241  0.76942936 -0.67097495 -0.10362127  0.47417215 -0.77659258</span></span>
<span><span class="co">#&gt;  [91] -0.28248620 -1.09359110  0.61960546 -0.20527080  0.79773008  0.31563408</span></span>
<span><span class="co">#&gt;  [97]  0.53182428 -0.41118602  0.05391659  1.16452122</span></span></code></pre></div>
<p>One feature that we use here is to allow multiple streams of random
numbers within a rng object. If running in parallel (either via a dust
model or by passing <code>n_threads</code>) these different random
number streams can be given to different threads.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng1</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="va"><a href="../reference/dust_rng.html">dust_rng</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1</span>, n_streams <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">rng2</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="va"><a href="../reference/dust_rng.html">dust_rng</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1</span>, n_streams <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">rng1</span><span class="op">$</span><span class="fu">random_real</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.45135139 0.07353466 0.21812941 0.20013953 0.01717274</span></span>
<span><span class="va">rng2</span><span class="op">$</span><span class="fu">random_real</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;            [,1]      [,2]</span></span>
<span><span class="co">#&gt; [1,] 0.45135139 0.8989717</span></span>
<span><span class="co">#&gt; [2,] 0.07353466 0.3624481</span></span>
<span><span class="co">#&gt; [3,] 0.21812941 0.4729296</span></span>
<span><span class="co">#&gt; [4,] 0.20013953 0.3462430</span></span>
<span><span class="co">#&gt; [5,] 0.01717274 0.4180079</span></span></code></pre></div>
<p>Notice here how in the output from <code>rng2</code>, the first
column matches the series of numbers out of <code>rng1</code>.</p>
<p>This is achieved by “jumping” the random number streams forward. Here
are the second column of numbers from the output of
<code>rng2</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng3</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="va"><a href="../reference/dust_rng.html">dust_rng</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="fu">jump</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rng3</span><span class="op">$</span><span class="fu">random_real</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.8989717 0.3624481 0.4729296 0.3462430 0.4180079</span></span></code></pre></div>
<p>With the default generator (<code>xoshoro256+</code>, see below), a
jump is equivalent to 2^128 draws from the random number generator
(about 10^38). There are 2^128 of these non-overlapping subsequences in
the generator, which is quite a lot. If this feels too close together,
then the <code>$long_jump()</code> method jumps even further (2^192
draws, or about 10^57). There are 2^64 (10^20) of these sequences.</p>
<div class="section level2">
<h2 id="supported-distributions">Supported distributions<a class="anchor" aria-label="anchor" href="#supported-distributions"></a>
</h2>
<p>We do not yet support the full set of distributions provided by R,
and the distributions that we do support represent our immediate needs.
Contributions of further distributions is welcome. Note that in the R
version the first argument represents the number of draws requested, but
in the C++ interface we always return a single number.</p>
<p><strong>Uniform distribution</strong> between <code>min</code> and
<code>max</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">uniform</span><span class="op">(</span><span class="fl">10</span>, <span class="fl">3</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 4.773239 5.654481 3.977174 4.026823 4.115612 3.788596 3.917003 5.702068</span></span>
<span><span class="co">#&gt;  [9] 5.720697 5.547363</span></span></code></pre></div>
<p><strong>Normal distribution</strong> with parameters
<code>mean</code> and <code>sd</code></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fl">10</span>, <span class="fl">3</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 12.2139218  4.3761453  0.9866168  4.5615065 -6.0847775  7.4186531</span></span>
<span><span class="co">#&gt;  [7] -4.9939206  5.0829829 -2.7531772  6.3068671</span></span></code></pre></div>
<p>This function supports using the ziggurat algorithm, which will
generally be faster:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fl">10</span>, <span class="fl">3</span>, <span class="fl">6</span>, algorithm <span class="op">=</span> <span class="st">"ziggurat"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 12.679238  3.933790  8.843829  6.480052 -6.475361  5.767795 12.462605</span></span>
<span><span class="co">#&gt;  [8] 10.099802  7.808174 10.040571</span></span></code></pre></div>
<p><strong>Poisson distribution</strong> with mean
<code>lambda</code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">poisson</span><span class="op">(</span><span class="fl">10</span>, <span class="fl">4.5</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 3 6 2 4 7 9 2 4 3 4</span></span></code></pre></div>
<p><strong>Binomial distribution</strong> with mean <code>size</code>
and <code>prob</code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">binomial</span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">10</span>, <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 6 6 0 1 3 4 4 5 1 1</span></span></code></pre></div>
<p><strong>Negative binomial distribution</strong> with mean
<code>size</code> and <code>prob</code></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">nbinomial</span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">10</span>, <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 14 16 16  8 10 27 42 18 14 23</span></span></code></pre></div>
<p><strong>Hypergeometric distribution</strong> with parameters
<code>n1</code> (number of white balls), <code>n2</code> (number of
black balls) and <code>k</code> (number of samples)</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">hypergeometric</span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">3</span>, <span class="fl">10</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 0 1 1 2 2 1 2 0 1 2</span></span></code></pre></div>
<p><strong>Exponential distribution</strong> with rate
<code>rate</code></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">exponential</span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 0.07361117 0.39088773 0.08186782 0.61963654 0.34793074 0.13892083</span></span>
<span><span class="co">#&gt;  [7] 0.46349529 0.49744941 1.39014645 0.26500585</span></span></code></pre></div>
<p><strong>Multinomial distribution</strong> with parameters
<code>size</code> and <code>prob</code></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">multinomial</span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">20</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">#&gt; [1,]    8    8    8    6    7    2    7    6    6     8</span></span>
<span><span class="co">#&gt; [2,]    7    9    8   11   11   14   10    9   11     9</span></span>
<span><span class="co">#&gt; [3,]    5    3    4    3    2    4    3    5    3     3</span></span></code></pre></div>
<p>There are also two special case distributions, the <strong>Standard
uniform distribution</strong> (between 0 and 1) - faster than using
<code>$uniform(n, 0, 1)</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">random_real</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 0.242903786 0.049219283 0.916447682 0.008016532 0.056566402 0.123235690</span></span>
<span><span class="co">#&gt;  [7] 0.967806313 0.406906615 0.586602176 0.539672238</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="dt">real_type</span> u <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>random_real<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>state<span class="op">);</span></span></code></pre></div>
<p>the <strong>Standard normal distribution</strong> (between mean 0 and
sd 1) - faster than using <code>$normal(n, 0, 1)</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">random_normal</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1]  0.609695640  0.146842292 -0.131451864 -0.005175636  0.120022427</span></span>
<span><span class="co">#&gt;  [6] -0.464251232  0.054394819 -0.174200970 -0.019314869  1.315462849</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="dt">real_type</span> u <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>random_normal<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>state<span class="op">);</span></span></code></pre></div>
<p><strong>Gamma distribution</strong> parameterized by
<code>shape</code> and <code>scale</code></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">gamma</span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 10.135325 11.303813  4.016615 27.730667  6.175187 15.813924  8.100044</span></span>
<span><span class="co">#&gt;  [8]  2.681611 11.177406  2.162054</span></span></code></pre></div>
<p>All of these distributions are available in C++, and this is
documented <a href="https://mrc-ide.github.io/dust/cpp/random-distributions.html" class="external-link">in
the C++ reference documentation</a></p>
</div>
<div class="section level2">
<h2 id="performance">Performance<a class="anchor" aria-label="anchor" href="#performance"></a>
</h2>
<p>Performance should be on par or better with R’s random number
generator, though here the timings are likely to be mostly due to
allocations and copies of memory:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>  <span class="va">rng1</span><span class="op">$</span><span class="fu">random_real</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>  <span class="va">rng1</span><span class="op">$</span><span class="fu">uniform</span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>  time_unit <span class="op">=</span> <span class="st">"us"</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 6</span></span></span>
<span><span class="co">#&gt;   expression                 min median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;bch:expr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:byt&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> rng1$random_real(1000)    4.51   8.04   <span style="text-decoration: underline;">128</span>242.    7.86KB     25.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> rng1$uniform(1000, 0, 1)  6.21   9.57   <span style="text-decoration: underline;">114</span>318.    7.86KB     11.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> runif(1000)               9.30   9.86    <span style="text-decoration: underline;">99</span>298.   10.27KB     19.9</span></span></code></pre></div>
<p>For normally distributed random numbers, the different algorithms
will perform differently:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>  <span class="va">rng1</span><span class="op">$</span><span class="fu">random_normal</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>  <span class="va">rng1</span><span class="op">$</span><span class="fu">random_normal</span><span class="op">(</span><span class="fl">1000</span>, algorithm <span class="op">=</span> <span class="st">"ziggurat"</span><span class="op">)</span>,</span>
<span>  <span class="va">rng1</span><span class="op">$</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>  time_unit <span class="op">=</span> <span class="st">"us"</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 6</span></span></span>
<span><span class="co">#&gt;   expression                             min median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;bch:expr&gt;</span>                           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:byt&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> <span style="color: #949494;">"</span>rng1$random_normal(1000)<span style="color: #949494;">"</span>           33.9    35.1    <span style="text-decoration: underline;">28</span>089.    7.86KB     5.62</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> <span style="color: #949494;">"</span>rng1$random_normal(1000, algorithm…  9.11   10.0    <span style="text-decoration: underline;">97</span>955.    7.86KB     9.80</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> <span style="color: #949494;">"</span>rng1$normal(1000, 0, 1)<span style="color: #949494;">"</span>            36.2    37.5    <span style="text-decoration: underline;">26</span>330.    7.86KB     5.27</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> <span style="color: #949494;">"</span>rnorm(1000)<span style="color: #949494;">"</span>                        34.7    36.9    <span style="text-decoration: underline;">26</span>850.   10.27KB     2.69</span></span></code></pre></div>
<p>On reasonable hardware (10-core i9 at 2.8 GHz) we see throughput of
~1 billion U(0, 1) draws per second (1ns/draw) scaling linearly to 10
cores if the numbers are immediately discarded. Doing anything with the
numbers or trying to store them comes with a non-trivial overhead.</p>
<p>The difference between <code>random_real</code> and
<code>uniform</code> here is the cost of recycling the parameters, not
the actual generation!</p>
<p>Binomial distribution, small <code>n * p</code>, which uses an
inversion algorithm</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng1</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="va"><a href="../reference/dust_rng.html">dust_rng</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">9</span><span class="op">:</span><span class="fl">10</span>, length.out <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.11</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>  <span class="va">rng1</span><span class="op">$</span><span class="fu">binomial</span><span class="op">(</span><span class="fl">1000</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">)</span>,</span>
<span>  time_unit <span class="op">=</span> <span class="st">"us"</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">#&gt;   expression                  min median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;bch:expr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:byt&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> rng1$binomial(1000, n, p)  27.7   29.7    <span style="text-decoration: underline;">33</span>155.    7.86KB     6.63</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> rbinom(1000, n, p)         37.5   39.5    <span style="text-decoration: underline;">25</span>039.    6.34KB     2.50</span></span></code></pre></div>
<p>(note we vary <code>n</code> and <code>p</code> here as we’ve
optimised things for random parameter access).</p>
<p>Large <code>n * p</code> uses a rejection sampling algorithm</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">9999</span><span class="op">:</span><span class="fl">10000</span>, length.out <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.31</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>  <span class="va">rng1</span><span class="op">$</span><span class="fu">binomial</span><span class="op">(</span><span class="fl">1000</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="va">n</span>, <span class="va">p</span><span class="op">)</span>,</span>
<span>  time_unit <span class="op">=</span> <span class="st">"us"</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">#&gt;   expression                  min median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;bch:expr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:byt&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> rng1$binomial(1000, n, p)  43.2   47.8    <span style="text-decoration: underline;">20</span>691.    7.86KB     2.07</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> rbinom(1000, n, p)         59.4   65.7    <span style="text-decoration: underline;">15</span>114.    3.95KB     2.01</span></span></code></pre></div>
<p>Practically, performance will vary based on the parameters of the
distributions and the underlying algorithms, and the principle
performance gain we hope to get here is driven by the ability to
parallelise safely rather than the speed of the draws themselves.</p>
</div>
<div class="section level2">
<h2 id="underlying-random-number-engine">Underlying random number engine<a class="anchor" aria-label="anchor" href="#underlying-random-number-engine"></a>
</h2>
<p>Under the hood, the random number generators work by first creating a
random integer, which we then convert to a floating point number, then
for the distributions above we apply algorithms that convert one or more
uniformly distributed (i.e., U(0, 1)) floating point numbers to a given
distribution through techniques such as inversion (for a random
exponential) or rejection sampling (for a random binomial).</p>
<pre><code>[random integer] -&gt; [random real] -&gt; [random draw from a distribution]</code></pre>
<p>We include 12 different algorithms for creating the underlying random
integer, from the <a href="https://prng.di.unimi.it/" class="external-link">same family of
generators</a>. These provide different underlying storage types (either
32 bit or 64 bit integers) and different state types.</p>
<p>Normally you do not need to worry about these details and
declaring</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span></code></pre></div>
<p>in your model will select a reasonable generator.</p>
<p>If for some reason you want to try a different generator you can
directly specify one of the types, for example</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>xoshiro256starstar<span class="op">;</span></span></code></pre></div>
<p>which means that whatever real type you use, you want to use the
Xoshiro256** generator.</p>
<p>The supported types are:</p>
<ul>
<li>
<code>xoshiro256starstar</code>, <code>xoshiro256plusplus</code>,
<code>xoshiro256plus</code> (4 x 64 bit state)</li>
<li>
<code>xoroshiro128starstar</code>,
<code>xoroshiro128plusplus</code>, <code>xoroshiro128plus</code> (2 x 64
bit state)</li>
<li>
<code>xoshiro128starstar</code>, <code>xoshiro128plusplus</code>,
<code>xoshiro128plus</code> (4 x 32 bit state)</li>
<li>
<code>xoshiro512starstar</code>, <code>xoshiro512plusplus</code>,
<code>xoshiro512plus</code> (8 x 64 bit state; this is far more state
space than typically needed)</li>
</ul>
<p>The “starstar”, “plusplus” or “plus” refers to the final scrambling
operation (two multiplications, two additions or one addition,
respectively); the speeds of these might vary depending on your
platform. The “plus” version will be the fastest but produces slightly
less randomness in the the lower bits of the underlying integers, which
theoretically is not a problem when converting to a real number.</p>
<p>If you are generating single precision <code>float</code> numbers for
a GPU, then you may want to use the <code>xoshiro128</code> family as
these will be faster than the 64 bit generators on that platform. On a
CPU you will likely not see a difference</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng_f</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="va"><a href="../reference/dust_rng.html">dust_rng</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1</span>, real_type <span class="op">=</span> <span class="st">"float"</span><span class="op">)</span></span>
<span><span class="va">rng_d</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="va"><a href="../reference/dust_rng.html">dust_rng</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1</span>, real_type <span class="op">=</span> <span class="st">"double"</span><span class="op">)</span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>  <span class="va">rng_f</span><span class="op">$</span><span class="fu">random_real</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>  <span class="va">rng_d</span><span class="op">$</span><span class="fu">random_real</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>  time_unit <span class="op">=</span> <span class="st">"us"</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">#&gt;   expression                min median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;bch:expr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:byt&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> rng_f$random_real(1000)  4.56   5.04   <span style="text-decoration: underline;">191</span>884.    7.86KB     19.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> rng_d$random_real(1000)  4.57   5.05   <span style="text-decoration: underline;">190</span>950.    7.86KB     38.2</span></span></code></pre></div>
<p>If you do not need to run many parallel realisations, then the
<code>xoroshiro256</code> (note the extra <code>ro</code>) generators
may be preferable as they carry half the state and may be slightly
faster. The <code>xoshiro512</code> generators are included for
completeness and offer an excessive state space).</p>
<p>The table below summarises the properties of the underlying
generators (each of these exists with three different scrambling
options).</p>
<table class="table">
<thead><tr class="header">
<th>Name</th>
<th>Size</th>
<th>State</th>
<th>Period</th>
<th>Jump</th>
<th>Long jump</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>xoshiro128</code></td>
<td>32 bits</td>
<td>2 uint32</td>
<td>2^128</td>
<td>2^64</td>
<td>2^96</td>
</tr>
<tr class="even">
<td><code>xoroshiro128</code></td>
<td>64 bits</td>
<td>2 uint64</td>
<td>2^128</td>
<td>2^64</td>
<td>2^96</td>
</tr>
<tr class="odd">
<td><code>xoshiro256</code></td>
<td>64 bits</td>
<td>4 uint64</td>
<td>2^256</td>
<td>2^128</td>
<td>2^192</td>
</tr>
<tr class="even">
<td><code>xoshiro512</code></td>
<td>64 bits</td>
<td>4 uint64</td>
<td>2^512</td>
<td>2^512</td>
<td>2^384</td>
</tr>
</tbody>
</table>
<p>Size is the size of the returned random integer (32 or 64 bits,
though with the <code>+</code> scrambler not all bits will be of high
quality). The State is the number and size of the internal state of the
generator. Period refers to the number of states that the generator will
move through, Jump and Long jump are the number of steps (equivalent)
that a jump operation will take through this sequence.</p>
<p>Note that the period is the two size of number of bits in the model
state (e.g., xoshiro256 uses 4 x 64 bit integers, for a total of 256
bits of state, 2^256 possible combinations, each of which will be
visited once in the cycle). The Jump coefficients have been computed to
have size <code>sqrt(Period)</code>.</p>
</div>
<div class="section level2">
<h2 id="reusing-the-random-random-number-generator-in-other-projects">Reusing the random random number generator in other projects<a class="anchor" aria-label="anchor" href="#reusing-the-random-random-number-generator-in-other-projects"></a>
</h2>
<p>Our random number library can be reused in other projects without
using anything else from dust; either in an R package or in a standalone
project.</p>
<div class="section level3">
<h3 id="in-a-package">In a package<a class="anchor" aria-label="anchor" href="#in-a-package"></a>
</h3>
<p>A minimal package looks like</p>
<pre><code><span><span class="co">#&gt; <span style="color: #0000BB; font-weight: bold;">.</span></span></span>
<span><span class="co">#&gt; ├── DESCRIPTION</span></span>
<span><span class="co">#&gt; ├── NAMESPACE</span></span>
<span><span class="co">#&gt; └── <span style="color: #0000BB; font-weight: bold;">src</span></span></span>
<span><span class="co">#&gt;     └── rnguse.cpp</span></span></code></pre>
<p>with the core of the C++ file containing a small program that uses
the dust random number generator to draw a series of normally
distributed random number with a single mean and standard deviation.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust/random/random.hpp&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>cpp11<span class="op">::</span>doubles random_normal<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">double</span> mu<span class="op">,</span> <span class="dt">double</span> sd<span class="op">,</span> <span class="dt">int</span> seed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;;</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>  <span class="kw">auto</span> state <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>seed<span class="op">&lt;</span><span class="dt">rng_state_type</span><span class="op">&gt;(</span>seed<span class="op">);</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>  cpp11<span class="op">::</span>writable<span class="op">::</span>doubles ret<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a>    ret<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>normal<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>state<span class="op">,</span> mu<span class="op">,</span> sd<span class="op">);</span></span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a>  <span class="cf">return</span> ret<span class="op">;</span></span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>To complete the package, the <code>DESCRIPTION</code> includes
<code>dust</code> and <code>cpp11</code> in the <code>LinkingTo</code>
section:</p>
<pre class="plain"><code>Package: rnguse
Title: Use 'dust' RNG From Elsewhere
Version: 0.1.0
Authors@R: c(person("Rich", "FitzJohn", role = c("aut", "cre"),
                    email = "rich.fitzjohn@gmail.com"))
Description: Simple example package showing how to use dust's random
    number library from your R package's C++ code.
License: CC0
Encoding: UTF-8
LinkingTo: cpp11, dust</code></pre>
<p>You must remember to update your <code>NAMESPACE</code> to include
<code>useDynLib</code> (either directly or via roxygen)</p>
<pre class="plain"><code><span><span class="fu">useDynLib</span><span class="op">(</span><span class="va">rnguse</span>, .registration <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
<p>Finally, run <code><a href="https://cpp11.r-lib.org/reference/cpp_register.html" class="external-link">cpp11::cpp_register()</a></code> before compiling your
package so that the relevant interfaces are created
(<code>R/cpp11.R</code> and <code>cpp11/cpp11.cpp</code>). A similar
process would likely work with Rcpp without any dependency on cpp11.</p>
<p>The issue with this example is that every call to
<code>random_normal</code> must provide its own <code>seed</code>
argument, so the random number streams are not continued with each call
to the function. This is is not very useful in practice and we describe
more fully how to do this properly in
<code>vignette("rng_package.Rmd")</code>.</p>
</div>
<div class="section level3">
<h3 id="standalone-parallel-with-openmp">Standalone, parallel with OpenMP<a class="anchor" aria-label="anchor" href="#standalone-parallel-with-openmp"></a>
</h3>
<p><em>This is somewhat more experimental, so let us know if you have
success using the library this way.</em></p>
<p>It is possible to include the dust random library in a standalone C++
program (or one embedded from another language) without using any R
support. The library is a header only library and
<code>&lt;dust/random/random.hpp&gt;</code> is the main file to
include.</p>
<p>The simplest way to get started is to copy the contents of
<code>inst/include/dust/random</code> into your project. You can do this
by downloading and unpacking <a href="https://github.com/mrc-ide/dust/releases/latest/download/dust-random.tar.gz" class="external-link">the
latest release of dust-random</a>. Then after including
<code>&lt;dust/random/random.hpp&gt;</code> you can use the contents of
the random number library.</p>
<p>For example, below is a small program that computes the sum of a
series of random numbers, in parallel using OpenMP to parallelise across
a set of generators.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iomanip&gt;</span></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a><span class="pp">#ifndef NO_OPENMP</span></span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;omp.h&gt;</span></span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust/random/random.hpp&gt;</span></span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> <span class="dt">real_type</span><span class="op">&gt;</span></span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> random_sum<span class="op">(</span><span class="dt">int</span> n_streams<span class="op">,</span> <span class="dt">int</span> n_draws<span class="op">,</span></span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a>                                  <span class="dt">int</span> seed<span class="op">,</span> <span class="dt">int</span> n_threads<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a>  <span class="kw">using</span> <span class="dt">rng_state_type</span> <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>generator<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;;</span></span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a>  dust<span class="op">::</span>random<span class="op">::</span>prng<span class="op">&lt;</span><span class="dt">rng_state_type</span><span class="op">&gt;</span> rng<span class="op">(</span>n_streams<span class="op">,</span> seed<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;</span> ret<span class="op">(</span>n_streams<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb31-18"><a href="#cb31-18" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" tabindex="-1"></a>  <span class="pp">#pragma omp parallel for schedule(static) num_threads(n_threads)</span></span>
<span id="cb31-20"><a href="#cb31-20" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n_streams<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-21"><a href="#cb31-21" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> n_draws<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-22"><a href="#cb31-22" tabindex="-1"></a>      ret<span class="op">[</span>i<span class="op">]</span> <span class="op">+=</span> dust<span class="op">::</span>random<span class="op">::</span>random_real<span class="op">&lt;</span><span class="dt">real_type</span><span class="op">&gt;(</span>rng<span class="op">.</span>state<span class="op">(</span>i<span class="op">));</span></span>
<span id="cb31-23"><a href="#cb31-23" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-24"><a href="#cb31-24" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb31-25"><a href="#cb31-25" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" tabindex="-1"></a>  <span class="cf">return</span> ret<span class="op">;</span></span>
<span id="cb31-27"><a href="#cb31-27" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb31-28"><a href="#cb31-28" tabindex="-1"></a></span>
<span id="cb31-29"><a href="#cb31-29" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">*</span> argv<span class="op">[])</span> <span class="op">{</span></span>
<span id="cb31-30"><a href="#cb31-30" tabindex="-1"></a>  <span class="co">// Extremely simple but non-robust arg handling:</span></span>
<span id="cb31-31"><a href="#cb31-31" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>argc <span class="op">&lt;</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-32"><a href="#cb31-32" tabindex="-1"></a>    <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span></span>
<span id="cb31-33"><a href="#cb31-33" tabindex="-1"></a>      <span class="st">"Usage: rnguse &lt;n_draws&gt; [&lt;n_streams&gt; [&lt;seed&gt; [&lt;n_threads&gt;]]]"</span> <span class="op">&lt;&lt;</span></span>
<span id="cb31-34"><a href="#cb31-34" tabindex="-1"></a>      <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb31-35"><a href="#cb31-35" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb31-36"><a href="#cb31-36" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb31-37"><a href="#cb31-37" tabindex="-1"></a>  <span class="dt">int</span> n_draws   <span class="op">=</span> atoi<span class="op">(</span>argv<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb31-38"><a href="#cb31-38" tabindex="-1"></a>  <span class="dt">int</span> n_streams <span class="op">=</span> argc <span class="op">&lt;</span> <span class="dv">3</span> <span class="op">?</span>  <span class="dv">10</span> <span class="op">:</span> atoi<span class="op">(</span>argv<span class="op">[</span><span class="dv">2</span><span class="op">]);</span></span>
<span id="cb31-39"><a href="#cb31-39" tabindex="-1"></a>  <span class="dt">int</span> seed      <span class="op">=</span> argc <span class="op">&lt;</span> <span class="dv">4</span> <span class="op">?</span>  <span class="dv">42</span> <span class="op">:</span> atoi<span class="op">(</span>argv<span class="op">[</span><span class="dv">3</span><span class="op">]);</span></span>
<span id="cb31-40"><a href="#cb31-40" tabindex="-1"></a>  <span class="dt">int</span> n_threads <span class="op">=</span> argc <span class="op">&lt;</span> <span class="dv">5</span> <span class="op">?</span>   <span class="dv">1</span> <span class="op">:</span> atoi<span class="op">(</span>argv<span class="op">[</span><span class="dv">4</span><span class="op">]);</span></span>
<span id="cb31-41"><a href="#cb31-41" tabindex="-1"></a></span>
<span id="cb31-42"><a href="#cb31-42" tabindex="-1"></a>  <span class="kw">auto</span> ans <span class="op">=</span> random_sum<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>n_streams<span class="op">,</span> n_draws<span class="op">,</span> seed<span class="op">,</span> n_threads<span class="op">);</span></span>
<span id="cb31-43"><a href="#cb31-43" tabindex="-1"></a></span>
<span id="cb31-44"><a href="#cb31-44" tabindex="-1"></a>  <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="bu">std::</span>setprecision<span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb31-45"><a href="#cb31-45" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n_streams<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-46"><a href="#cb31-46" tabindex="-1"></a>    <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> i <span class="op">&lt;&lt;</span> <span class="st">": "</span> <span class="op">&lt;&lt;</span> ans<span class="op">[</span>i<span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb31-47"><a href="#cb31-47" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb31-48"><a href="#cb31-48" tabindex="-1"></a></span>
<span id="cb31-49"><a href="#cb31-49" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb31-50"><a href="#cb31-50" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This program can be compiled with</p>
<pre><code>g++ -I$(PATH_DUST_INCLUDE) -O2 -std=c++11 -fopenmp -o rnguse rnguse.cpp</code></pre>
<p>where <code>$PATH_DUST_INCLUDE</code> is the path to the header only
library.</p>
</div>
<div class="section level3">
<h3 id="standalone-parallel-on-a-gpu">Standalone, parallel on a GPU<a class="anchor" aria-label="anchor" href="#standalone-parallel-on-a-gpu"></a>
</h3>
<p>This is considerably more complicated and will depend on your aims
with your GPU-accelerated program.</p>
<p>We include <a href="https://github.com/mrc-ide/dust-random-bench/blob/main/dustrand.cu" class="external-link">examples
in a repository showing <code>dust::random</code> vs <code>curand</code>
benchmarks</a>. This covers setting up the RNG state so that it can be
set from the host and retrieved, interleaving as appropriate, plus
samples from the uniform, normal, exponential Poisson and binomial
distributions. We overlap with <code>curand</code> only for uniform,
normal, and Poisson. See <a href="https://github.com/mrc-ide/dust-random-bench" class="external-link">the repository</a>
for more details.</p>
</div>
</div>
<div class="section level2">
<h2 id="other-packages-with-similar-functionality">Other packages with similar functionality<a class="anchor" aria-label="anchor" href="#other-packages-with-similar-functionality"></a>
</h2>
<p>There are many packages offering similar functionality to
<code>dust</code>:</p>
<ul>
<li>
<a href="https://cran.r-project.org/package=sitmo" class="external-link"><code>sitmo</code></a>
offers several modern RNGs (sitmo, threefry, vandercorput) for
generating standard uniform numbers (U(0, 1)), designed to be usable
from an Rcpp-using package.</li>
<li>
<a href="https://cran.r-project.org/package=dqrng" class="external-link"><code>dqrng</code></a>
offers an overlapping set and generators for normal and exponential
random numbers, also designed to be used with Rcpp and BH.</li>
<li>
<a href="https://cran.r-project.org/package=rTRNG" class="external-link"><code>rTRNG</code></a>
exposes “Tina’s Random Number Generator”, among others, and support for
several distributions. It can be used from other packages but requires
linking (i.e., not header only) which does not work on macOS. Generator
jumps typically require a known number of draws per thread.</li>
<li>
<a href="https://coolbutuseless.github.io/2020/07/09/introducing-miranda-a-package-of-fast-modern-uniform-pseudo-random-number-generators/" class="external-link"><code>miranda</code></a>
includes support for several underlying generators (including
<code>xoshiro256+</code>) but with a single global state and no support
for use from other packages’ compiled code.</li>
</ul>
<p>Why does this package exist? We had a set of needs that meant using
the a</p>
<ul>
<li>generation of single precision <code>float</code> numbers with the
same interface</li>
<li>absolutely no global state</li>
<li>nice interface for reproducible parallel random number generation
where the generated number does not depend on the number of threads
used</li>
<li>possible to use on GPUs; this exposes some exotic issues around what
types of structures can be used</li>
<li>minimal dependencies and impact on the C++ code (e.g., no boost/BH)
and header-only in order to satisfy the above</li>
<li>support for additional distributions, especially binomial, in a
thread-safe way, optimised for rapidly changing parameters</li>
</ul>
<p>On this last point; we noticed that many distribution packages,
including Boost.Random (and to a degree R’s random functions) assume
that you want to sample many random numbers from a distribution with
fixed parameters. This is probably reasonable in many cases, but in the
use case we had (stochastic simulation models) we expected that all
parameters were likely to change at every iteration. These different
approaches have important tradeoffs - if you will take many samples from
a single distribution you might compute tables of coefficients once and
use them many times which will make the sampling faster, but this will
be wasteful if only a single sample is taken before the parameters
change.</p>
<p>The situation is slightly more complex on a GPU where we need to make
sure that different threads within a block do not get needlessly onto
different branches of conditional logic. Things like early exits need to
be avoided and we have carefully profiled to make sure that threads
within a warp end up re-synchronised at the optimal spot (see for
example <a href="https://developer.nvidia.com/blog/using-cuda-warp-level-primitives/" class="external-link">this
blog post on <code>__syncwarp</code></a>).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rich FitzJohn, Alex Hill, John Lees.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
