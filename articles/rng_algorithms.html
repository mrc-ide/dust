<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Algorithms used to compute random numbers • dust</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Algorithms used to compute random numbers">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dust</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.15.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dust.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/design.html">Principles and design of dust</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Random numbers</li>
    <li>
      <a href="../articles/rng.html">Random number generation</a>
    </li>
    <li>
      <a href="../articles/rng_algorithms.html">Algorithms used to compute random numbers</a>
    </li>
    <li>
      <a href="../articles/rng_package.html">Using RNGs from packages</a>
    </li>
    <li>
      <a href="../articles/rng_distributed.html">Distributed parallel random numbers</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Dive deeper</li>
    <li>
      <a href="../articles/data.html">Comparing models and data</a>
    </li>
    <li>
      <a href="../articles/gpu.html">Running models on GPUs with CUDA</a>
    </li>
    <li>
      <a href="../articles/multi.html">Multiple parameter sets</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/dust/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Algorithms used to compute random numbers</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/dust/blob/master/vignettes/rng_algorithms.Rmd" class="external-link"><code>vignettes/rng_algorithms.Rmd</code></a></small>
      <div class="hidden name"><code>rng_algorithms.Rmd</code></div>

    </div>

    
    
<p>The <code>dust</code> package includes three algorithms for computing
normally distributed random numbers, all of which should be faster than
R’s <code>rnorm</code> when called from R on a single thread:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="va"><a href="../reference/dust_rng.html">dust_rng</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e6</span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>  r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>  box_muller <span class="op">=</span> <span class="va">rng</span><span class="op">$</span><span class="fu">random_normal</span><span class="op">(</span><span class="va">n</span>, algorithm <span class="op">=</span> <span class="st">"box_muller"</span><span class="op">)</span>,</span>
<span>  polar <span class="op">=</span> <span class="va">rng</span><span class="op">$</span><span class="fu">random_normal</span><span class="op">(</span><span class="va">n</span>, algorithm <span class="op">=</span> <span class="st">"polar"</span><span class="op">)</span>,</span>
<span>  ziggurat <span class="op">=</span> <span class="va">rng</span><span class="op">$</span><span class="fu">random_normal</span><span class="op">(</span><span class="va">n</span>, algorithm <span class="op">=</span> <span class="st">"ziggurat"</span><span class="op">)</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span>, time_unit <span class="op">=</span> <span class="st">"ms"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 6</span></span></span>
<span><span class="co">#&gt;   expression   min median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;bch:expr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;bch:byt&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> r          36.7   36.8       26.9    7.63MB     7.33</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> box_muller 31.8   31.9       31.3    7.63MB     7.23</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> polar      21.3   21.5       46.6    7.63MB    12.9 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ziggurat    6.60   6.78     147.     7.63MB    28.9</span></span></code></pre></div>
<p>(This is not their intended purpose of course - that is to be called
from C++ in parallel.) This document collects some notes on the
algorithms that underlie the code used.</p>
<div class="section level2">
<h2 id="box-muller">Box-Muller<a class="anchor" aria-label="anchor" href="#box-muller"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e5</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r1</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span>
<span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></span></code></pre></div>
<p>Here are density plots from these samples against the expectation</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dnorm</span>, <span class="op">-</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">r1</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rng_algorithms_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>and the covariance between the two draws is statistically zero:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov</a></span><span class="op">(</span><span class="va">r1</span>, <span class="va">r2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.003985803</span></span></code></pre></div>
<p>Because we’re interested in running these algorithms in parallel we
have opted to discard the second draw (not running <code>sin</code> as
above). The simplest way to implement using both draws involves keeping
a record of your previous spare draw, but doing that in parallel
requires that each thread must be able to do that. We may change this in
future, or expose some system to enable doing this in a thread-safe
way.</p>
</div>
<div class="section level2">
<h2 id="polar">Polar<a class="anchor" aria-label="anchor" href="#polar"></a>
</h2>
<p>The polar method improves on the Box-Muller method by avoiding the
trigonometric functions at the expense of doing more random number
draws.</p>
<p>We first generate points on the unit circle (i.e., a pair
(<code>x</code>, <code>y</code>) such that
<code>x^2 + y^2 &lt; 1</code>). Then, letting <code>s</code> be the
distance between x and y, we can generate <em>two</em> values
<code>x * sqrt(-2 * log(s) / s)</code> and
<code>y * sqrt(-2 * log(s) / s)</code></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e5</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">*</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span> <span class="op">*</span> <span class="va">y</span></span>
<span><span class="va">i</span> <span class="op">&lt;-</span> <span class="va">s</span> <span class="op">&lt;</span> <span class="fl">1</span> <span class="co"># accept</span></span>
<span><span class="va">r1</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">s</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">r2</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">s</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dnorm</span>, <span class="op">-</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">r1</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rng_algorithms_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<p>Again the covariance is essentially zero</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov</a></span><span class="op">(</span><span class="va">r1</span>, <span class="va">r2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -0.001675233</span></span></code></pre></div>
<p>Here it’s a bit more painful to discard the second draw as it’s
almost free; we already have the second term which cost us one call to
<code>log</code> and we need only do one multiply to get the second.
This would be worse if ziggurat wasn’t much faster.</p>
</div>
<div class="section level2">
<h2 id="ziggurat">Ziggurat<a class="anchor" aria-label="anchor" href="#ziggurat"></a>
</h2>
<p>The “Ziggurat method” draws random numbers from some distribution by
a rejection sampling scheme. Unfortunately most implementations are
opaque, both because they were written in C and because they have been
milked for every bit of performance possible. We wanted a version that
was fast, but also easy to understand and to relate to the original
papers.</p>
<p>The principal reference we will follow is <a href="https://www.doornik.com/research/ziggurat.pdf" class="external-link">Doornik 2005</a>.
As with that paper, we consider an non-normalised right hand side of the
normal distribution:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="va">f</span>, <span class="fl">0</span>, <span class="fl">4</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="rng_algorithms_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>It will be useful to also have functions <code>f_inv</code> (the
inverse of <code>f</code>) and <code>f_int</code> (the integral of
<code>f</code> from x to infinity)</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f_inv</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">f_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">r</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To work with the algorithm we need to cover this curve with
<code>n</code> evenly sized rectangles, with the lowest one having
infinite width. We’ll use these rectangles for the sampling scheme,
described below</p>
<p><img src="rng_algorithms_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>Finding these rectangles turns out to be nontrivial.</p>
<p>Suppose we want to cover <code>f</code> with 6 rectangles; to do this
we need to find the area of each of the rectangles (will be slightly
larger area under <code>f</code> divided by <code>n</code> due to the
overhangs) and a series of <code>x</code> points (<code>x1</code>,
<code>x2</code>, …, <code>xn</code>) with the last one being 0</p>
<ol style="list-style-type: decimal">
<li>First we make a starting guess as to the <code>x</code> location of
the final rectangle, say <code>r</code>
</li>
<li>We then compute the volume of the lowest rectangle as
<code>f(r) * r + f_int(r)</code>
</li>
<li>We can then compute the size of the 2nd rectangle as
<code>f_inv(f(r) + v / r)</code>
</li>
<li>Continue this until all ‘x’ values have been computed, replacing
<code>r</code> above with the <code>x</code> value from the previous
iteration</li>
</ol>
<p>From the diagram above it looks like <code>x1</code> might be a bit
bigger than 2. Starting with a guess of 2.2:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">6</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fl">2.2</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fu">f</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">+</span> <span class="fu">f_int</span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">r</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">f_inv</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">v</span> <span class="op">/</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We now have a series of <code>x</code> values</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span></span>
<span><span class="co">#&gt; [1] 2.2000000 1.8119187 1.5077600 1.2223596 0.9077862 0.0000000</span></span></code></pre></div>
<p>The area of the final rectangle must be</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span><span class="op">[</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span> <span class="op">-</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3065602</span></span></code></pre></div>
<p>which is <em>bigger</em> than all the others, which have area
<code>v</code>. If we’d made our original guess too small (say 2.1) then
we’d have too <em>small</em> a final area. We can capture this in a
small nonlinear equation to solve:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">v</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fu">f</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">+</span> <span class="fu">f_int</span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">r</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">f_inv</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span> <span class="va">v</span> <span class="op">/</span> <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">x</span> <span class="op">*</span> <span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span> <span class="op">-</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="va">v</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">target</span><span class="op">(</span><span class="fl">2.2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.07608185</span></span>
<span><span class="fu">target</span><span class="op">(</span><span class="fl">2.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -0.2233091</span></span></code></pre></div>
<p>This is easily solved by <code>uniroot</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">target</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.1</span>, <span class="fl">2.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ans</span></span>
<span><span class="co">#&gt; $root</span></span>
<span><span class="co">#&gt; [1] 2.176047</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $f.root</span></span>
<span><span class="co">#&gt; [1] -3.954086e-05</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iter</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $init.it</span></span>
<span><span class="co">#&gt; [1] NA</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $estim.prec</span></span>
<span><span class="co">#&gt; [1] 6.103516e-05</span></span></code></pre></div>
<p>This approach works for any <code>n</code>, though in practice some
care is needed to select good bounds.</p>
<p>Once we have found this value, we can compute our series of
<code>x</code> values as above:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="va">ans</span><span class="op">$</span><span class="va">root</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op">*</span> <span class="fu">f</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">+</span> <span class="fu">f_int</span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">r</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">f_inv</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">v</span> <span class="op">/</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; [1] 2.1760469 1.7818609 1.4695742 1.1712803 0.8287847 0.0000000</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sampling">Sampling<a class="anchor" aria-label="anchor" href="#sampling"></a>
</h2>
<p>To sample from the distribution using these rectangles we do:</p>
<ol style="list-style-type: decimal">
<li>select a rectangle to sample from (an integer between 1 and
<code>n</code>)</li>
<li>select a random number <code>u</code> (between 0 and 1); scale this
by <code>x[i]</code> to get <code>z</code>
</li>
<li>if <code>i == 0</code> (the base layer)
<ol style="list-style-type: lower-alpha">
<li>if <code>z &lt; r</code> then the point lies in the rectangle and
can be accepted</li>
<li>otherwise draw from the tail and <em>accept that point</em> (see
below)</li>
</ol>
</li>
<li>if <code>i &gt; 1</code> (any other layer):
<ul>
<li>if <code>z &lt; x[i - 1]</code> then the point lies entirely within
the distribution and can be accepted</li>
<li>otherwise test the edges once and accept that point or <em>return to
the first step of the algorithm</em>
</li>
</ul>
</li>
</ol>
<p>Note the slightly different alternative conditions for the base layer
and others; for the base layer we <em>will</em> find a sample from the
tail even if it takes a few goes, but for the regions with overlaps we
only try once and if that does not succeed we start again by selecting a
new layer.</p>
<div class="section level3">
<h3 id="sampling-from-the-tail">Sampling from the tail<a class="anchor" aria-label="anchor" href="#sampling-from-the-tail"></a>
</h3>
<p>For sampling from the tail we use the algorithm of Marsaglia (1963);
given U(0, 1) random numbers <code>u1</code> and <code>u2</code> and
using the value of <code>r</code> from above (i.e.,
<code>x[1]</code>):</p>
<ol style="list-style-type: decimal">
<li>Let x = <code>-log(u1) / r</code>
</li>
<li>Let y = <code>-log(u2)</code>
</li>
<li>If <code>2 y &gt; x^2</code> accept <code>x + r</code>, otherwise
try again</li>
</ol>
<p>To see this in action, first, let’s generate a set of normal draws
from the tail (beyond <code>x[1]</code>)</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1e7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="va">z</span><span class="op">[</span><span class="va">z</span> <span class="op">&gt;=</span> <span class="va">r</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">z</span> <span class="op">-</span> <span class="va">r</span>, nclass <span class="op">=</span> <span class="fl">30</span>, freq <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">r</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">r</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rng_algorithms_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
<p>The curve is the analytical density function, shifted by
<code>r</code> along the x-axis and scaled so that the area under the
tail is 1.</p>
<p>Generating a reasonably large number of samples (here 10 thousand)
shows a good agreement between the samples and the expectation:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sx</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1e5</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">r</span></span>
<span><span class="va">sy</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1e5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">accept</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">sy</span> <span class="op">&gt;</span> <span class="va">sx</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">sx</span><span class="op">[</span><span class="va">accept</span><span class="op">]</span>, nclass <span class="op">=</span> <span class="fl">30</span>, freq <span class="op">=</span> <span class="cn">FALSE</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">r</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">r</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rng_algorithms_files/figure-html/unnamed-chunk-18-1.png" width="672"></p>
<p>With the relatively low <code>r</code> here, our acceptance
probability is not bad (~86 %) but as <code>r</code> increases it will
improve:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sx</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1e5</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3.9</span></span>
<span><span class="va">sy</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1e5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">sy</span> <span class="op">&gt;</span> <span class="va">sx</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.94355</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-edges">The edges<a class="anchor" aria-label="anchor" href="#the-edges"></a>
</h3>
<p>If our point in layer <code>i</code> (<code>i &gt; 1</code>) lies
outside of the safe zone we need to do a full rejection sample. We start
by illustrating this graphically; given two U(0, 1) numbers scaled to
<code>(x[3], x[2])</code> and <code>f(x[3]), f(x[2])</code> we would
accept the blue points below but not the red ones:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">f</span>, <span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.05</span>, <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">f0</span> <span class="op">&lt;-</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">f1</span> <span class="op">&lt;-</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">u1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">100</span>, <span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="co"># these ones are filtered already</span></span>
<span><span class="va">u2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">f0</span> <span class="op">+</span> <span class="va">u2</span> <span class="op">*</span> <span class="op">(</span><span class="va">f1</span> <span class="op">-</span> <span class="va">f0</span><span class="op">)</span></span>
<span><span class="va">accept</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">&lt;</span> <span class="fu">f</span><span class="op">(</span><span class="va">u1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">u1</span>, <span class="va">y</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">accept</span>, <span class="st">"blue"</span>, <span class="st">"red"</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span></code></pre></div>
<p><img src="rng_algorithms_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
<p>The above calculation computes three values of <code>f</code>; for
<code>x[2]</code>, <code>x[3]</code> and <code>u1</code>, each of these
involves a calculation of <code><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp()</a></code> which is fairly costly.
Adding in tables of <code>fx = f(x)</code> actually slows things down
slightly as well as increasing the number of constants rattling around
the program.</p>
<p>Alternatively if we take the acceptance equation:</p>
<pre><code><span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">u2</span> <span class="op">*</span> <span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fu">f</span><span class="op">(</span><span class="va">u1</span><span class="op">)</span></span></code></pre>
<p>and divide both sides by <code>f(u1)</code> we get</p>
<pre><code><span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu">f</span><span class="op">(</span><span class="va">u1</span><span class="op">)</span> <span class="op">+</span> <span class="va">u2</span> <span class="op">*</span> <span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu">f</span><span class="op">(</span><span class="va">u1</span><span class="op">)</span> <span class="op">-</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu">f</span><span class="op">(</span><span class="va">u1</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1</span></span></code></pre>
<p>then we can rearrange slightly using the fact that
<code>f(a) / f(b) = exp(-0.5 * (a^2 - b^2)</code> to write</p>
<pre><code><span><span class="va">f2_u1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="va">u1</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">f3_u1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="va">u1</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<p>which we can use to get the same acceptance as above:</p>
<pre><code><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">f3_u1</span> <span class="op">+</span> <span class="va">u2</span> <span class="op">*</span> <span class="op">(</span><span class="va">f2_u1</span> <span class="op">-</span> <span class="va">f3_u1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1.0</span>, <span class="va">accept</span><span class="op">)</span></span></code></pre>
<p>This is the approach we use in the implementation.</p>
</div>
</div>
<div class="section level2">
<h2 id="optimisations">Optimisations<a class="anchor" aria-label="anchor" href="#optimisations"></a>
</h2>
<p>In the naive version we draw a random number on <code>[0, 1)</code>
and compare that with the bounds <code>x</code>.</p>
<p>Suppose we are sampling in the 3rd layer; we draw a random number
<code>u</code> and scale it by <code>x[2]</code>, then accept if that
scaled value is less than <code>x[3]</code>, otherwise check to see if
we are in the tail</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="va">u</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">z</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="co">#&gt;  [1]  TRUE  TRUE FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE  TRUE</span></span>
<span><span class="co">#&gt; [13]  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE</span></span>
<span><span class="co">#&gt; [25] FALSE  TRUE  TRUE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE  TRUE  TRUE  TRUE</span></span>
<span><span class="co">#&gt; [37] FALSE  TRUE FALSE FALSE  TRUE  TRUE  TRUE FALSE  TRUE  TRUE  TRUE  TRUE</span></span>
<span><span class="co">#&gt; [49]  TRUE  TRUE</span></span></code></pre></div>
<p>Most of the numbers are accepted (this is the point of the algorithm
and that acceptance probability increases as <code>n</code> does).</p>
<p>There are two tricks that can be done here to make this more
efficient. First we can notice that the above calculation is equivalent
to <code>u &lt; x[3] / x[2]</code>:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="op">(</span><span class="va">u</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">/</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">==</span> <span class="op">(</span><span class="va">u</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>and by saving the values of <code>x[i] / x[i - 1]</code> in our
tables we can avoid many multiplications.</p>
<p>In the description above, we take two random draws at first - one for
the layer and one for the <code>x</code> position. Some implementation
do that with a single draw but this is not safe if your random number
generator works in terms of 32 bit integers (see <a href="https://www.doornik.com/research/ziggurat.pdf" class="external-link">Doornik 2005</a>)
as all bits are needed to convert to a double and this creates a
correlation between the layer and the position.</p>
<p>However, most of our random number generators work with 64 bit
integers and we only use the top 53 bits to make a double-precision
number. So we take bits 4 to 11 to create the integer between 0 and 255
for the layer. If using a 32 bit generator (one of the
<code>xoshiro128</code> generators) then a second number will be used;
this decision will be made at compile time so should come with no
runtime cost. With the <code>+</code> scramblers the lower bits are not
of the same quality (See <a href="https://vigna.di.unimi.it/ftp/papers/ScrambledLinear.pdf" class="external-link">this
paper</a>) but for <code>xoshiro256+</code> by the 4th bit the
randomness should be of sufficient quality.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rich FitzJohn, Alex Hill, John Lees.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
