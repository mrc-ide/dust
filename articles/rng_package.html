<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using RNGs from packages • dust</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using RNGs from packages">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dust</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.15.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dust.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/design.html">Principles and design of dust</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Random numbers</li>
    <li>
      <a href="../articles/rng.html">Random number generation</a>
    </li>
    <li>
      <a href="../articles/rng_algorithms.html">Algorithms used to compute random numbers</a>
    </li>
    <li>
      <a href="../articles/rng_package.html">Using RNGs from packages</a>
    </li>
    <li>
      <a href="../articles/rng_distributed.html">Distributed parallel random numbers</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Dive deeper</li>
    <li>
      <a href="../articles/data.html">Comparing models and data</a>
    </li>
    <li>
      <a href="../articles/gpu.html">Running models on GPUs with CUDA</a>
    </li>
    <li>
      <a href="../articles/multi.html">Multiple parameter sets</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/dust/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using RNGs from packages</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/dust/blob/master/vignettes/rng_package.Rmd" class="external-link"><code>vignettes/rng_package.Rmd</code></a></small>
      <div class="hidden name"><code>rng_package.Rmd</code></div>

    </div>

    
    
<!-- DO NOT EDIT THIS FILE - see vignettes_src and make changes there -->
<p>The dust random number generators are suitable for use from other
packages and we provide a few helpers in both R and C++ to make this
easier.</p>
<p>For illustration purposes we will assume that you want to estimate pi
using rejection sampling. The basic idea of this algorithm is simple;
sample two U(0, 1) points <code>x</code> and <code>y</code> and test if
they lie in the unit circle (i.e. <code>sqrt(x^2 + x^2) &lt; 1</code>)
giving the ratio of the area of a unit circle to a square. Multiplying
the fraction of the points that we accept by 4 yields our estimate of
pi.</p>
<div class="section level2">
<h2 id="background-using-rs-random-number-generator">Background using R’s random number generator<a class="anchor" aria-label="anchor" href="#background-using-rs-random-number-generator"></a>
</h2>
<p>First, an example that uses R’s API for example (note that while the
R API is C, we’re using the cpp11 package interface here so that the
following examples are similar):</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Random.h&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="dt">double</span> pi_r<span class="op">(</span><span class="dt">int</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="dt">int</span> tot <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  GetRNGstate<span class="op">();</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> u1 <span class="op">=</span> unif_rand<span class="op">();</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> u2 <span class="op">=</span> unif_rand<span class="op">();</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>u1 <span class="op">*</span> u1 <span class="op">+</span> u2 <span class="op">*</span> u2 <span class="op">&lt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>      tot<span class="op">++;</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>  PutRNGstate<span class="op">();</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  <span class="cf">return</span> tot <span class="op">/</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>n<span class="op">)</span> <span class="op">*</span> <span class="fl">4.0</span><span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>With cpp11 we can load this with <code><a href="https://cpp11.r-lib.org/reference/cpp_source.html" class="external-link">cpp11::cpp_source</a></code></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cpp11</span><span class="fu">::</span><span class="fu"><a href="https://cpp11.r-lib.org/reference/cpp_source.html" class="external-link">cpp_source</a></span><span class="op">(</span><span class="st">"rng_pi_r.cpp"</span><span class="op">)</span></span></code></pre></div>
<p>and then run it with</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pi_r</span><span class="op">(</span><span class="fl">1e6</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3.139504</span></span></code></pre></div>
<p>The key bits within the code above are that we:</p>
<ul>
<li>included random number support from R via the
<code>R_ext/Random.h</code> header</li>
<li>initialised the state of the global random number stream within our
C++ context with <code>GetRNGstate</code> before drawing any random
numbers</li>
<li>drew some possible large number of numbers using
<code>unif_rand</code>
</li>
<li>restored the random number state back to R.</li>
</ul>
<p>Failure to run the <code>GetRNGstate</code> /
<code>PutRNGstate</code> will result in the stream not behaving
properly. This is explained in detail in the “Writing R Extensions”
manual.</p>
</div>
<div class="section level2">
<h2 id="basic-implementation-using-dust">Basic implementation using dust<a class="anchor" aria-label="anchor" href="#basic-implementation-using-dust"></a>
</h2>
<p>The implementation in dust will look very similar to above, but the
way that we cope with the random number stream will look quite
different. With the R version above we are looking after R’s global
stream (stored in the variable <code>.Random.seed</code>) and making
sure that it is fetched and set on entry and exit to the function.</p>
<p>One of the design ideas in dust is that there is no single global
source of random numbers, so we need to create a source that our
function can use. If we were to use the simulation function multiple
times we would want the stream to pick up where it left off last time,
so the act of calling the function should update the seed as a “side
effect”.</p>
<p>The way we expose this for use within other packages is that the user
(either package developer or user of the package) creates a “pointer” to
some random number state. Passing that state into a C++ function will
allow use of the random functions within dust, and will update the state
correctly (see the following section for details).</p>
<p>First we create a pointer object:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">:::</span><span class="va"><a href="../reference/dust_rng_pointer.html">dust_rng_pointer</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rng</span></span>
<span><span class="co">#&gt; &lt;dust_rng_pointer&gt;</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     algorithm: xoshiro256plus</span></span>
<span><span class="co">#&gt;     initialize: function (seed = NULL, n_streams = 1L, long_jump = 0L, algorithm = "xoshiro256plus")</span></span>
<span><span class="co">#&gt;     is_current: function ()</span></span>
<span><span class="co">#&gt;     n_streams: 1</span></span>
<span><span class="co">#&gt;     state: function ()</span></span>
<span><span class="co">#&gt;     sync: function ()</span></span>
<span><span class="co">#&gt;   Private:</span></span>
<span><span class="co">#&gt;     is_current_: TRUE</span></span>
<span><span class="co">#&gt;     ptr_: externalptr</span></span>
<span><span class="co">#&gt;     state_: 2f d6 21 97 9b 4f 43 00 59 87 46 42 d6 ff e5 e4 e8 de d7 ...</span></span></code></pre></div>
<p>Unlike the <code><a href="../reference/dust_rng.html">dust::dust_rng</a></code> object there are no real
useful methods on this object and from the R side we’ll treat it as a
black box. Importantly the <code>rng</code> object knows which algorithm
it has been created to use</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="va">algorithm</span></span>
<span><span class="co">#&gt; [1] "xoshiro256plus"</span></span></code></pre></div>
<p>The default will be suitable for most purposes.</p>
<p>We can rewrite the pi approximation function as:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust/r/random.hpp&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">linking_to</span><span class="op">(</span><span class="at">dust</span><span class="op">)]]</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="dt">double</span> pi_dust<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> cpp11<span class="op">::</span>sexp ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>  <span class="kw">auto</span> rng <span class="op">=</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>    dust<span class="op">::</span>random<span class="op">::</span>r<span class="op">::</span>rng_pointer_get<span class="op">&lt;</span>dust<span class="op">::</span>random<span class="op">::</span>xoshiro256plus<span class="op">&gt;(</span>ptr<span class="op">);</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>  <span class="kw">auto</span><span class="op">&amp;</span> state <span class="op">=</span> rng<span class="op">-&gt;</span>state<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>  <span class="dt">int</span> tot <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> u1 <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>random_real<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>state<span class="op">);</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> u2 <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>random_real<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>state<span class="op">);</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>u1 <span class="op">*</span> u1 <span class="op">+</span> u2 <span class="op">*</span> u2 <span class="op">&lt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>      tot<span class="op">++;</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>  <span class="cf">return</span> tot <span class="op">/</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>n<span class="op">)</span> <span class="op">*</span> <span class="fl">4.0</span><span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This snippet looks much the same as above:</p>
<ul>
<li>We’ve added <code>[[cpp::linking_to(dust)]]</code> and included the
dust random interface (<code>dust/r/random.hpp</code>)</li>
<li>The first line of the function safely creates a pointer to the
random state data. The template argument here
(<code>&lt;dust::random::xoshiro256plus&gt;</code>) refers to the rng
algorithm and matches <code>rng$algorithm</code>
</li>
<li>The second line extracts a reference to the first (C++ indexing
starting at 0) random number stream - this pair of lines is roughly
equivalent to <code>GetRNGstate()</code> except that that the random
numbers do not come from some global source</li>
<li>After that the listing proceeds as before proceeds as before, except
there is no equivalent to <code>PutRNGstate()</code> because the pointer
object takes care of this automatically.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cpp11</span><span class="fu">::</span><span class="fu"><a href="https://cpp11.r-lib.org/reference/cpp_source.html" class="external-link">cpp_source</a></span><span class="op">(</span><span class="st">"rng_pi_dust.cpp"</span><span class="op">)</span></span></code></pre></div>
<p>and then run it with</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pi_dust</span><span class="op">(</span><span class="fl">1e6</span>, <span class="va">rng</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3.14206</span></span></code></pre></div>
<p>The C++ interface is described in more detail in <a href="https://mrc-ide.github.io/dust/cpp/" class="external-link">the online
documentation</a></p>
</div>
<div class="section level2">
<h2 id="parallel-implementation-with-dust-and-openmp">Parallel implementation with dust and OpenMP<a class="anchor" aria-label="anchor" href="#parallel-implementation-with-dust-and-openmp"></a>
</h2>
<p>Part of the point of dust’s random number generators is that they
create independent streams of random numbers that can be safely used in
parallel.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust/r/random.hpp&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="pp">#ifdef _OPENMP</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;omp.h&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">linking_to</span><span class="op">(</span><span class="at">dust</span><span class="op">)]]</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="dt">double</span> pi_dust_parallel<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> cpp11<span class="op">::</span>sexp ptr<span class="op">,</span> <span class="dt">int</span> n_threads<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>  <span class="kw">auto</span> rng <span class="op">=</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>    dust<span class="op">::</span>random<span class="op">::</span>r<span class="op">::</span>rng_pointer_get<span class="op">&lt;</span>dust<span class="op">::</span>random<span class="op">::</span>xoshiro256plus<span class="op">&gt;(</span>ptr<span class="op">);</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> n_streams <span class="op">=</span> rng<span class="op">-&gt;</span>size<span class="op">();</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>  <span class="dt">int</span> tot <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="pp">#ifdef _OPENMP</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a><span class="pp">#pragma omp parallel for schedule(static)  num_threads(n_threads) \</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a><span class="pp">  reduction(+:tot)</span></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n_streams<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>    <span class="kw">auto</span><span class="op">&amp;</span> state <span class="op">=</span> rng<span class="op">-&gt;</span>state<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    <span class="dt">int</span> tot_i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>      <span class="at">const</span> <span class="dt">double</span> u1 <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>random_real<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>state<span class="op">);</span></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a>      <span class="at">const</span> <span class="dt">double</span> u2 <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>random_real<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>state<span class="op">);</span></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>u1 <span class="op">*</span> u1 <span class="op">+</span> u2 <span class="op">*</span> u2 <span class="op">&lt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>        tot_i<span class="op">++;</span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>    tot <span class="op">+=</span> tot_i<span class="op">;</span></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>  <span class="cf">return</span> tot <span class="op">/</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>n <span class="op">*</span> n_streams<span class="op">)</span> <span class="op">*</span> <span class="fl">4.0</span><span class="op">;</span></span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cpp11</span><span class="fu">::</span><span class="fu"><a href="https://cpp11.r-lib.org/reference/cpp_source.html" class="external-link">cpp_source</a></span><span class="op">(</span><span class="st">"rng_pi_parallel.cpp"</span><span class="op">)</span></span></code></pre></div>
<p>Here we’ve made a number of decisions about how to split the problem
up subject to a few constraints about using OpenMP together with R:</p>
<ul>
<li>Generally speaking we want the answer to be independent of the
number of threads used to run it, as this will vary in different
sessions. As such avoid the temptation to do a loop over the threads;
here we instead iterate over <em>streams</em> with the idea that there
will be one or more streams used per threads. If we ran a single thread
we’d get the same answer as if we ran one thread per stream.</li>
<li>Each thread is going to do it’s own loop of length <code>n</code> so
we need to divide by <code>n * n_streams</code> at the end as that’s
many attempts we have made.</li>
<li>We use OpenMP’s <code>reduction</code> clause to safely accumulate
the different subtotals (the <code>tot_i</code> values) into one
<code>tot</code> value.</li>
<li>In order to compile gracefully on machines that do not have OpenMP
support both the <code>#include &lt;omp.h&gt;</code> line and the
<code>#pragma omp</code> line are wrapped in guards that test for
<code>_OPENMP</code> (see “Writing R Extensions”).</li>
<li>We let the generator tell us how many streams it has
(<code>n_streams = rng-&gt;size()</code>) but we could as easily specify
an ideal number of streams as an argument here and then test that the
generator has <em>at least that many</em> by adding an argument to the
call to <code>rng_pointer_get</code> (e.g., if we wanted <code>m</code>
streams the call would be
<code>rng_pointer_get&lt;type&gt;(ptr, m)</code>)</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">:::</span><span class="va"><a href="../reference/dust_rng_pointer.html">dust_rng_pointer</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>n_streams <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu">pi_dust_parallel</span><span class="op">(</span><span class="fl">1e6</span>, <span class="va">rng</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3.140963</span></span></code></pre></div>
<p>Unfortunately <a href="https://github.com/r-lib/cpp11/issues/243" class="external-link"><code>cpp11::cpp_source</code>
does not support using OpenMP</a> so in the example above the code will
run in serial and we can’t see if parallelisation will help.</p>
<p>In order to compile with support, we need to build a little package
and set up an appropriate <code>Makevars</code> file</p>
<p>The package is fairly minimal:</p>
<pre><code><span><span class="co">#&gt; .</span></span>
<span><span class="co">#&gt; ├── DESCRIPTION</span></span>
<span><span class="co">#&gt; ├── NAMESPACE</span></span>
<span><span class="co">#&gt; └── src</span></span>
<span><span class="co">#&gt;     ├── Makevars</span></span>
<span><span class="co">#&gt;     └── code.cpp</span></span></code></pre>
<p>We have an extremely minimal <code>DESCRIPTION</code>, which contains
line <code>LinkingTo: cpp11, dust</code> from which R will arrange
compiler flags to find both packages’ headers:</p>
<pre class="plain"><code>Package: piparallel
LinkingTo: cpp11, dust
Version: 0.0.1</code></pre>
<p>The <code>NAMESPACE</code> loads the dynamic library</p>
<pre class="plain"><code><span><span class="fu">useDynLib</span><span class="op">(</span><span class="st">"piparallel"</span>, .registration <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">exportPattern</span><span class="op">(</span><span class="st">"^[[:alpha:]]+"</span><span class="op">)</span></span></code></pre>
<p>The <code>src/Makevars</code> file contains important flags to pick
up OpenMP support:</p>
<pre class="make"><code>PKG_CXXFLAGS=-DHAVE_INLINE $(SHLIB_OPENMP_CXXFLAGS)
PKG_LIBS=$(SHLIB_OPENMP_CXXFLAGS)</code></pre>
<p>And <code>src/code.cpp</code> contains the file above but without the
<code>[[cpp11::linking_to(dust)]]</code> line:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cc"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cpp11.hpp&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dust/r/random.hpp&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="pp">#ifdef _OPENMP</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;omp.h&gt;</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="dt">double</span> pi_dust_parallel<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> cpp11<span class="op">::</span>sexp ptr<span class="op">,</span> <span class="dt">int</span> n_threads<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>  <span class="kw">auto</span> rng <span class="op">=</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>    dust<span class="op">::</span>random<span class="op">::</span>r<span class="op">::</span>rng_pointer_get<span class="op">&lt;</span>dust<span class="op">::</span>random<span class="op">::</span>xoshiro256plus<span class="op">&gt;(</span>ptr<span class="op">);</span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> n_streams <span class="op">=</span> rng<span class="op">-&gt;</span>size<span class="op">();</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>  <span class="dt">int</span> tot <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a><span class="pp">#ifdef _OPENMP</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a><span class="pp">#pragma omp parallel for schedule(static)  num_threads(n_threads) \</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a><span class="pp">  reduction(+:tot)</span></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n_streams<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>    <span class="kw">auto</span><span class="op">&amp;</span> state <span class="op">=</span> rng<span class="op">-&gt;</span>state<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>    <span class="dt">int</span> tot_i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a>      <span class="at">const</span> <span class="dt">double</span> u1 <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>random_real<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>state<span class="op">);</span></span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>      <span class="at">const</span> <span class="dt">double</span> u2 <span class="op">=</span> dust<span class="op">::</span>random<span class="op">::</span>random_real<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>state<span class="op">);</span></span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>u1 <span class="op">*</span> u1 <span class="op">+</span> u2 <span class="op">*</span> u2 <span class="op">&lt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>        tot_i<span class="op">++;</span></span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a>    tot <span class="op">+=</span> tot_i<span class="op">;</span></span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a>  <span class="cf">return</span> tot <span class="op">/</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>n <span class="op">*</span> n_streams<span class="op">)</span> <span class="op">*</span> <span class="fl">4.0</span><span class="op">;</span></span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>After compiling and installing the package,
<code>pi_dust_parallel</code> will be available</p>
<p>Now we have a parallel version we can see a speed-up as we add
threads:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">:::</span><span class="va"><a href="../reference/dust_rng_pointer.html">dust_rng_pointer</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>n_streams <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>  <span class="fu">pi_dust_parallel</span><span class="op">(</span><span class="fl">1e6</span>, <span class="va">rng</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu">pi_dust_parallel</span><span class="op">(</span><span class="fl">1e6</span>, <span class="va">rng</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu">pi_dust_parallel</span><span class="op">(</span><span class="fl">1e6</span>, <span class="va">rng</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  <span class="fu">pi_dust_parallel</span><span class="op">(</span><span class="fl">1e6</span>, <span class="va">rng</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 x 6</span></span>
<span><span class="co">#&gt;   expression                           min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt;                      &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 pi_dust_parallel(1e+06, rng, 1)   46.4ms   47.2ms      21.2        0B        0</span></span>
<span><span class="co">#&gt; 2 pi_dust_parallel(1e+06, rng, 2)   23.1ms   23.8ms      42.1        0B        0</span></span>
<span><span class="co">#&gt; 3 pi_dust_parallel(1e+06, rng, 3)   16.1ms   16.2ms      60.6        0B        0</span></span>
<span><span class="co">#&gt; 4 pi_dust_parallel(1e+06, rng, 4)   11.6ms   12.5ms      73.6        0B        0</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="more-on-the-pointer-object">More on the pointer object<a class="anchor" aria-label="anchor" href="#more-on-the-pointer-object"></a>
</h2>
<p>This section aims to de-mystify the pointer objects a little. The
dust random number state is a series of integers (by default 64-bit
unsigned integers) that are updated each time a state is drawn (see
<code>vignette("rng.Rmd")</code>). We expose this state to R as a vector
of “raw” values (literally a series of bytes of data).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="va"><a href="../reference/dust_rng.html">dust_rng</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">rng</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] c1 5c 02 89 ec 2d 0a 91 1e 61 39 74 08 ab 41 5e c3 86 8d 6d f4 02 8a b1 56</span></span>
<span><span class="co">#&gt; [26] 49 ee d9 dd 95 81 e2</span></span></code></pre></div>
<p>When numbers are drawn from the stream, the state is modified as a
side-effect:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span><span class="op">$</span><span class="fu">random_real</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 0.451351392 0.073534657 0.218129406 0.200139527 0.017172743 0.323288520</span></span>
<span><span class="co">#&gt;  [7] 0.338823899 0.862898581 0.005702738 0.006453255 0.844823829 0.222676329</span></span>
<span><span class="co">#&gt; [13] 0.665130023 0.283016916 0.502155564 0.290045309 0.055841255 0.083163285</span></span>
<span><span class="co">#&gt; [19] 0.391729373 0.744045249</span></span>
<span><span class="va">rng</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 2c ed 49 d0 8f 7e 97 2c 2a 5e 9e a1 78 85 47 80 06 d5 05 38 a3 5b 08 12 59</span></span>
<span><span class="co">#&gt; [26] 12 03 5c b3 ea 87 c8</span></span></code></pre></div>
<p>The same happens with our <code>dust_rng_pointer</code> objects used
above:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ptr</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="va"><a href="../reference/dust_rng_pointer.html">dust_rng_pointer</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">ptr</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] c1 5c 02 89 ec 2d 0a 91 1e 61 39 74 08 ab 41 5e c3 86 8d 6d f4 02 8a b1 56</span></span>
<span><span class="co">#&gt; [26] 49 ee d9 dd 95 81 e2</span></span></code></pre></div>
<p>Note that <code>ptr</code> starts with the same state here as
<code>rng</code> did because we started from the same seed. When we draw
20 numbers from the stream (by drawing 10 pairs of numbers with our
pi-estimation algorithm), we will advance the state</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pi_dust</span><span class="op">(</span><span class="fl">10</span>, <span class="va">ptr</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span><span class="va">ptr</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 2c ed 49 d0 8f 7e 97 2c 2a 5e 9e a1 78 85 47 80 06 d5 05 38 a3 5b 08 12 59</span></span>
<span><span class="co">#&gt; [26] 12 03 5c b3 ea 87 c8</span></span></code></pre></div>
<p>Note that the state here now matches the value returned by
<code>rng</code>.</p>
<p>Normally nobody needs to know this - treat the pointer as an object
that you pass to functions and ignore the details.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rich FitzJohn, Alex Hill, John Lees.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
