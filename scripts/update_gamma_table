#!/usr/bin/env Rscript
stirling_tail <- function(k) {
  lgamma(k + 1) - (log(sqrt(2 * pi)) + (k + 0.5) * log(k + 1) - (k + 1))
}

substitute_template <- function(data, src, dest) {
  template <- read_lines(src)
  txt <- glue_whisker(template, data)
  writeLines(txt, dest)
}

glue_whisker <- function(template, data) {
  glue::glue(template, .envir = data, .open = "{{", .close = "}}",
             .trim = FALSE)
}

len_f <- 128L
len_d <- 10L

values_f <- vapply(stirling_tail(seq_len(len_f) - 1L), deparse, "",
                   control = "digits17")
values_d <- vapply(stirling_tail(seq_len(len_d) - 1L), deparse, "",
                   control = "digits17")

header <- "// Generated by scripts/update_gamma_table - do not edit"

fmt <- function(x) {
  paste(paste0("  ", x), collapse = ",\n")
}

data <- list(
  header = header,
  k_max_f = len_f - 1,
  k_max_d = len_d - 1,
  values_float = fmt(paste0(values_f, "f")),
  values_double = fmt(values_d))

root <- here::here()

dest <- file.path(root, "inst/include/dust/random/gamma_table.hpp")
template <- paste(
  readLines(file.path(root, "inst/template/gamma_table.hpp")),
  collapse = "\n")
writeLines(glue_whisker(template, data), dest)
