#!/usr/bin/env Rscript
stirling_approx_tail <- function(k) {
  kp1sq <- (k + 1)^2
  (1.0 / 12 - (1.0 / 360 - 1.0 / 1260 / kp1sq) / kp1sq) / (k + 1)
}

substitute_template <- function(data, src, dest) {
  template <- read_lines(src)
  txt <- glue_whisker(template, data)
  writeLines(txt, dest)
}

glue_whisker <- function(template, data) {
  glue::glue(template, .envir = data, .open = "{{", .close = "}}",
             .trim = FALSE)
}

len <- 128L

values <- vapply(stirling_approx_tail(seq_len(len) - 1L), deparse, "",
                 control = "digits17")

header <- "// Generated by scripts/update_gamma_table - do not edit"

fmt <- function(x) {
  paste(paste0("  ", x), collapse = ",\n")
}

data <- list(
  header = header,
  max_k = len - 1,
  values_float = fmt(paste0(values, "f")),
  values_double = fmt(values))

root <- here::here()

dest <- file.path(root, "inst/include/dust/distr/gamma_table.hpp")
template <- paste(
  readLines(file.path(root, "inst/template/gamma_table.hpp")),
  collapse = "\n")
writeLines(glue_whisker(template, data), dest)
