<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Create a dust model from a C++ input file — dust • dust</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Create a dust model from a C++ input file — dust"><meta property="og:description" content="Create a dust model from a C++ input file.  This function will
compile the dust support around your model and return an object
that can be used to work with the model (see the Details below,
and dust_generator)."><meta property="og:image" content="/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dust</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.15.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/dust.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/design.html">Principles and design of dust</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Random numbers</li>
    <li>
      <a href="../articles/rng.html">Random number generation</a>
    </li>
    <li>
      <a href="../articles/rng_algorithms.html">Algorithms used to compute random numbers</a>
    </li>
    <li>
      <a href="../articles/rng_package.html">Using RNGs from packages</a>
    </li>
    <li>
      <a href="../articles/rng_distributed.html">Distributed parallel random numbers</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Dive deeper</li>
    <li>
      <a href="../articles/data.html">Comparing models and data</a>
    </li>
    <li>
      <a href="../articles/gpu.html">Running models on GPUs with CUDA</a>
    </li>
    <li>
      <a href="../articles/multi.html">Multiple parameter sets</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/mrc-ide/dust/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Create a dust model from a C++ input file</h1>
    <small class="dont-index">Source: <a href="https://github.com/mrc-ide/dust/blob/master/R/interface.R" class="external-link"><code>R/interface.R</code></a></small>
    <div class="hidden name"><code>dust.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Create a dust model from a C++ input file.  This function will
compile the dust support around your model and return an object
that can be used to work with the model (see the Details below,
and <code><a href="dust_generator.html">dust_generator</a></code>).</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">dust</span><span class="op">(</span></span>
<span>  <span class="va">filename</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  workdir <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  gpu <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  real_type <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  linking_to <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  cpp_std <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  compiler_options <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  optimisation_level <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  skip_cache <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>


<dl><dt id="arg-filename">filename<a class="anchor" aria-label="anchor" href="#arg-filename"></a></dt>
<dd><p>The path to a single C++ file</p></dd>


<dt id="arg-quiet">quiet<a class="anchor" aria-label="anchor" href="#arg-quiet"></a></dt>
<dd><p>Logical, indicating if compilation messages from
<code>pkgbuild</code> should be displayed.  Error messages will be
displayed on compilation failure regardless of the value used.</p></dd>


<dt id="arg-workdir">workdir<a class="anchor" aria-label="anchor" href="#arg-workdir"></a></dt>
<dd><p>Optional working directory to use.  If <code>NULL</code>
uses a temporary directory.  By using a different directory of
your choosing you can see the generated code.</p></dd>


<dt id="arg-gpu">gpu<a class="anchor" aria-label="anchor" href="#arg-gpu"></a></dt>
<dd><p>Logical, indicating if we should generate GPU
code. This requires a considerable amount of additional software
installed (CUDA toolkit and drivers) as well as a
CUDA-compatible GPU. If <code>TRUE</code>, then we call
<a href="dust_cuda_options.html">dust_cuda_options</a> with no arguments. Alternatively, call
that function and pass the value here (e.g, <code>gpu = dust::dust_cuda_options(debug = TRUE)</code>). Note that due to the
use of the <code>__syncwarp()</code> primitive this may require a GPU with
compute version 70 or higher.</p></dd>


<dt id="arg-real-type">real_type<a class="anchor" aria-label="anchor" href="#arg-real-type"></a></dt>
<dd><p>Optionally, a string indicating a substitute type to
swap in for your model's <code>real_type</code> declaration. If given, then we
replace the string <code>using real_type = (double|float)</code> with the
given type. This is primarily intended to be used as <code>gpu = TRUE, real_type = "float"</code> in order to create model for the GPU
that will use 32 bit <code>floats</code> (rather than 64 bit doubles, which
are much slower). For CPU models decreasing precision of your
real type will typically just decrease precision for no
additional performance.</p></dd>


<dt id="arg-linking-to">linking_to<a class="anchor" aria-label="anchor" href="#arg-linking-to"></a></dt>
<dd><p>Optionally, a character vector of additional
packages to add to the <code>DESCRIPTION</code>'s <code>LinkingTo</code> field. Use
this when your model pulls in C++ code that is packaged within
another package's header-only library.</p></dd>


<dt id="arg-cpp-std">cpp_std<a class="anchor" aria-label="anchor" href="#arg-cpp-std"></a></dt>
<dd><p>The C++ standard to use, if you need to set one
explicitly. See the section "Using C++ code" in "Writing R
extensions" for the details of this, and how it interacts with
the R version currently being used. For R 4.0.0 and above, C++11
will be used; as dust depends on at least this version of R you
will never need to specify a version this low. Sensible options
are <code>C++14</code>, <code>C++17</code>, etc, depending on the features you need
and what your compiler supports.</p></dd>


<dt id="arg-compiler-options">compiler_options<a class="anchor" aria-label="anchor" href="#arg-compiler-options"></a></dt>
<dd><p>A character vector of additional options
to pass through to the C++ compiler. These will be passed
through without any shell quoting or validation, so check the
generated commands and outputs carefully in case of error. Note
that R will apply these <em>before</em> anything in your personal
<code>Makevars</code>.</p></dd>


<dt id="arg-optimisation-level">optimisation_level<a class="anchor" aria-label="anchor" href="#arg-optimisation-level"></a></dt>
<dd><p>A shorthand way of specifying common
compiler options that control optimisation level. By default
(<code>NULL</code>) no options are generated from this, and the
optimisation level will depend on your user <code>Makevars</code> file.
Valid options are <code>none</code> which disables optimisation (<code>-O0</code>),
which will be faster to compile but much slower, <code>standard</code>
which enables standard level of optimisation (<code>-O2</code>), useful if
your Makevars/pkgload configuration is disabling optimisation,
or <code>max</code> (<code>-O3</code> and <code>--fast-math</code>) which enables some
slower-to-compile and <a href="https://simonbyrne.github.io/notes/fastmath/" class="external-link">potentially unsafe</a>
optimisations.  These options are applied <em>after</em>
<code>compiler_options</code> and may override options provided there.
Note that as for <code>compiler_options</code>, R will apply these <em>before</em>
anything in your personal <code>Makevars</code></p></dd>


<dt id="arg-skip-cache">skip_cache<a class="anchor" aria-label="anchor" href="#arg-skip-cache"></a></dt>
<dd><p>Logical, indicating if the cache of previously
compiled models should be skipped. If <code>TRUE</code> then your model will
not be looked for in the cache, nor will it be added to the
cache after compilation.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>A <code><a href="dust_generator.html">dust_generator</a></code> object based on your source files</p>
    </div>
    <div id="input-requirements">
    <h2>Input requirements</h2>



<p>Your input dust model must satisfy a few requirements.</p><ul><li><p>Define some class that implements your model (below <code>model</code> is
assumed to be the class name)</p></li>
<li><p>That class must define a type <code>internal_type</code> (so
<code>model::internal_type</code>) that contains its internal data that the
model may change during execution (i.e., that is not shared
between particles). If no such data is needed, you can do
<code>using internal_type = dust::no_internal;</code> to indicate this.</p></li>
<li><p>We also need a type <code>shared_type</code> that contains <em>constant</em> internal
data is shared between particles (e.g., dimensions, arrays that
are read but not written). If no such data is needed, you can do
<code>using share_type = dust::no_shared;</code> to indicate this.</p></li>
<li><p>That class must also include a type alias that describes the
model's floating point type, <code>real_type</code>. Most models can include
<code>using real_type = double;</code> in their public section.</p></li>
<li><p>The class must also include a type alias that describes the model's
<em>data</em> type. If your model does not support data, then write
<code>using data_type = dust::no_data;</code>, which disables the
<code>compare_data</code> and <code>set_data</code> methods.  Otherwise see
<code><a href="../articles/data.html">vignette("data")</a></code> for more information.</p></li>
<li><p>The class must have a constructor that accepts <code>const dust::pars_type&lt;model&gt;&amp; pars</code> for your type <code>model</code>. This will have
elements <code>shared</code> and <code>internal</code> which you can assign into your
model if needed.</p></li>
<li><p>The model must have a method <code>size()</code> returning <code>size_t</code> which
returns the size of the system. This size may depend on values
in your initialisation object but is constant within a model
run.</p></li>
<li><p>The model must have a method <code>initial</code> (which may not be
<code>const</code>), taking a time step number (<code>size_t</code>) and returning a
<code>std::vector&lt;real_type&gt;</code> of initial state for the model.</p></li>
<li><p>The model must have a method <code>update</code> taking arguments:</p><ul><li><p><code>size_t time</code>: the time step number</p></li>
<li><p><code>const double * state</code>: the state at the beginning of the
time step</p></li>
<li><p><code>dust::rng_state_type&lt;real_type&gt;&amp; rng_state</code>: the dust random number
generator state - this <em>must</em> be a reference, as it will be modified
as random numbers are drawn</p></li>
<li><p><code>double *state_next</code>: the end state of the model
(to be written to by your function)</p></li>
</ul></li>
</ul><p>Your <code>update</code> function is the core here and should update the
state of the system - you are expected to update all values of
<code>state</code> on return.</p>
<p>It is very important that none of the functions in the class use
the R API in any way as these functions will be called in
parallel.</p>
<p>You must also provide a data/parameter-wrangling function for
producing an object of type <code>dust::pars_type&lt;model&gt;</code> from an R list.  We
use cpp11 for this.  Your function will look like:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>namespace dust {</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>template <span class="sc">&lt;</span><span class="er">&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>dust<span class="sc">::</span>pars_type<span class="sc">&lt;</span>model<span class="sc">&gt;</span> dust_pars<span class="sc">&lt;</span>model<span class="sc">&gt;</span>(cpp11<span class="sc">::</span>list pars) {</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  <span class="sc">/</span><span class="er">/</span> ...</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  return dust<span class="sc">::</span>pars_type<span class="sc">&lt;</span>model<span class="sc">&gt;</span>(shared, internal);</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>}</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>}</span></code></pre><p></p></div>
<p>With the body interacting with <code>pars</code> to create an object of type
<code>model::shared_type</code> and <code>model::internal_type</code> before returning the
<code>dust::pars_type</code> object.  This function will be called in serial
and may use anything in the cpp11 API.  All elements of the
returned object must be standard C/C++ (e.g., STL) types and
<em>not</em> cpp11/R types. If your model uses only shared or internal,
you may use the single-argument constructor overload to
<code>dust::pars_type</code> which is equivalent to using <code>dust::no_shared</code> or
<code>dust::no_internal</code> for the missing argument.</p>
<p>Your model <em>may</em> provided a template specialisation
<code>dust::dust_info&lt;model&gt;()</code> returning a <code>cpp11::sexp</code> for
returning arbitrary information back to the R session:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>namespace dust {</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>template <span class="sc">&lt;</span><span class="er">&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>cpp11<span class="sc">::</span>sexp dust_info<span class="sc">&lt;</span>model<span class="sc">&gt;</span>(const dust<span class="sc">::</span>pars_type<span class="sc">&lt;</span>sir<span class="sc">&gt;</span><span class="er">&amp;</span> pars) {</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  return cpp11<span class="sc">::</span><span class="fu">wrap</span>(...);</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>}</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>}</span></code></pre><p></p></div>
<p>What you do with this is up to you. If not present then the
<code>info()</code> method on the created object will return <code>NULL</code>.
Potential use cases for this are to return information about
variable ordering, or any processing done while accepting the
pars object used to create the pars fed into the particles.</p>
    </div>
    <div id="configuring-your-model">
    <h2>Configuring your model</h2>



<p>You can optionally use C++ pseudo-attributes to configure the
generated code. Currently we support two attributes:</p><ul><li><p><code>[[dust::class(classname)]]</code> will tell dust the name of your
target C++ class (in this example <code>classname</code>). You will need to
use this if your file uses more than a single class, as
otherwise will try to detect this using extremely simple
heuristics.</p></li>
<li><p><code>[[dust::name(modelname)]]</code> will tell dust the name to use for
the class in R code. For technical reasons this must be
alphanumeric characters only (sorry, no underscore) and must not
start with a number. If not included then the C++ type name will
be used (either specified with <code>[[dust::class()]]</code> or detected).</p></li>
</ul></div>
    <div id="error-handling">
    <h2>Error handling</h2>



<p>Your model should only throw exceptions as a last resort. One such
last resort exists already if <code>rbinom</code> is given invalid inputs
to prevent an infinite loop. If an error is thrown, all
particles will complete their current run, and then the error
will be rethrown - this is required by our parallel processing
design. Once this happens though the state of the system is
"inconsistent" as it contains particles that have run for
different lengths of time. You can extract the state of the
system at the point of failure (which may help with debugging)
but you will be unable to continue running the object until
either you reset it (with <code>$update_state()</code>). An error will be
thrown otherwise.</p>
<p>Things are worse on a GPU; if an error is thrown by the RNG code
(happens in <code>rbinom</code> when given impossible inputs such as
negative sizes, probabilities less than zero or greater than 1)
then we currently use CUDA's <code>__trap()</code> function which will
require a process restart to be able to use anything that uses
the GPU again, covering all methods in the class.  However, this
is preferable to the infinite loop that would otherwise be
caused.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="dust_generator.html">dust_generator</a></code> for a description of the class
of created objects, and <code><a href="dust_example.html">dust_example()</a></code> for some
pre-built examples. If you want to just generate the code and
load it yourself with <code><a href="https://pkgload.r-lib.org/reference/load_all.html" class="external-link">pkgload::load_all</a></code> or some other means,
see <code><a href="dust_generate.html">dust_generate</a></code>)</p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># dust includes a couple of very simple examples</span></span></span>
<span class="r-in"><span><span class="va">filename</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/walk.cpp"</span>, package <span class="op">=</span> <span class="st">"dust"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># This model implements a random walk with a parameter coming from</span></span></span>
<span class="r-in"><span><span class="co"># R representing the standard deviation of the walk</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> class walk {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> public:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   using real_type = double;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   using data_type = dust::no_data;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   using internal_type = dust::no_internal;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   using rng_state_type = dust::random::generator&lt;real_type&gt;;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   struct shared_type {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     real_type sd;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     bool random_initial;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   };</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   walk(const dust::pars_type&lt;walk&gt;&amp; pars) : shared(pars.shared) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   size_t size() const {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     return 1;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   std::vector&lt;real_type&gt; initial(size_t time, rng_state_type&amp; rng_state) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     std::vector&lt;real_type&gt; ret = {0};</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (shared-&gt;random_initial) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       ret[0] = dust::random::normal&lt;real_type&gt;(rng_state, 0, shared-&gt;sd);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     return ret;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   void update(size_t time, const real_type * state, rng_state_type&amp; rng_state,</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>               real_type * state_next) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     state_next[0] = state[0] +</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       dust::random::normal&lt;real_type&gt;(rng_state, 0, shared-&gt;sd);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> private:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   dust::shared_ptr&lt;walk&gt; shared;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> };</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> namespace dust {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> template &lt;&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> dust::pars_type&lt;walk&gt; dust_pars&lt;walk&gt;(cpp11::list pars) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   walk::real_type sd = cpp11::as_cpp&lt;walk::real_type&gt;(pars["sd"]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   const bool random_initial = pars["random_initial"] == R_NilValue ? false :</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     cpp11::as_cpp&lt;bool&gt;(pars["random_initial"]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   return dust::pars_type&lt;walk&gt;(walk::shared_type{sd, random_initial});</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The model can be compiled and loaded with dust::dust(filename)</span></span></span>
<span class="r-in"><span><span class="co"># but it's faster in this example to use the prebuilt version in</span></span></span>
<span class="r-in"><span><span class="co"># the package</span></span></span>
<span class="r-in"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">dust</span><span class="fu">::</span><span class="fu"><a href="dust_example.html">dust_example</a></span><span class="op">(</span><span class="st">"walk"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Print the object and you can see the methods that it provides</span></span></span>
<span class="r-in"><span><span class="va">model</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;dust&gt; object generator</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Public:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     initialize: function (pars, time, n_particles, n_threads = 1L, seed = NULL, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     name: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     param: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     run: function (time_end) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     simulate: function (time_end) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     run_adjoint: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     set_index: function (index) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     index: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ode_control: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ode_statistics: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_threads: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_state: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_particles: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_particles_each: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     shape: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     update_state: function (pars = NULL, state = NULL, time = NULL, set_initial_state = NULL, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     state: function (index = NULL) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     time: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     set_stochastic_schedule: function (time) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     reorder: function (index) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     resample: function (weights) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     info: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     pars: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     rng_state: function (first_only = FALSE, last_only = FALSE) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     set_rng_state: function (rng_state) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     has_openmp: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     has_gpu_support: function (fake_gpu = FALSE) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     has_compare: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     real_size: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     time_type: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     rng_algorithm: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     uses_gpu: function (fake_gpu = FALSE) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_pars: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     set_n_threads: function (n_threads) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     set_data: function (data, shared = FALSE) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     compare_data: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     filter: function (time_end = NULL, save_trajectories = FALSE, time_snapshot = NULL, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     gpu_info: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Private:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     pars_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     pars_multi_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     index_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     info_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_threads_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_particles_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_particles_each_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     shape_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ptr_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     gpu_config_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ode_control_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     methods_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     param_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     reload_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Parent env: &lt;environment: namespace:dust&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Locked objects: TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Locked class: FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Portable: TRUE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create a model with standard deviation of 1, initial time step zero</span></span></span>
<span class="r-in"><span><span class="co"># and 30 particles</span></span></span>
<span class="r-in"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">30</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">obj</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;dust&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Public:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     compare_data: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     filter: function (time_end = NULL, save_trajectories = FALSE, time_snapshot = NULL, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     gpu_info: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     has_compare: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     has_gpu_support: function (fake_gpu = FALSE) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     has_openmp: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     index: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     info: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     initialize: function (pars, time, n_particles, n_threads = 1L, seed = NULL, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_pars: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_particles: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_particles_each: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_state: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_threads: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     name: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ode_control: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ode_statistics: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     param: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     pars: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     real_size: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     reorder: function (index) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     resample: function (weights) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     rng_algorithm: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     rng_state: function (first_only = FALSE, last_only = FALSE) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     run: function (time_end) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     run_adjoint: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     set_data: function (data, shared = FALSE) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     set_index: function (index) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     set_n_threads: function (n_threads) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     set_rng_state: function (rng_state) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     set_stochastic_schedule: function (time) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     shape: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     simulate: function (time_end) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     state: function (index = NULL) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     time: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     time_type: function () </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     update_state: function (pars = NULL, state = NULL, time = NULL, set_initial_state = NULL, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     uses_gpu: function (fake_gpu = FALSE) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Private:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     gpu_config_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     index_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     info_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     methods_: list</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_particles_: 30</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_particles_each_: 30</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n_threads_: 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ode_control_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     param_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     pars_: list</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     pars_multi_: FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ptr_: externalptr</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     reload_: NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     shape_: 30</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Curent state is all zero</span></span></span>
<span class="r-in"><span><span class="va">obj</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]    0    0    0    0    0    0    0    0    0     0     0     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24] [,25] [,26]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]     0     0     0     0     0     0     0     0     0     0     0     0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,27] [,28] [,29] [,30]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]     0     0     0     0</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Current time is also zero</span></span></span>
<span class="r-in"><span><span class="va">obj</span><span class="op">$</span><span class="fu">time</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Run the model up to time step 100</span></span></span>
<span class="r-in"><span><span class="va">obj</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           [,1]     [,2]     [,3]       [,4]     [,5]     [,6]      [,7]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] -2.746012 9.349137 2.845653 -0.4137361 10.94929 1.134218 -1.739739</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          [,8]      [,9]     [,10]     [,11]    [,12]     [,13]     [,14]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 20.00793 -1.270901 -33.45582 -0.242807 19.33025 -2.876218 -10.63793</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         [,15]    [,16]     [,17]    [,18]    [,19]     [,20]     [,21]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 1.340985 -1.82075 -9.159877 1.239593 2.730351 -10.55075 -4.682868</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          [,22]    [,23]    [,24]    [,25]     [,26]    [,27]     [,28]   [,29]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] -7.655092 1.505218 3.500206 2.421093 -10.01219 5.474364 -6.221595 13.8492</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          [,30]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] -12.36381</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Reorder/resample the particles:</span></span></span>
<span class="r-in"><span><span class="va">obj</span><span class="op">$</span><span class="fu">reorder</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">30</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># See the state again</span></span></span>
<span class="r-in"><span><span class="va">obj</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          [,1]     [,2]     [,3]     [,4]       [,5]     [,6]      [,7]     [,8]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 10.94929 1.134218 1.340985 1.340985 -0.4137361 1.134218 -1.270901 10.94929</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          [,9]    [,10]    [,11]     [,12]    [,13]     [,14]    [,15]     [,16]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 10.94929 3.500206 1.340985 -2.876218 9.349137 -12.36381 1.505218 -0.242807</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          [,17]     [,18]    [,19]     [,20]    [,21]   [,22]    [,23]    [,24]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] -12.36381 -0.242807 10.94929 -4.682868 19.33025 13.8492 9.349137 1.134218</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           [,25]    [,26]    [,27]    [,28]    [,29]     [,30]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] -0.4137361 -1.82075 9.349137 2.845653 2.421093 -7.655092</span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Rich FitzJohn, Alex Hill, John Lees.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer></div>






  </body></html>

