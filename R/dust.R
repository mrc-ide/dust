## Generated by dust (version 0.11.3) - do not edit
sir <- R6::R6Class(
  "dust",
  cloneable = FALSE,

  private = list(
    pars_ = NULL,
    pars_multi_ = NULL,
    index_ = NULL,
    info_ = NULL,
    n_threads_ = NULL,
    n_particles_ = NULL,
    n_particles_each_ = NULL,
    shape_ = NULL,
    ptr_ = NULL,
    device_config_ = NULL,
    methods_ = NULL,
    param_ = list(I0 = list(required = FALSE),
     beta = list(required = FALSE),
     gamma = list(required = FALSE),
     exp_noise = list(required = FALSE))
  ),

  public = list(
    initialize = function(pars, step, n_particles, n_threads = 1L,
                          seed = NULL, pars_multi = FALSE,
                          deterministic = FALSE,
                          device_config = NULL) {
      if (is.null(device_config)) {
        private$methods_ <- list(
           alloc = dust_cpu_sir_alloc,
           run = dust_cpu_sir_run,
           simulate = dust_cpu_sir_simulate,
           set_index = dust_cpu_sir_set_index,
           n_state = dust_cpu_sir_n_state,
           update_state = dust_cpu_sir_update_state,
           state = dust_cpu_sir_state,
           step = dust_cpu_sir_step,
           reorder = dust_cpu_sir_reorder,
           resample = dust_cpu_sir_resample,
           rng_state = dust_cpu_sir_rng_state,
           set_rng_state = dust_cpu_sir_set_rng_state,
           set_n_threads = dust_cpu_sir_set_n_threads,
           set_data = dust_cpu_sir_set_data,
           compare_data = dust_cpu_sir_compare_data,
           filter = dust_cpu_sir_filter)
      } else {
        private$methods_ <- list(alloc = function(...) {
          stop("GPU support not enabled for this object")
        })
      }
      res <- private$methods_$alloc(pars, pars_multi, step, n_particles,
                        n_threads, seed, deterministic, device_config)
      private$pars_ <- pars
      private$pars_multi_ <- pars_multi
      private$n_threads_ <- n_threads
      private$ptr_ <- res[[1L]]
      private$info_ <- res[[2L]]
      private$shape_ <- res[[3L]]
      private$device_config_ <- res[[4L]]
      private$n_particles_ <- prod(private$shape_)
      if (pars_multi) {
        private$n_particles_each_ <- private$n_particles_ / length(pars)
      } else {
        private$n_particles_each_ <- private$n_particles_
      }
    },

    name = function() {
      "sir"
    },

    param = function() {
      private$param_
    },

    run = function(step_end) {
      m <- private$methods_$run(private$ptr_, step_end)
      rownames(m) <- names(private$index_)
      m
    },

    simulate = function(step_end) {
      m <- private$methods_$simulate(private$ptr_, step_end)
      rownames(m) <- names(private$index_)
      m
    },

    set_index = function(index) {
      private$methods_$set_index(private$ptr_, index)
      private$index_ <- index
      invisible()
    },

    index = function() {
      private$index_
    },

    n_threads = function() {
      private$n_threads_
    },

    n_state = function() {
      private$methods_$n_state(private$ptr_)
    },

    n_particles = function() {
      private$n_particles_
    },

    n_particles_each = function() {
      private$n_particles_each_
    },

    shape = function() {
      private$shape_
    },

    set_state = function(state, step = NULL) {
      if (is.null(step)) {
        .Deprecated("$update_state(state = state)",
                    old = "$set_state(state)")
      } else {
        .Deprecated("$update_state(state = state, step = step)",
                    old = "$set_state(state, step)")
      }
      self$update_state(state = state, step = step)
    },

    reset = function(pars, step) {
      .Deprecated("$update_state(pars = pars, step = step)",
                  old = "$reset(pars, step)")
      self$update_state(pars = pars, step = step)
    },

    set_pars = function(pars) {
      .Deprecated("$update_state(pars = pars)",
                  old = "$set_pars(pars)")
      self$update_state(pars = pars, set_initial_state = FALSE)
    },

    update_state = function(pars = NULL, state = NULL, step = NULL,
                            set_initial_state = NULL) {
      info <- private$methods_$update_state(private$ptr_, pars, state, step,
                                          set_initial_state)
      if (!is.null(pars)) {
        private$info_ <- info
        private$pars_ <- pars
      }
      invisible()
    },

    state = function(index = NULL) {
      m <- private$methods_$state(private$ptr_, index)
      rownames(m) <- names(index)
      m
    },

    step = function() {
      private$methods_$step(private$ptr_)
    },

    reorder = function(index) {
      storage.mode(index) <- "integer"
      private$methods_$reorder(private$ptr_, index)
      invisible()
    },

    resample = function(weights) {
      invisible(private$methods_$resample(private$ptr_, weights))
    },

    info = function() {
      private$info_
    },

    pars = function() {
      private$pars_
    },

    rng_state = function(first_only = FALSE, last_only = FALSE) {
      private$methods_$rng_state(private$ptr_, first_only, last_only)
    },

    set_rng_state = function(rng_state) {
      private$methods_$set_rng_state(private$ptr_, rng_state)
      invisible()
    },

    has_openmp = function() {
      dust_sir_capabilities()[["openmp"]]
    },

    has_cuda = function(fake_gpu = FALSE) {
      if (fake_gpu) {
        FALSE
      } else {
        dust_sir_capabilities()[["cuda"]]
      }
    },

    uses_gpu = function(fake_gpu = FALSE) {
      real_gpu <- private$device_config_$real_gpu
      !is.null(real_gpu) && (fake_gpu || real_gpu)
    },

    n_pars = function() {
      if (private$pars_multi_) length(private$pars_) else 0L
    },

    set_n_threads = function(n_threads) {
      prev <- private$n_threads_
      private$methods_$set_n_threads(private$ptr_, n_threads)
      private$n_threads_ <- n_threads
      invisible(prev)
    },

    has_compare = function() {
      dust_sir_capabilities()[["compare"]]
    },

    set_data = function(data) {
      private$methods_$set_data(private$ptr_, data)
    },

    compare_data = function() {
      private$methods_$compare_data(private$ptr_)
    },

    filter = function(save_trajectories = FALSE, step_snapshot = NULL) {
      private$methods_$filter(private$ptr_, save_trajectories, step_snapshot)
    },

    gpu_info = function() {
      ret <- dust_sir_gpu_info()
      parent <- parent.env(environment())
      if (ret$has_cuda && exists("private", parent, inherits = FALSE)) {
        ret$config <- private$device_config_
      }
      ret
    }
  ))
class(sir) <- c("dust_generator", class(sir))
sirs <- R6::R6Class(
  "dust",
  cloneable = FALSE,

  private = list(
    pars_ = NULL,
    pars_multi_ = NULL,
    index_ = NULL,
    info_ = NULL,
    n_threads_ = NULL,
    n_particles_ = NULL,
    n_particles_each_ = NULL,
    shape_ = NULL,
    ptr_ = NULL,
    device_config_ = NULL,
    methods_ = NULL,
    param_ = list(freq = list(required = FALSE, default = 1),
     alpha = list(required = FALSE, default = 0.1),
     beta = list(required = FALSE, default = 0.2),
     gamma = list(required = FALSE, default = 0.1))
  ),

  public = list(
    initialize = function(pars, step, n_particles, n_threads = 1L,
                          seed = NULL, pars_multi = FALSE,
                          deterministic = FALSE,
                          device_config = NULL) {
      if (is.null(device_config)) {
        private$methods_ <- list(
           alloc = dust_cpu_sirs_alloc,
           run = dust_cpu_sirs_run,
           simulate = dust_cpu_sirs_simulate,
           set_index = dust_cpu_sirs_set_index,
           n_state = dust_cpu_sirs_n_state,
           update_state = dust_cpu_sirs_update_state,
           state = dust_cpu_sirs_state,
           step = dust_cpu_sirs_step,
           reorder = dust_cpu_sirs_reorder,
           resample = dust_cpu_sirs_resample,
           rng_state = dust_cpu_sirs_rng_state,
           set_rng_state = dust_cpu_sirs_set_rng_state,
           set_n_threads = dust_cpu_sirs_set_n_threads,
           set_data = dust_cpu_sirs_set_data,
           compare_data = dust_cpu_sirs_compare_data,
           filter = dust_cpu_sirs_filter)
      } else {
        private$methods_ <- list(
           alloc = dust_gpu_sirs_alloc,
           run = dust_gpu_sirs_run,
           simulate = dust_gpu_sirs_simulate,
           set_index = dust_gpu_sirs_set_index,
           n_state = dust_gpu_sirs_n_state,
           update_state = dust_gpu_sirs_update_state,
           state = dust_gpu_sirs_state,
           step = dust_gpu_sirs_step,
           reorder = dust_gpu_sirs_reorder,
           resample = dust_gpu_sirs_resample,
           rng_state = dust_gpu_sirs_rng_state,
           set_rng_state = dust_gpu_sirs_set_rng_state,
           set_n_threads = dust_gpu_sirs_set_n_threads,
           set_data = dust_gpu_sirs_set_data,
           compare_data = dust_gpu_sirs_compare_data,
           filter = dust_gpu_sirs_filter)
      }
      res <- private$methods_$alloc(pars, pars_multi, step, n_particles,
                        n_threads, seed, deterministic, device_config)
      private$pars_ <- pars
      private$pars_multi_ <- pars_multi
      private$n_threads_ <- n_threads
      private$ptr_ <- res[[1L]]
      private$info_ <- res[[2L]]
      private$shape_ <- res[[3L]]
      private$device_config_ <- res[[4L]]
      private$n_particles_ <- prod(private$shape_)
      if (pars_multi) {
        private$n_particles_each_ <- private$n_particles_ / length(pars)
      } else {
        private$n_particles_each_ <- private$n_particles_
      }
    },

    name = function() {
      "sirs"
    },

    param = function() {
      private$param_
    },

    run = function(step_end) {
      m <- private$methods_$run(private$ptr_, step_end)
      rownames(m) <- names(private$index_)
      m
    },

    simulate = function(step_end) {
      m <- private$methods_$simulate(private$ptr_, step_end)
      rownames(m) <- names(private$index_)
      m
    },

    set_index = function(index) {
      private$methods_$set_index(private$ptr_, index)
      private$index_ <- index
      invisible()
    },

    index = function() {
      private$index_
    },

    n_threads = function() {
      private$n_threads_
    },

    n_state = function() {
      private$methods_$n_state(private$ptr_)
    },

    n_particles = function() {
      private$n_particles_
    },

    n_particles_each = function() {
      private$n_particles_each_
    },

    shape = function() {
      private$shape_
    },

    set_state = function(state, step = NULL) {
      if (is.null(step)) {
        .Deprecated("$update_state(state = state)",
                    old = "$set_state(state)")
      } else {
        .Deprecated("$update_state(state = state, step = step)",
                    old = "$set_state(state, step)")
      }
      self$update_state(state = state, step = step)
    },

    reset = function(pars, step) {
      .Deprecated("$update_state(pars = pars, step = step)",
                  old = "$reset(pars, step)")
      self$update_state(pars = pars, step = step)
    },

    set_pars = function(pars) {
      .Deprecated("$update_state(pars = pars)",
                  old = "$set_pars(pars)")
      self$update_state(pars = pars, set_initial_state = FALSE)
    },

    update_state = function(pars = NULL, state = NULL, step = NULL,
                            set_initial_state = NULL) {
      info <- private$methods_$update_state(private$ptr_, pars, state, step,
                                          set_initial_state)
      if (!is.null(pars)) {
        private$info_ <- info
        private$pars_ <- pars
      }
      invisible()
    },

    state = function(index = NULL) {
      m <- private$methods_$state(private$ptr_, index)
      rownames(m) <- names(index)
      m
    },

    step = function() {
      private$methods_$step(private$ptr_)
    },

    reorder = function(index) {
      storage.mode(index) <- "integer"
      private$methods_$reorder(private$ptr_, index)
      invisible()
    },

    resample = function(weights) {
      invisible(private$methods_$resample(private$ptr_, weights))
    },

    info = function() {
      private$info_
    },

    pars = function() {
      private$pars_
    },

    rng_state = function(first_only = FALSE, last_only = FALSE) {
      private$methods_$rng_state(private$ptr_, first_only, last_only)
    },

    set_rng_state = function(rng_state) {
      private$methods_$set_rng_state(private$ptr_, rng_state)
      invisible()
    },

    has_openmp = function() {
      dust_sirs_capabilities()[["openmp"]]
    },

    has_cuda = function(fake_gpu = FALSE) {
      if (fake_gpu) {
        TRUE
      } else {
        dust_sirs_capabilities()[["cuda"]]
      }
    },

    uses_gpu = function(fake_gpu = FALSE) {
      real_gpu <- private$device_config_$real_gpu
      !is.null(real_gpu) && (fake_gpu || real_gpu)
    },

    n_pars = function() {
      if (private$pars_multi_) length(private$pars_) else 0L
    },

    set_n_threads = function(n_threads) {
      prev <- private$n_threads_
      private$methods_$set_n_threads(private$ptr_, n_threads)
      private$n_threads_ <- n_threads
      invisible(prev)
    },

    has_compare = function() {
      dust_sirs_capabilities()[["compare"]]
    },

    set_data = function(data) {
      private$methods_$set_data(private$ptr_, data)
    },

    compare_data = function() {
      private$methods_$compare_data(private$ptr_)
    },

    filter = function(save_trajectories = FALSE, step_snapshot = NULL) {
      private$methods_$filter(private$ptr_, save_trajectories, step_snapshot)
    },

    gpu_info = function() {
      ret <- dust_sirs_gpu_info()
      parent <- parent.env(environment())
      if (ret$has_cuda && exists("private", parent, inherits = FALSE)) {
        ret$config <- private$device_config_
      }
      ret
    }
  ))
class(sirs) <- c("dust_generator", class(sirs))
variable <- R6::R6Class(
  "dust",
  cloneable = FALSE,

  private = list(
    pars_ = NULL,
    pars_multi_ = NULL,
    index_ = NULL,
    info_ = NULL,
    n_threads_ = NULL,
    n_particles_ = NULL,
    n_particles_each_ = NULL,
    shape_ = NULL,
    ptr_ = NULL,
    device_config_ = NULL,
    methods_ = NULL,
    param_ = NULL
  ),

  public = list(
    initialize = function(pars, step, n_particles, n_threads = 1L,
                          seed = NULL, pars_multi = FALSE,
                          deterministic = FALSE,
                          device_config = NULL) {
      if (is.null(device_config)) {
        private$methods_ <- list(
           alloc = dust_cpu_variable_alloc,
           run = dust_cpu_variable_run,
           simulate = dust_cpu_variable_simulate,
           set_index = dust_cpu_variable_set_index,
           n_state = dust_cpu_variable_n_state,
           update_state = dust_cpu_variable_update_state,
           state = dust_cpu_variable_state,
           step = dust_cpu_variable_step,
           reorder = dust_cpu_variable_reorder,
           resample = dust_cpu_variable_resample,
           rng_state = dust_cpu_variable_rng_state,
           set_rng_state = dust_cpu_variable_set_rng_state,
           set_n_threads = dust_cpu_variable_set_n_threads,
           set_data = dust_cpu_variable_set_data,
           compare_data = dust_cpu_variable_compare_data,
           filter = dust_cpu_variable_filter)
      } else {
        private$methods_ <- list(
           alloc = dust_gpu_variable_alloc,
           run = dust_gpu_variable_run,
           simulate = dust_gpu_variable_simulate,
           set_index = dust_gpu_variable_set_index,
           n_state = dust_gpu_variable_n_state,
           update_state = dust_gpu_variable_update_state,
           state = dust_gpu_variable_state,
           step = dust_gpu_variable_step,
           reorder = dust_gpu_variable_reorder,
           resample = dust_gpu_variable_resample,
           rng_state = dust_gpu_variable_rng_state,
           set_rng_state = dust_gpu_variable_set_rng_state,
           set_n_threads = dust_gpu_variable_set_n_threads,
           set_data = dust_gpu_variable_set_data,
           compare_data = dust_gpu_variable_compare_data,
           filter = dust_gpu_variable_filter)
      }
      res <- private$methods_$alloc(pars, pars_multi, step, n_particles,
                        n_threads, seed, deterministic, device_config)
      private$pars_ <- pars
      private$pars_multi_ <- pars_multi
      private$n_threads_ <- n_threads
      private$ptr_ <- res[[1L]]
      private$info_ <- res[[2L]]
      private$shape_ <- res[[3L]]
      private$device_config_ <- res[[4L]]
      private$n_particles_ <- prod(private$shape_)
      if (pars_multi) {
        private$n_particles_each_ <- private$n_particles_ / length(pars)
      } else {
        private$n_particles_each_ <- private$n_particles_
      }
    },

    name = function() {
      "variable"
    },

    param = function() {
      private$param_
    },

    run = function(step_end) {
      m <- private$methods_$run(private$ptr_, step_end)
      rownames(m) <- names(private$index_)
      m
    },

    simulate = function(step_end) {
      m <- private$methods_$simulate(private$ptr_, step_end)
      rownames(m) <- names(private$index_)
      m
    },

    set_index = function(index) {
      private$methods_$set_index(private$ptr_, index)
      private$index_ <- index
      invisible()
    },

    index = function() {
      private$index_
    },

    n_threads = function() {
      private$n_threads_
    },

    n_state = function() {
      private$methods_$n_state(private$ptr_)
    },

    n_particles = function() {
      private$n_particles_
    },

    n_particles_each = function() {
      private$n_particles_each_
    },

    shape = function() {
      private$shape_
    },

    set_state = function(state, step = NULL) {
      if (is.null(step)) {
        .Deprecated("$update_state(state = state)",
                    old = "$set_state(state)")
      } else {
        .Deprecated("$update_state(state = state, step = step)",
                    old = "$set_state(state, step)")
      }
      self$update_state(state = state, step = step)
    },

    reset = function(pars, step) {
      .Deprecated("$update_state(pars = pars, step = step)",
                  old = "$reset(pars, step)")
      self$update_state(pars = pars, step = step)
    },

    set_pars = function(pars) {
      .Deprecated("$update_state(pars = pars)",
                  old = "$set_pars(pars)")
      self$update_state(pars = pars, set_initial_state = FALSE)
    },

    update_state = function(pars = NULL, state = NULL, step = NULL,
                            set_initial_state = NULL) {
      info <- private$methods_$update_state(private$ptr_, pars, state, step,
                                          set_initial_state)
      if (!is.null(pars)) {
        private$info_ <- info
        private$pars_ <- pars
      }
      invisible()
    },

    state = function(index = NULL) {
      m <- private$methods_$state(private$ptr_, index)
      rownames(m) <- names(index)
      m
    },

    step = function() {
      private$methods_$step(private$ptr_)
    },

    reorder = function(index) {
      storage.mode(index) <- "integer"
      private$methods_$reorder(private$ptr_, index)
      invisible()
    },

    resample = function(weights) {
      invisible(private$methods_$resample(private$ptr_, weights))
    },

    info = function() {
      private$info_
    },

    pars = function() {
      private$pars_
    },

    rng_state = function(first_only = FALSE, last_only = FALSE) {
      private$methods_$rng_state(private$ptr_, first_only, last_only)
    },

    set_rng_state = function(rng_state) {
      private$methods_$set_rng_state(private$ptr_, rng_state)
      invisible()
    },

    has_openmp = function() {
      dust_variable_capabilities()[["openmp"]]
    },

    has_cuda = function(fake_gpu = FALSE) {
      if (fake_gpu) {
        TRUE
      } else {
        dust_variable_capabilities()[["cuda"]]
      }
    },

    uses_gpu = function(fake_gpu = FALSE) {
      real_gpu <- private$device_config_$real_gpu
      !is.null(real_gpu) && (fake_gpu || real_gpu)
    },

    n_pars = function() {
      if (private$pars_multi_) length(private$pars_) else 0L
    },

    set_n_threads = function(n_threads) {
      prev <- private$n_threads_
      private$methods_$set_n_threads(private$ptr_, n_threads)
      private$n_threads_ <- n_threads
      invisible(prev)
    },

    has_compare = function() {
      dust_variable_capabilities()[["compare"]]
    },

    set_data = function(data) {
      private$methods_$set_data(private$ptr_, data)
    },

    compare_data = function() {
      private$methods_$compare_data(private$ptr_)
    },

    filter = function(save_trajectories = FALSE, step_snapshot = NULL) {
      private$methods_$filter(private$ptr_, save_trajectories, step_snapshot)
    },

    gpu_info = function() {
      ret <- dust_variable_gpu_info()
      parent <- parent.env(environment())
      if (ret$has_cuda && exists("private", parent, inherits = FALSE)) {
        ret$config <- private$device_config_
      }
      ret
    }
  ))
class(variable) <- c("dust_generator", class(variable))
volatility <- R6::R6Class(
  "dust",
  cloneable = FALSE,

  private = list(
    pars_ = NULL,
    pars_multi_ = NULL,
    index_ = NULL,
    info_ = NULL,
    n_threads_ = NULL,
    n_particles_ = NULL,
    n_particles_each_ = NULL,
    shape_ = NULL,
    ptr_ = NULL,
    device_config_ = NULL,
    methods_ = NULL,
    param_ = NULL
  ),

  public = list(
    initialize = function(pars, step, n_particles, n_threads = 1L,
                          seed = NULL, pars_multi = FALSE,
                          deterministic = FALSE,
                          device_config = NULL) {
      if (is.null(device_config)) {
        private$methods_ <- list(
           alloc = dust_cpu_volatility_alloc,
           run = dust_cpu_volatility_run,
           simulate = dust_cpu_volatility_simulate,
           set_index = dust_cpu_volatility_set_index,
           n_state = dust_cpu_volatility_n_state,
           update_state = dust_cpu_volatility_update_state,
           state = dust_cpu_volatility_state,
           step = dust_cpu_volatility_step,
           reorder = dust_cpu_volatility_reorder,
           resample = dust_cpu_volatility_resample,
           rng_state = dust_cpu_volatility_rng_state,
           set_rng_state = dust_cpu_volatility_set_rng_state,
           set_n_threads = dust_cpu_volatility_set_n_threads,
           set_data = dust_cpu_volatility_set_data,
           compare_data = dust_cpu_volatility_compare_data,
           filter = dust_cpu_volatility_filter)
      } else {
        private$methods_ <- list(alloc = function(...) {
          stop("GPU support not enabled for this object")
        })
      }
      res <- private$methods_$alloc(pars, pars_multi, step, n_particles,
                        n_threads, seed, deterministic, device_config)
      private$pars_ <- pars
      private$pars_multi_ <- pars_multi
      private$n_threads_ <- n_threads
      private$ptr_ <- res[[1L]]
      private$info_ <- res[[2L]]
      private$shape_ <- res[[3L]]
      private$device_config_ <- res[[4L]]
      private$n_particles_ <- prod(private$shape_)
      if (pars_multi) {
        private$n_particles_each_ <- private$n_particles_ / length(pars)
      } else {
        private$n_particles_each_ <- private$n_particles_
      }
    },

    name = function() {
      "volatility"
    },

    param = function() {
      private$param_
    },

    run = function(step_end) {
      m <- private$methods_$run(private$ptr_, step_end)
      rownames(m) <- names(private$index_)
      m
    },

    simulate = function(step_end) {
      m <- private$methods_$simulate(private$ptr_, step_end)
      rownames(m) <- names(private$index_)
      m
    },

    set_index = function(index) {
      private$methods_$set_index(private$ptr_, index)
      private$index_ <- index
      invisible()
    },

    index = function() {
      private$index_
    },

    n_threads = function() {
      private$n_threads_
    },

    n_state = function() {
      private$methods_$n_state(private$ptr_)
    },

    n_particles = function() {
      private$n_particles_
    },

    n_particles_each = function() {
      private$n_particles_each_
    },

    shape = function() {
      private$shape_
    },

    set_state = function(state, step = NULL) {
      if (is.null(step)) {
        .Deprecated("$update_state(state = state)",
                    old = "$set_state(state)")
      } else {
        .Deprecated("$update_state(state = state, step = step)",
                    old = "$set_state(state, step)")
      }
      self$update_state(state = state, step = step)
    },

    reset = function(pars, step) {
      .Deprecated("$update_state(pars = pars, step = step)",
                  old = "$reset(pars, step)")
      self$update_state(pars = pars, step = step)
    },

    set_pars = function(pars) {
      .Deprecated("$update_state(pars = pars)",
                  old = "$set_pars(pars)")
      self$update_state(pars = pars, set_initial_state = FALSE)
    },

    update_state = function(pars = NULL, state = NULL, step = NULL,
                            set_initial_state = NULL) {
      info <- private$methods_$update_state(private$ptr_, pars, state, step,
                                          set_initial_state)
      if (!is.null(pars)) {
        private$info_ <- info
        private$pars_ <- pars
      }
      invisible()
    },

    state = function(index = NULL) {
      m <- private$methods_$state(private$ptr_, index)
      rownames(m) <- names(index)
      m
    },

    step = function() {
      private$methods_$step(private$ptr_)
    },

    reorder = function(index) {
      storage.mode(index) <- "integer"
      private$methods_$reorder(private$ptr_, index)
      invisible()
    },

    resample = function(weights) {
      invisible(private$methods_$resample(private$ptr_, weights))
    },

    info = function() {
      private$info_
    },

    pars = function() {
      private$pars_
    },

    rng_state = function(first_only = FALSE, last_only = FALSE) {
      private$methods_$rng_state(private$ptr_, first_only, last_only)
    },

    set_rng_state = function(rng_state) {
      private$methods_$set_rng_state(private$ptr_, rng_state)
      invisible()
    },

    has_openmp = function() {
      dust_volatility_capabilities()[["openmp"]]
    },

    has_cuda = function(fake_gpu = FALSE) {
      if (fake_gpu) {
        FALSE
      } else {
        dust_volatility_capabilities()[["cuda"]]
      }
    },

    uses_gpu = function(fake_gpu = FALSE) {
      real_gpu <- private$device_config_$real_gpu
      !is.null(real_gpu) && (fake_gpu || real_gpu)
    },

    n_pars = function() {
      if (private$pars_multi_) length(private$pars_) else 0L
    },

    set_n_threads = function(n_threads) {
      prev <- private$n_threads_
      private$methods_$set_n_threads(private$ptr_, n_threads)
      private$n_threads_ <- n_threads
      invisible(prev)
    },

    has_compare = function() {
      dust_volatility_capabilities()[["compare"]]
    },

    set_data = function(data) {
      private$methods_$set_data(private$ptr_, data)
    },

    compare_data = function() {
      private$methods_$compare_data(private$ptr_)
    },

    filter = function(save_trajectories = FALSE, step_snapshot = NULL) {
      private$methods_$filter(private$ptr_, save_trajectories, step_snapshot)
    },

    gpu_info = function() {
      ret <- dust_volatility_gpu_info()
      parent <- parent.env(environment())
      if (ret$has_cuda && exists("private", parent, inherits = FALSE)) {
        ret$config <- private$device_config_
      }
      ret
    }
  ))
class(volatility) <- c("dust_generator", class(volatility))
walk <- R6::R6Class(
  "dust",
  cloneable = FALSE,

  private = list(
    pars_ = NULL,
    pars_multi_ = NULL,
    index_ = NULL,
    info_ = NULL,
    n_threads_ = NULL,
    n_particles_ = NULL,
    n_particles_each_ = NULL,
    shape_ = NULL,
    ptr_ = NULL,
    device_config_ = NULL,
    methods_ = NULL,
    param_ = NULL
  ),

  public = list(
    initialize = function(pars, step, n_particles, n_threads = 1L,
                          seed = NULL, pars_multi = FALSE,
                          deterministic = FALSE,
                          device_config = NULL) {
      if (is.null(device_config)) {
        private$methods_ <- list(
           alloc = dust_cpu_walk_alloc,
           run = dust_cpu_walk_run,
           simulate = dust_cpu_walk_simulate,
           set_index = dust_cpu_walk_set_index,
           n_state = dust_cpu_walk_n_state,
           update_state = dust_cpu_walk_update_state,
           state = dust_cpu_walk_state,
           step = dust_cpu_walk_step,
           reorder = dust_cpu_walk_reorder,
           resample = dust_cpu_walk_resample,
           rng_state = dust_cpu_walk_rng_state,
           set_rng_state = dust_cpu_walk_set_rng_state,
           set_n_threads = dust_cpu_walk_set_n_threads,
           set_data = dust_cpu_walk_set_data,
           compare_data = dust_cpu_walk_compare_data,
           filter = dust_cpu_walk_filter)
      } else {
        private$methods_ <- list(alloc = function(...) {
          stop("GPU support not enabled for this object")
        })
      }
      res <- private$methods_$alloc(pars, pars_multi, step, n_particles,
                        n_threads, seed, deterministic, device_config)
      private$pars_ <- pars
      private$pars_multi_ <- pars_multi
      private$n_threads_ <- n_threads
      private$ptr_ <- res[[1L]]
      private$info_ <- res[[2L]]
      private$shape_ <- res[[3L]]
      private$device_config_ <- res[[4L]]
      private$n_particles_ <- prod(private$shape_)
      if (pars_multi) {
        private$n_particles_each_ <- private$n_particles_ / length(pars)
      } else {
        private$n_particles_each_ <- private$n_particles_
      }
    },

    name = function() {
      "walk"
    },

    param = function() {
      private$param_
    },

    run = function(step_end) {
      m <- private$methods_$run(private$ptr_, step_end)
      rownames(m) <- names(private$index_)
      m
    },

    simulate = function(step_end) {
      m <- private$methods_$simulate(private$ptr_, step_end)
      rownames(m) <- names(private$index_)
      m
    },

    set_index = function(index) {
      private$methods_$set_index(private$ptr_, index)
      private$index_ <- index
      invisible()
    },

    index = function() {
      private$index_
    },

    n_threads = function() {
      private$n_threads_
    },

    n_state = function() {
      private$methods_$n_state(private$ptr_)
    },

    n_particles = function() {
      private$n_particles_
    },

    n_particles_each = function() {
      private$n_particles_each_
    },

    shape = function() {
      private$shape_
    },

    set_state = function(state, step = NULL) {
      if (is.null(step)) {
        .Deprecated("$update_state(state = state)",
                    old = "$set_state(state)")
      } else {
        .Deprecated("$update_state(state = state, step = step)",
                    old = "$set_state(state, step)")
      }
      self$update_state(state = state, step = step)
    },

    reset = function(pars, step) {
      .Deprecated("$update_state(pars = pars, step = step)",
                  old = "$reset(pars, step)")
      self$update_state(pars = pars, step = step)
    },

    set_pars = function(pars) {
      .Deprecated("$update_state(pars = pars)",
                  old = "$set_pars(pars)")
      self$update_state(pars = pars, set_initial_state = FALSE)
    },

    update_state = function(pars = NULL, state = NULL, step = NULL,
                            set_initial_state = NULL) {
      info <- private$methods_$update_state(private$ptr_, pars, state, step,
                                          set_initial_state)
      if (!is.null(pars)) {
        private$info_ <- info
        private$pars_ <- pars
      }
      invisible()
    },

    state = function(index = NULL) {
      m <- private$methods_$state(private$ptr_, index)
      rownames(m) <- names(index)
      m
    },

    step = function() {
      private$methods_$step(private$ptr_)
    },

    reorder = function(index) {
      storage.mode(index) <- "integer"
      private$methods_$reorder(private$ptr_, index)
      invisible()
    },

    resample = function(weights) {
      invisible(private$methods_$resample(private$ptr_, weights))
    },

    info = function() {
      private$info_
    },

    pars = function() {
      private$pars_
    },

    rng_state = function(first_only = FALSE, last_only = FALSE) {
      private$methods_$rng_state(private$ptr_, first_only, last_only)
    },

    set_rng_state = function(rng_state) {
      private$methods_$set_rng_state(private$ptr_, rng_state)
      invisible()
    },

    has_openmp = function() {
      dust_walk_capabilities()[["openmp"]]
    },

    has_cuda = function(fake_gpu = FALSE) {
      if (fake_gpu) {
        FALSE
      } else {
        dust_walk_capabilities()[["cuda"]]
      }
    },

    uses_gpu = function(fake_gpu = FALSE) {
      real_gpu <- private$device_config_$real_gpu
      !is.null(real_gpu) && (fake_gpu || real_gpu)
    },

    n_pars = function() {
      if (private$pars_multi_) length(private$pars_) else 0L
    },

    set_n_threads = function(n_threads) {
      prev <- private$n_threads_
      private$methods_$set_n_threads(private$ptr_, n_threads)
      private$n_threads_ <- n_threads
      invisible(prev)
    },

    has_compare = function() {
      dust_walk_capabilities()[["compare"]]
    },

    set_data = function(data) {
      private$methods_$set_data(private$ptr_, data)
    },

    compare_data = function() {
      private$methods_$compare_data(private$ptr_)
    },

    filter = function(save_trajectories = FALSE, step_snapshot = NULL) {
      private$methods_$filter(private$ptr_, save_trajectories, step_snapshot)
    },

    gpu_info = function() {
      ret <- dust_walk_gpu_info()
      parent <- parent.env(environment())
      if (ret$has_cuda && exists("private", parent, inherits = FALSE)) {
        ret$config <- private$device_config_
      }
      ret
    }
  ))
class(walk) <- c("dust_generator", class(walk))
